<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreMind | Akıl & Yaratım Platformu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <!-- Genişletilmiş Font Ailesi -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&family=Bebas+Neue&family=Syncopate:wght@400;700&family=Audiowide&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Orbitron', 'sans-serif'],
                        tech: ['Audiowide', 'cursive'],
                        condensed: ['Bebas Neue', 'sans-serif'],
                        sync: ['Syncopate', 'sans-serif']
                    },
                    colors: {
                        brand: {
                            dark: '#0a0a0b',
                            panel: '#13131f',
                            accent: '#7c3aed',
                            neon: '#c084ff',
                            glow: '#c084ff',
                            danger: '#dc2626',
                            acid: '#a78bfa',
                            gray: '#374151',
                            grayLight: '#6b7280'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0a0a0b; color: #9ca3af; }
        /* Responsive: tüm ekranlar */
        @media (max-width: 639px) { .container { padding-left: 1rem; padding-right: 1rem; } }
        @media (min-width: 640px) { .container { padding-left: 1.5rem; padding-right: 1.5rem; } }
        @media (min-width: 1024px) { .container { padding-left: 2rem; padding-right: 2rem; } }
        /* Nav: mor–kırmızı çizgi, mor/kırmızı/gri butonlar */
        nav { position: relative; box-shadow: 0 0 20px rgba(124, 58, 237, 0.2); }
        nav::after { content: ''; position: absolute; left: 0; right: 0; bottom: 0; height: 2px; background: linear-gradient(90deg, transparent, #7c3aed, #dc2626, #374151, #7c3aed, transparent); opacity: 0.9; box-shadow: 0 0 12px rgba(192, 132, 252, 0.5), 0 0 24px rgba(124, 58, 237, 0.4); }
        /* Nav overflow rules: küçük/orta ekranda yatay scroll, büyükte wrap */
        .nav-links-wrap { display: flex; gap: 0.5rem; align-items: center; justify-content: flex-end; min-width: 0; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; padding-right: 4px; }
        .nav-links-wrap::-webkit-scrollbar { display: none; }
        @media (min-width: 1024px) { .nav-links-wrap { flex-wrap: wrap; overflow-x: visible; padding-right: 0; } }
        .nav-link, .nav-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.4rem 0.75rem; border-radius: 8px; font-size: 0.8125rem; font-weight: 600; transition: all 0.2s ease; border: 1px solid transparent; white-space: nowrap; cursor: pointer; background: rgba(31,41,55,0.6); color: #9ca3af; }
        .nav-btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .nav-btn-panel { color: #c084ff; border-color: #c084ff; box-shadow: 0 0 10px rgba(192, 132, 252, 0.4); }
        .nav-btn-panel:hover { box-shadow: 0 0 16px rgba(192, 132, 252, 0.6); }
        .nav-btn-listings { color: #a78bfa; border-color: #a78bfa; box-shadow: 0 0 10px rgba(167, 139, 250, 0.4); }
        .nav-btn-listings:hover { box-shadow: 0 0 16px rgba(167, 139, 250, 0.6); }
        .nav-btn-logo { color: #c084ff; border-color: #c084ff; box-shadow: 0 0 10px rgba(192, 132, 252, 0.5); }
        .nav-btn-logo:hover { box-shadow: 0 0 18px rgba(192, 132, 252, 0.7); }
        .nav-btn-set { color: #a78bfa; border-color: #a78bfa; box-shadow: 0 0 10px rgba(167, 139, 250, 0.4); }
        .nav-btn-set:hover { box-shadow: 0 0 16px rgba(167, 139, 250, 0.6); }
        .nav-btn-create { color: #f472b6; border-color: #f472b6; box-shadow: 0 0 10px rgba(244, 114, 182, 0.4); }
        .nav-btn-create:hover { box-shadow: 0 0 16px rgba(244, 114, 182, 0.6); }
        .nav-btn-match { color: #f472b6; border-color: #f472b6; box-shadow: 0 0 10px rgba(244, 114, 182, 0.4); }
        .nav-btn-match:hover { box-shadow: 0 0 16px rgba(244, 114, 182, 0.6); }
        .nav-btn-connections { color: #9ca3af; border-color: #6b7280; box-shadow: 0 0 8px rgba(107, 114, 128, 0.3); }
        .nav-btn-connections:hover { box-shadow: 0 0 12px rgba(156, 163, 175, 0.4); }
        .nav-btn-reviews { color: #c084fc; border-color: #c084fc; box-shadow: 0 0 10px rgba(192, 132, 252, 0.4); }
        .nav-btn-reviews:hover { box-shadow: 0 0 16px rgba(192, 132, 252, 0.6); }
        .nav-btn-moderation { color: #dc2626; border-color: #dc2626; box-shadow: 0 0 10px rgba(220, 38, 38, 0.4); }
        .nav-btn-moderation:hover { box-shadow: 0 0 16px rgba(220, 38, 38, 0.5); }
        .nav-btn-settings { color: #9ca3af; border-color: #6b7280; box-shadow: 0 0 8px rgba(107, 114, 128, 0.3); }
        .nav-btn-settings:hover { box-shadow: 0 0 12px rgba(156, 163, 175, 0.4); }
        .nav-btn-logout { color: #dc2626; border-color: #dc2626; box-shadow: 0 0 10px rgba(220, 38, 38, 0.4); }
        .nav-btn-logout:hover { box-shadow: 0 0 16px rgba(220, 38, 38, 0.5); }
        .nav-role-badge { padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(107,114,128,0.5); color: #9ca3af; }
        @media (max-width: 767px) { .nav-links-wrap { gap: 0.35rem; } .nav-link, .nav-btn { font-size: 0.7rem; padding: 0.3rem 0.5rem; } }
        .page-content { padding: 1rem; }
        @media (min-width: 640px) { .page-content { padding: 1.5rem; } }
        @media (min-width: 1024px) { .page-content { padding: 2rem; } }

        /* Layout System v1: AppShell / PageShell / ContentGrid */
        .app-shell { min-height: 100dvh; display: flex; flex-direction: column; }
        .top-nav { position: sticky; top: 0; z-index: 60; flex: none; }
        .page-shell { width: 100%; max-width: 1200px; margin: 0 auto; padding: clamp(12px, 2vw, 24px); box-sizing: border-box; }
        @supports (padding: env(safe-area-inset-left)) { .page-shell { padding-left: max(12px, env(safe-area-inset-left)); padding-right: max(12px, env(safe-area-inset-right)); padding-top: max(12px, env(safe-area-inset-top)); padding-bottom: max(16px, env(safe-area-inset-bottom)); } }
        .content-grid { display: grid; gap: 14px; justify-items: stretch; grid-template-columns: 1fr; }
        @media (min-width: 640px) { .content-grid { gap: 14px; grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .content-grid { gap: 16px; grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 1280px) { .content-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        .dashboard-grid { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); justify-content: center; max-width: 1200px; margin: 0 auto; }
        .dashboard-card { min-height: 96px; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; border-radius: 14px; width: 100%; box-sizing: border-box; text-align: left; cursor: pointer; transition: all 0.2s ease; border: 1px solid rgba(31,41,55,1); background: rgba(17,24,39,0.5); }
        .dashboard-card:hover { border-color: rgba(192,132,252,0.5); }
        @media (max-width: 639px) { .dashboard-card { min-height: 96px; } }
        .logo-studio-wrap { flex-direction: column; }
        @media (min-width: 1024px) { .logo-studio-wrap { flex-direction: row; } }
        .logo-studio-sidebar { width: 100%; max-height: 45vh; }
        @media (min-width: 1024px) { .logo-studio-sidebar { width: 24rem; max-height: none; } }
        .logo-studio-canvas-wrap { min-height: 50vh; }
        @media (min-width: 1024px) { .logo-studio-canvas-wrap { min-height: auto; } }
        .glass-panel { background: rgba(19, 19, 31, 0.92); backdrop-filter: blur(12px); border: 1px solid rgba(107,114,128,0.25); }
        /* CoreMind Background v1: gradient + watermark + parallax */
        #cm-bg { position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden; }
        #cm-bg::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(124,58,237,0.08) 0%, transparent 50%), radial-gradient(ellipse 60% 80% at 80% 80%, rgba(192,132,252,0.04) 0%, transparent 50%), linear-gradient(180deg, #0a0a0b 0%, #0f0a14 40%, #0a0a0b 100%); opacity: 0.95; }
        #cm-bg::after { content: ''; position: absolute; inset: 0; background-image: var(--coremind-watermark-url, url("./assets/coremind-logo.webp")); background-repeat: no-repeat; background-position: center; background-size: min(720px, 70vw); opacity: 0.08; mix-blend-mode: screen; filter: blur(0.3px); transform: translate3d(calc(var(--cm-mx, 0) * 18px), calc(var(--cm-my, 0) * 18px), 0) rotateX(calc(var(--cm-my, 0) * -6deg)) rotateY(calc(var(--cm-mx, 0) * 6deg)); transition: transform 0.1s ease-out; }
        @media (prefers-reduced-motion: reduce) { #cm-bg::after { transform: none; transition: none; } }
        .coremind-nav-icon { width: 28px; height: 28px; object-fit: contain; filter: drop-shadow(0 0 8px rgba(192,132,252,0.5)); transition: transform 0.2s ease, filter 0.2s ease; }
        @media (max-width: 639px) { .coremind-nav-icon { width: 22px; height: 22px; } }
        .coremind-brand-wrap:hover .coremind-nav-icon { transform: scale(1.05) rotate(-2deg); filter: drop-shadow(0 0 12px rgba(192,132,252,0.7)); }
        .control-group { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .control-header { cursor: pointer; user-select: none; }
        .control-header:hover { background: rgba(255,255,255,0.05); }
        
        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #fff; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
        }
        
        /* Sol panel scrollbar - her zaman görünür, tüm tarayıcılar */
        .sidebar-scroll {
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #555 #1a1a2e;
        }
        .sidebar-scroll::-webkit-scrollbar { width: 10px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: #1a1a2e; border-radius: 5px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; border: 2px solid #1a1a2e; }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #7c3aed; }
        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1a1a2e; border-radius: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #7c3aed; }

        canvas { background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAADFJREFUOE9jZGBgEGHADxjZ2Nj+Y+KDAaVBE8YAJQaMmgFjBoBgMBo8GgwGgwGjBoB4AAAQIgf5w2XOnwAAAABJRU5ErkJggg=='); }

        /* Listing cards: mor / kırmızı / gri tonları */
        .listing-strip { width: 6px; flex-shrink: 0; border-radius: 4px 0 0 4px; }
        .listing-strip-dj { background: #c084ff; }
        .listing-strip-venue { background: #7c3aed; }
        .listing-strip-organizer { background: #dc2626; }
        .listing-strip-decorator { background: #6b7280; }
        .listing-badge { letter-spacing: 0.05em; }
        .listing-badge-dj { background: rgba(192, 132, 252, 0.25); color: #c084ff; }
        .listing-badge-venue { background: rgba(124, 58, 237, 0.25); color: #a78bfa; }
        .listing-badge-organizer { background: rgba(220, 38, 38, 0.25); color: #f87171; }
        .listing-badge-decorator { background: rgba(107, 114, 128, 0.35); color: #9ca3af; }
        .listing-meta-item { display: inline-flex; align-items: center; }
        .listing-card:focus-within { outline: 2px solid rgba(192, 132, 252, 0.5); outline-offset: 2px; }
        /* Sol mini avatar (40–48px) */
        .listing-card-avatar { flex-shrink: 0; width: 48px; height: 48px; min-width: 48px; min-height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 10px; overflow: hidden; background: rgba(255,255,255,0.06); }
        .listing-card-avatar img { display: block; width: 100%; height: 100%; object-fit: contain; }
        .listing-card-avatar-initial { font-size: 1.25rem; font-weight: 700; color: #94a3b8; }
        /* Sağ büyük logo alanı: referans görsele göre daha büyük, logo alanı doldurur */
        .listing-logo-preview-slot { flex-shrink: 0; display: flex; align-items: center; justify-content: center; width: clamp(300px, 36vw, 520px); height: clamp(140px, 20vh, 220px); min-height: 140px; background: rgba(31,41,55,0.5); border: 1px solid rgba(107,114,128,0.3); border-radius: 12px; overflow: hidden; }
        .listing-logo-preview-slot img { display: block; width: 100%; height: 100%; object-fit: contain; object-position: center; padding: 4px; box-sizing: border-box; background: transparent; filter: none; }
        .listing-logo-fallback { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; width: 100%; height: 100%; background: rgba(31,41,55,0.6); border-radius: 10px; color: #6b7280; }
        .listing-logo-fallback-initial { font-size: 2rem; font-weight: 700; color: #9ca3af; }
        .listing-logo-fallback-hint { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; }
        @media (max-width: 767px) { .listing-card { flex-wrap: wrap; } .listing-card-right { width: 100%; flex-direction: row; flex-wrap: wrap; justify-content: flex-end; gap: 0.75rem; } .listing-logo-preview-slot { width: 100%; min-width: 0; min-height: 130px; flex: 1; min-width: 200px; } }
        .listing-filter-btn { min-height: 2.25rem; }
        @media (max-width: 639px) { input#filterCity, input#filterGenre, input#filterBpmMin, input#filterBpmMax, input#filterBudgetMin, input#filterBudgetMax { min-width: 0; width: 100%; max-width: 8rem; } }
        /* Profil fotoğrafı: ekran boyutuna uyumlu, kaydedilen foto her yerde doğru oran */
        .profile-avatar { width: clamp(72px, 18vw, 120px); height: clamp(72px, 18vw, 120px); min-width: 72px; min-height: 72px; border-radius: 0.75rem; overflow: hidden; flex-shrink: 0; background: rgba(31,41,55,1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(107,114,128,0.4); }
        .profile-avatar img { display: block; width: 100%; height: 100%; object-fit: cover; object-position: center; }
        .profile-avatar-edit { width: clamp(80px, 22vw, 96px); height: clamp(80px, 22vw, 96px); min-width: 80px; min-height: 80px; border-radius: 0.75rem; overflow: hidden; flex-shrink: 0; background: rgba(31,41,55,1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(107,114,128,0.4); }
        .profile-avatar-edit img { display: block; width: 100%; height: 100%; object-fit: cover; object-position: center; }
        .profile-edit-card { background: rgba(17,24,39,0.6); border: 1px solid rgba(107,114,128,0.4); border-radius: 1rem; overflow: hidden; }
        .profile-edit-card .avatar-wrap { width: 100%; aspect-ratio: 1; max-width: 240px; margin: 0 auto; background: rgba(31,41,55,1); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid rgba(107,114,128,0.3); }
        .profile-edit-card .avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .profile-edit-card .avatar-wrap span { font-size: 4rem; font-weight: bold; color: #6b7280; }
        .profile-edit-card .info-table { width: 100%; border-collapse: collapse; }
        .profile-edit-card .info-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid rgba(107,114,128,0.25); font-size: 0.875rem; }
        .profile-edit-card .info-table td:first-child { color: #9ca3af; width: 40%; }
        .profile-edit-card .info-table tr:last-child td { border-bottom: none; }
        .profile-avatar-img { display: block; width: 100%; height: 100%; object-fit: cover; object-position: center; }
        /* Safe area: çentikli ekranlar */
        @supports (padding: env(safe-area-inset-top)) { body { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); } nav { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); } }
    </style>
</head>
<body class="app-shell h-screen flex flex-col font-sans overflow-hidden">
    <!-- CoreMind Background v1: 3 katman (gradient+noise, watermark, parallax) -->
    <div id="cm-bg" aria-hidden="true"></div>

    <!-- NAVIGATION -->
    <nav class="top-nav border-b border-gray-800 bg-brand-dark/95 min-h-14 h-14 sm:h-16 safe-area-inset-top">
        <div class="container mx-auto px-3 sm:px-4 h-full flex justify-between items-center gap-2 min-w-0">
            <div class="coremind-brand-wrap flex items-center gap-1.5 sm:gap-2 cursor-pointer min-w-0 shrink" onclick="app.currentUser ? app.router('dashboard') : app.router('home')">
                <img src="./assets/coremind-logo.webp" alt="CoreMind" class="coremind-nav-icon flex-shrink-0" onerror="this.style.display='none'; var s=this.nextElementSibling; if(s) s.classList.remove('hidden');">
                <span class="hidden flex-shrink-0" aria-hidden="true"><i class="fa-solid fa-brain text-xl sm:text-2xl text-[#c084ff]" style="text-shadow: 0 0 12px rgba(192,132,252,0.8);"></i></span>
                <div class="flex flex-col min-w-0">
                    <h1 class="text-base sm:text-xl font-display font-bold tracking-wider truncate text-white leading-tight">CoreMind</h1>
                    <span class="text-[10px] sm:text-xs font-sans text-[#c084ff] leading-tight" style="text-shadow: 0 0 10px rgba(192,132,252,0.9);">Akıl · Yaratım</span>
                </div>
            </div>
            <div id="navLinks" class="nav-links-wrap flex-shrink-0 min-w-0"></div>
        </div>
    </nav>

    <!-- Prod: Supabase baglanti hatasinda fallback yok, banner gosterilir -->
    <div id="offlineBanner" class="hidden border-b border-amber-800 bg-amber-950/90 px-4 py-2 flex items-center justify-center gap-3 text-amber-200 text-sm">
        <span>Sunucu bağlantısı kurulamadı. Veriler güncel değil.</span>
        <button type="button" onclick="window.location.reload()" class="px-3 py-1 rounded bg-amber-700 hover:bg-amber-600 text-white font-medium">Yenile</button>
    </div>

    <!-- MAIN APP: anasayfa doğrudan gösterilir, JS ile güncellenir -->
    <main id="appRoot" class="flex-1 flex flex-col overflow-hidden min-h-0 min-h-[50vh]">
        <div class="h-full flex items-center justify-center bg-gradient-to-b from-[#0a0a0b] via-[#1a0a1a] to-[#0a0a0b] bg-cover bg-center p-4 sm:p-6">
            <div class="glass-panel p-6 sm:p-8 rounded-2xl w-full max-w-md backdrop-blur-xl text-center border border-gray-800">
                <h2 class="text-3xl font-display font-bold mb-1 text-white">CoreMind</h2>
                <p class="text-sm mb-4 text-[#c084ff]" style="text-shadow: 0 0 14px rgba(192,132,252,0.9);">Akıl · Yaratım</p>
                <p class="text-gray-500 text-xs mb-2">DJ · Mekan · Organizatör Eşleşme Platformu</p>
                <p class="text-gray-600 text-xs mb-6">Platforma erişim için üye olun veya giriş yapın.</p>
                <button onclick="app.router('login')" class="w-full bg-brand-accent hover:bg-violet-600 text-white font-bold py-3 rounded transition mb-3">GİRİŞ YAP</button>
                <button onclick="app.router('register')" class="w-full border border-gray-600 text-gray-400 py-3 rounded hover:bg-gray-800/80 transition">ÜYE OL</button>
                <p class="text-xs text-gray-600 mt-4">DJ, Mekan sahibi veya Organizatör olarak üye olabilirsiniz.</p>
            </div>
        </div>
    </main>

    <!-- Harita modal (ilanlar haritada gör) -->
    <div id="mapModal" class="fixed inset-0 z-[100] bg-black/75 hidden flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-4xl h-[80vh] rounded-xl border border-brand-accent relative flex flex-col">
            <button type="button" onclick="app.toggleMapMode()" class="absolute top-4 right-4 z-10 bg-gray-900 text-white p-2 rounded-full hover:bg-gray-700">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div id="leafletMap" class="w-full flex-1 rounded-b-xl min-h-[300px]"></div>
        </div>
    </div>

    <!-- Profil düzenle: kaydedilmemiş değişiklik onayı -->
    <div id="profileUnsavedModal" class="fixed inset-0 z-[110] bg-black/75 hidden flex items-center justify-center p-4" aria-modal="true" role="dialog" aria-labelledby="profileUnsavedTitle">
        <div class="bg-gray-800 rounded-xl border border-gray-600 p-6 max-w-sm w-full shadow-xl">
            <h3 id="profileUnsavedTitle" class="font-bold text-white mb-2">Kaydedilmemiş değişiklikler</h3>
            <p class="text-gray-400 text-sm mb-4">Çıkmak istiyor musunuz?</p>
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="ProfileEditUI.cancelLeave()" class="px-4 py-2 rounded border border-gray-600 text-gray-300 hover:bg-gray-700">Vazgeç</button>
                <button type="button" onclick="ProfileEditUI.confirmLeave()" class="px-4 py-2 rounded bg-brand-accent text-white font-bold">Çık</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="appToast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[120] px-4 py-2 rounded-lg bg-gray-800 border border-gray-600 text-white text-sm shadow-lg hidden" role="status" aria-live="polite"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- JS ENGINE -->
    <script>
        // ── GLOBAL SAFETY: app'i erken tanımla (TDZ/inline onclick koruması) ──
        // Asıl app objesi aşağıda "APP CONTROLLER" bölümünde üzerine yazılır.
        // Bu satır sadece script yüklenirken erken referansların patlamasını engeller.
        var app = window.app = window.app || {};

        // Asset Strategy B: tek dosya dağıtım için base64 logo (boş bırakılırsa ./assets/coremind-logo.webp kullanılır)
        const COREMIND_LOGO_URL = '';

        // --- SUPABASE CONFIG (runtime) ---
        // Key'ler artık dosyada hardcoded DEĞİL.
        // Prod: /api/public-config endpoint'inden yüklenir (Vercel Env Variables).
        // Local dev: .env.local dosyasından veya doğrudan fallback değerlerden okunur.
        let SUPABASE_URL = '';
        let SUPABASE_ANON_KEY = '';
        let USE_SUPABASE = false;
        const ALLOW_LOCAL_FALLBACK = (typeof location !== 'undefined' && (location.hostname === 'localhost' || location.hostname === '127.0.0.1'));

        /**
         * Runtime config yükleyici.
         * 1) /api/public-config dener (Vercel prod/preview).
         * 2) Başarısızsa ve localhost ise, .env.local'deki fallback kullanılır.
         */
        async function __loadRuntimeConfig() {
            try {
                const r = await fetch('/api/public-config', { cache: 'no-store' });
                if (r.ok) {
                    const cfg = await r.json();
                    SUPABASE_URL = cfg.SUPABASE_URL || '';
                    SUPABASE_ANON_KEY = cfg.SUPABASE_ANON_KEY || '';
                }
            } catch (_) {
                // /api/ yoksa (local file:// veya static server) sessizce geç.
                console.warn('[Config] /api/public-config ulaşılamadı, local fallback kontrol ediliyor.');
            }
            USE_SUPABASE = !!(SUPABASE_URL && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.length > 50);
        }

        let supabase = null;
        const __cache = {};
        function getCache(key, def) { return __cache[key] !== undefined ? __cache[key] : (def !== undefined ? def : []); }
        function setCache(key, val) { __cache[key] = val; }

        // --- SUPABASE MODEL MAPPING (tek katman: DB row <-> UI model) ---
        const SupabaseModelMap = {
            mapListingRowToModel: (r) => ({ id: r.id, createdByUserId: r.owner_id, ownerRole: r.owner_role, listingType: r.listing_type, title: r.title || '', city: r.city || '', genres: r.genres || [], bpmTargetMin: r.bpm_target_min, bpmTargetMax: r.bpm_target_max, hours: r.hours, date: r.date, budget: r.budget, notes: r.notes || '', visibility: r.visibility || 'public', status: r.status || 'active', createdAt: r.created_at ? new Date(r.created_at).getTime() : Date.now(), ...(r.extra || {}) }),
            mapListingModelToInsert: (o) => {
                const { id, createdAt, createdByUserId, ownerRole, listingType, title, city, genres, bpmTargetMin, bpmTargetMax, hours, date, budget, notes, visibility, status, ...rest } = o;
                return { owner_id: createdByUserId, owner_role: ownerRole || '', listing_type: listingType, title: title || '', city: city || '', genres: genres || [], bpm_target_min: bpmTargetMin, bpm_target_max: bpmTargetMax, hours: hours, date: date || null, budget: budget != null ? parseFloat(budget) : null, notes: notes || '', visibility: visibility || 'public', status: status || 'active', extra: rest && Object.keys(rest).length ? rest : {} };
            },
            mapMessageRowToModel: (m) => ({ id: m.id, threadId: m.thread_id, senderId: m.sender_id, text: m.text, createdAt: m.created_at ? new Date(m.created_at).getTime() : 0, readBy: [] }),
            mapMessageModelToInsert: (m) => ({ thread_id: m.threadId, sender_id: m.senderId, text: m.text }),
            mapApplicationRowToModel: (a) => ({ id: a.id, listingId: a.listing_id, userId: a.applicant_id, status: a.status, createdAt: a.created_at ? new Date(a.created_at).getTime() : 0 }),
            mapApplicationModelToInsert: (a) => ({ listing_id: a.listingId, applicant_id: a.userId, status: a.status || 'pending' })
        };

        // --- SUPABASE ERROR SURFACING ---
        function showSupabaseError(err, context) {
            if (!err) return;
            console.error('[Supabase]', context || 'Error', err);
            const msg = (err && err.message) ? String(err.message) : '';
            let userMsg = 'Bir hata oluştu.';
            if (/invalid api key|JWT|anon|eyJ/i.test(msg)) userMsg = 'Anon key hatalı veya geçersiz. Project Settings > API > anon public (JWT) kontrol edin.';
            else if (/Invalid URL|fetch|network/i.test(msg)) userMsg = 'Proje URL hatalı veya ağ hatası. SUPABASE_URL kontrol edin.';
            else if (/row level security|RLS|policy|permission denied/i.test(msg)) userMsg = 'RLS engelledi: Bu işlem için yetkiniz yok.';
            else if (msg.length < 120) userMsg = msg;
            if (typeof showToast === 'function') showToast(userMsg);
            else alert(userMsg);
        }

        // --- DATA STORE (Supabase varsa cache; prod offline ise fallback yok) ---
        const Store = {
            get: (key) => (supabase ? getCache(key, []) : (app._supabaseOffline ? getCache(key, []) : JSON.parse(localStorage.getItem(key) || '[]'))),
            set: (key, val) => {
                if (app._supabaseOffline) return;
                if (supabase) { setCache(key, val); }
                else { localStorage.setItem(key, JSON.stringify(val)); }
            },
            getObj: (key) => (supabase ? (__cache[key + '_obj'] !== undefined ? __cache[key + '_obj'] : null) : (app._supabaseOffline ? null : JSON.parse(localStorage.getItem(key) || 'null'))),
            setObj: (key, val) => {
                if (app._supabaseOffline) return;
                if (supabase) { __cache[key + '_obj'] = val; }
                else { localStorage.setItem(key, JSON.stringify(val)); }
            },
            getCurrentUser: () => (supabase ? __cache.currentUser : JSON.parse(localStorage.getItem('currentUser'))),
            setCurrentUser: (user) => {
                if (supabase) { __cache.currentUser = user; }
                else { localStorage.setItem('currentUser', JSON.stringify(user)); }
            },
            logout: () => {
                if (supabase) { __cache.currentUser = null; }
                else { localStorage.removeItem('currentUser'); }
            }
        };

        // --- SUPABASE DATA SERVICE ---
        const SupabaseDataService = {
            rowToListing: (r) => SupabaseModelMap.mapListingRowToModel(r),
            listingToRow: (o) => SupabaseModelMap.mapListingModelToInsert(o),
            loadListings: async () => {
                if (!supabase) return;
                const { data, error } = await supabase.from('listings').select('*').order('created_at', { ascending: false });
                if (error) { showSupabaseError(error, 'loadListings'); return; }
                setCache('listings', (data || []).map(SupabaseModelMap.mapListingRowToModel));
            },
            loadProfilesAndUsers: async () => {
                if (!supabase) return;
                const [pRes, djRes, vRes, oRes, dRes, cRes] = await Promise.all([
                    supabase.from('profiles').select('*'),
                    supabase.from('dj_profiles').select('*'),
                    supabase.from('venue_profiles').select('*'),
                    supabase.from('organizer_profiles').select('*'),
                    supabase.from('decorator_profiles').select('*'),
                    supabase.from('common_profiles').select('*')
                ]);
                const profiles = (pRes.data || []).map(r => ({ id: r.user_id, type: r.role, name: r.display_name, email: '', city: r.city || '', xp: r.xp || 0, level: r.level || 1, badges: r.badges || [] }));
                setCache('users', profiles);
                const djApp = (r) => ({ userId: r.user_id, genres: r.genres || [], bpmMin: r.bpm_min, bpmMax: r.bpm_max, nightlyFee: r.nightly_fee, bio: r.bio || '', logoDataUrl: r.logo_data_url, googleDriveLink: r.google_drive_link, techRider: r.tech_rider || '', equipmentProvided: r.equipment_provided || [], soundcloudEmbed: r.soundcloud_embed, spotifyEmbed: r.spotify_embed, mixcloudEmbed: r.mixcloud_embed, minNoticeDays: r.min_notice_days, travelRadiusKm: r.travel_radius_km, profilePhotoDataUrl: r.profile_photo_data_url, instagram: r.instagram, tiktok: r.tiktok, x: r.x, facebook: r.facebook, whatsapp: r.whatsapp, telegram: r.telegram, soundcloud: r.soundcloud, bandcamp: r.bandcamp });
                const vApp = (r) => ({ userId: r.user_id, venueName: r.venue_name || '', city: r.city || '', capacity: r.capacity || '', typicalGenres: r.typical_genres || [], budgetRange: r.budget_range || '', equipment: r.equipment || [], ticketCutPercent: r.ticket_cut_percent, ticketCutAmount: r.ticket_cut_amount, ticketPricePolicy: r.ticket_price_policy || '', percentagePolicies: r.percentage_policies || '', profilePhotoDataUrl: r.profile_photo_data_url, instagram: r.instagram, tiktok: r.tiktok, x: r.x, facebook: r.facebook, whatsapp: r.whatsapp, telegram: r.telegram, soundcloud: r.soundcloud, bandcamp: r.bandcamp });
                const oApp = (r) => ({ userId: r.user_id, organizerName: r.organizer_name || '', city: r.city || '', networkTags: r.network_tags || [], organizationFee: r.organization_fee, organizationFeePercent: r.organization_fee_percent, requirements: r.requirements || [], contactPhone: r.contact_phone || '', profilePhotoDataUrl: r.profile_photo_data_url, instagram: r.instagram, tiktok: r.tiktok, x: r.x, facebook: r.facebook, whatsapp: r.whatsapp, telegram: r.telegram, soundcloud: r.soundcloud, bandcamp: r.bandcamp });
                const dApp = (r) => ({ userId: r.user_id, businessName: r.business_name || '', city: r.city || '', serviceAreaKm: r.service_area_km, categories: r.categories || [], portfolioDriveLinks: r.portfolio_drive_links || [], profilePhotoDataUrl: r.profile_photo_data_url, instagram: r.instagram, tiktok: r.tiktok, x: r.x, facebook: r.facebook, whatsapp: r.whatsapp, telegram: r.telegram, soundcloud: r.soundcloud, bandcamp: r.bandcamp });
                setCache('djProfiles', (djRes.data || []).map(djApp));
                setCache('venueProfiles', (vRes.data || []).map(vApp));
                setCache('organizerProfiles', (oRes.data || []).map(oApp));
                setCache('decoratorProfiles', (dRes.data || []).map(dApp));
                setCache('commonProfiles', (cRes.data || []).map(r => ({ userId: r.user_id, displayName: r.display_name || '', avatarDataUrl: r.avatar_data_url, coverDataUrl: r.cover_data_url, bio: r.bio || '', languages: r.languages || [], tags: r.tags || [], workingCities: r.working_cities || [], showEmail: r.show_email, showPhone: r.show_phone, allowDirectBooking: r.allow_direct_booking !== false, preferredContactMethod: r.preferred_contact_method || 'in_app', lastUpdated: r.last_updated || 0 })));
            },
            loadMessages: async () => {
                if (!supabase || !app.currentUser) return;
                const uid = app.currentUser.id;
                const { data: tpData } = await supabase.from('thread_participants').select('thread_id, unread_count').eq('user_id', uid);
                const threadIds = [...new Set((tpData || []).map(t => t.thread_id))];
                if (!threadIds.length) { setCache('messageThreads', []); setCache('messages', []); return; }
                const { data: allPart } = await supabase.from('thread_participants').select('thread_id, user_id').in('thread_id', threadIds);
                const partByThread = {};
                (allPart || []).forEach(p => { if (!partByThread[p.thread_id]) partByThread[p.thread_id] = []; partByThread[p.thread_id].push(p.user_id); });
                const { data: tData } = await supabase.from('message_threads').select('*').in('id', threadIds).order('last_message_at', { ascending: false, nullsFirst: true });
                const threads = (tData || []).map(t => {
                    const parts = partByThread[t.id] || [];
                    const unreadBy = {};
                    const myTp = (tpData || []).find(x => x.thread_id === t.id);
                    if (myTp && myTp.unread_count) unreadBy[uid] = myTp.unread_count;
                    return { id: t.id, participantIds: parts, createdAt: t.created_at ? new Date(t.created_at).getTime() : 0, lastMessageAt: t.last_message_at ? new Date(t.last_message_at).getTime() : 0, lastMessageText: t.last_message_text || '', context: t.context || {}, unreadBy };
                });
                setCache('messageThreads', threads);
                const { data: mData, error: mErr } = await supabase.from('messages').select('*').in('thread_id', threadIds).order('created_at', { ascending: true });
                if (mErr) { showSupabaseError(mErr, 'loadMessages'); return; }
                setCache('messages', (mData || []).map(SupabaseModelMap.mapMessageRowToModel));
            },
            loadAll: async () => {
                if (!supabase) return;
                await SupabaseDataService.loadProfilesAndUsers();
                await SupabaseDataService.loadListings();
                const { data: appData, error: appErr } = await supabase.from('applications').select('*');
                if (appErr) showSupabaseError(appErr, 'loadAll applications');
                setCache('applications', (appData || []).map(SupabaseModelMap.mapApplicationRowToModel));
                const { data: drData } = await supabase.from('deal_rooms').select('*');
                setCache('dealRooms', (drData || []).map(r => ({ id: r.id, listingId: r.listing_id, applicantUserId: r.applicant_id, listingOwnerUserId: r.owner_id, status: r.status, offerTerms: r.offer_terms || {}, acceptedTermsSnapshot: r.accepted_terms_snapshot, createdAt: r.created_at ? new Date(r.created_at).getTime() : 0, updatedAt: r.updated_at ? new Date(r.updated_at).getTime() : 0 })));
                const { data: drmData } = await supabase.from('deal_room_messages').select('*');
                setCache('dealRoomMessages', (drmData || []).map(m => ({ id: m.id, dealRoomId: m.deal_room_id, userId: m.user_id, text: m.text, createdAt: m.created_at ? new Date(m.created_at).getTime() : 0 })));
                const { data: ledData } = await supabase.from('ledger').select('*');
                setCache('ledger', (ledData || []).map(e => ({ id: e.id, dealRoomId: e.deal_room_id, amount: e.amount, payerUserId: e.payer_user_id, payeeUserId: e.payee_user_id, status: e.status, createdAt: e.created_at ? new Date(e.created_at).getTime() : 0 })));
                setCache('connections', []);
                setCache('setUploads', []);
                setCache('reviews', []);
                setCache('reports', []);
                setCache('messagingBlocklist', []);
                if (app.currentUser) await SupabaseDataService.loadMessages();
            }
        };

        const SCHEMA_VERSION = 11;

        function migrateStore() {
            const ver = Store.getObj('schemaVersion') || 0;
            if (ver >= SCHEMA_VERSION) return;
            if (ver === 0) {
                const oldUsers = Store.get('users');
                if (oldUsers.length && oldUsers[0] && !oldUsers[0].type) {
                    Store.set('users', oldUsers.map(u => ({
                        id: u.id,
                        type: 'dj',
                        name: u.name || 'DJ',
                        email: u.email || '',
                        password: u.password || '',
                        location: '',
                        createdAt: Date.now(),
                        status: 'active'
                    })));
                }
                let dp = Store.get('djProfiles');
                if (!dp || !dp.length) dp = [];
                const users = Store.get('users');
                users.forEach(u => {
                    if (!dp.find(p => p.userId === u.id)) dp.push({ userId: u.id, genres: u.genre ? [u.genre] : [], bpmMin: 120, bpmMax: 130, nightlyFee: 0, bio: '', logoDataUrl: null, setSamples: [], googleDriveLink: null });
                });
                Store.set('djProfiles', dp);
            }
            if (ver < 3) {
                var list = Store.get('listings');
                var users = Store.get('users');
                list = list.map(function(l) {
                    var owner = users.find(function(u) { return u.id === l.createdByUserId; });
                    var type = l.listingType;
                    if (type === 'djOffer' || type === 'venueNeeds' || type === 'organizerEvent') type = type;
                    else if (!type) type = owner && owner.type === 'venue' ? 'venueNeeds' : owner && owner.type === 'organizer' ? 'organizerEvent' : 'djOffer';
                    return { ...l, listingType: type, createdAt: l.createdAt != null ? l.createdAt : Date.now() };
                });
                Store.set('listings', list);
            }
            if (ver < 4) {
                var dp = Store.get('djProfiles') || [];
                dp = dp.map(function(p) { return { ...p, googleDriveLink: p.googleDriveLink != null ? p.googleDriveLink : null }; });
                Store.set('djProfiles', dp);
                var su = Store.get('setUploads') || [];
                su = su.map(function(s) { return { ...s, driveUrl: s.driveUrl != null ? s.driveUrl : null }; });
                Store.set('setUploads', su);
            }
            if (ver < 5) {
                var vp = Store.get('venueProfiles') || [];
                vp = vp.map(function(p) { return { ...p, equipment: p.equipment || [], ticketPricePolicy: p.ticketPricePolicy || '', ticketCutPercent: p.ticketCutPercent != null ? p.ticketCutPercent : null, ticketCutAmount: p.ticketCutAmount != null ? p.ticketCutAmount : null, percentagePolicies: p.percentagePolicies || '', lat: p.lat != null ? p.lat : null, lng: p.lng != null ? p.lng : null, address: p.address || '' }; });
                Store.set('venueProfiles', vp);
                var op = Store.get('organizerProfiles') || [];
                op = op.map(function(p) { return { ...p, organizationFee: p.organizationFee != null ? p.organizationFee : null, organizationFeePercent: p.organizationFeePercent != null ? p.organizationFeePercent : null, requirements: p.requirements || [], contactPhone: p.contactPhone || '' }; });
                Store.set('organizerProfiles', op);
                var dp = Store.get('djProfiles') || [];
                dp = dp.map(function(p) { return { ...p, techRider: p.techRider || '', equipmentProvided: p.equipmentProvided || [], soundcloudEmbed: p.soundcloudEmbed || '', spotifyEmbed: p.spotifyEmbed || '', mixcloudEmbed: p.mixcloudEmbed || '', minNoticeDays: p.minNoticeDays != null ? p.minNoticeDays : null, travelRadiusKm: p.travelRadiusKm != null ? p.travelRadiusKm : null }; });
                Store.set('djProfiles', dp);
                var us = Store.get('users') || [];
                us = us.map(function(u) { return { ...u, xp: u.xp != null ? u.xp : 0, level: u.level != null ? u.level : 1, badges: Array.isArray(u.badges) ? u.badges : [] }; });
                Store.set('users', us);
                var list = Store.get('listings') || [];
                list = list.map(function(l) { return { ...l, equipmentProvided: l.equipmentProvided || null, equipmentRequested: l.equipmentRequested || null, ticketInfo: l.ticketInfo || null, ticketCutPercent: l.ticketCutPercent != null ? l.ticketCutPercent : null, organizerFee: l.organizerFee != null ? l.organizerFee : null, requirements: l.requirements || null, lat: l.lat != null ? l.lat : null, lng: l.lng != null ? l.lng : null }; });
                Store.set('listings', list);
            }
            if (ver < 6) {
                if (!Array.isArray(Store.get('decoratorProfiles'))) Store.set('decoratorProfiles', []);
                var users = Store.get('users');
                var decProf = Store.get('decoratorProfiles');
                users.forEach(function(u) {
                    if (u.type === 'decorator' && !decProf.find(function(p) { return p.userId === u.id; })) {
                        decProf.push({ userId: u.id, businessName: '', city: '', serviceAreaKm: null, categories: [], portfolioDriveLinks: [] });
                    }
                });
                Store.set('decoratorProfiles', decProf);
            }
            if (ver < 7) {
                if (!Array.isArray(Store.get('dealRooms'))) Store.set('dealRooms', []);
                if (!Array.isArray(Store.get('dealRoomMessages'))) Store.set('dealRoomMessages', []);
                if (!Array.isArray(Store.get('ledger'))) Store.set('ledger', []);
            }
            if (ver < 8) {
                var list = Store.get('listings') || [];
                list = list.map(function(l) {
                    if (l.listingType === 'venueNeeds' || l.listingType === 'VENUE_NEEDS') {
                        return { ...l, ticketCutMode: l.ticketCutMode || 'percent', ticketCutAmount: l.ticketCutAmount != null ? l.ticketCutAmount : null, percentagePolicies: l.percentagePolicies || null };
                    }
                    if (l.listingType === 'organizerEvent' || l.listingType === 'ORGANIZER_EVENT') {
                        return { ...l, organizerFeePercent: l.organizerFeePercent != null ? l.organizerFeePercent : null, organizerFeeModel: l.organizerFeeModel || 'flat', deliverables: l.deliverables || null };
                    }
                    if (l.listingType === 'djOffer' || l.listingType === 'DJ_OFFER') {
                        return { ...l, rate: l.rate || {}, techRiderOverride: l.techRiderOverride || null, soundcheckMinutes: l.soundcheckMinutes != null ? l.soundcheckMinutes : null, demoLinks: Array.isArray(l.demoLinks) ? l.demoLinks : (l.demoLinks ? [l.demoLinks] : []), cancelPolicy: l.cancelPolicy || null, acceptedTicketModels: Array.isArray(l.acceptedTicketModels) ? l.acceptedTicketModels : [] };
                    }
                    return l;
                });
                Store.set('listings', list);
            }
            if (ver < 9) {
                var users = Store.get('users') || [];
                var commonProfiles = Array.isArray(Store.get('commonProfiles')) ? Store.get('commonProfiles') : [];
                users.forEach(function(u) {
                    if (!commonProfiles.find(function(p) { return p.userId === u.id; })) {
                        commonProfiles.push({
                            userId: u.id,
                            displayName: (u.name || '').trim() || '—',
                            avatarDataUrl: null,
                            coverDataUrl: null,
                            bio: '',
                            languages: [],
                            tags: [],
                            workingCities: [],
                            showEmail: false,
                            showPhone: false,
                            allowDirectBooking: true,
                            preferredContactMethod: 'in_app',
                            lastUpdated: Date.now()
                        });
                    }
                });
                Store.set('commonProfiles', commonProfiles);
            }
            if (ver < 10) {
                ['djProfiles','venueProfiles','organizerProfiles','decoratorProfiles'].forEach(function(key) {
                    var list = Store.get(key) || [];
                    list = list.map(function(p) { return { ...p, profilePhotoDataUrl: p.profilePhotoDataUrl != null ? p.profilePhotoDataUrl : null }; });
                    Store.set(key, list);
                });
            }
            if (ver < 11) {
                if (!Array.isArray(Store.get('messageThreads'))) Store.set('messageThreads', []);
                if (!Array.isArray(Store.get('messages'))) Store.set('messages', []);
                if (!Array.isArray(Store.get('messagingBlocklist'))) Store.set('messagingBlocklist', []);
            }
            Store.setObj('schemaVersion', SCHEMA_VERSION);
        }

        if (!USE_SUPABASE && !Store.get('users').length) {
            Store.set('users', [
                { id: 1, type: 'dj', name: 'DJ Pulse', email: 'dj@test.com', password: '123', location: 'İstanbul', createdAt: Date.now(), status: 'active', xp: 0, level: 1, badges: [] },
                { id: 2, type: 'venue', name: 'The Hive Club', email: 'venue@test.com', password: '123', location: 'İzmir', createdAt: Date.now(), status: 'active', xp: 0, level: 1, badges: [] },
                { id: 3, type: 'organizer', name: 'Night Events', email: 'org@test.com', password: '123', location: 'Ankara', createdAt: Date.now(), status: 'active', xp: 0, level: 1, badges: [] },
                { id: 4, type: 'decorator', name: 'Dekor Pro', email: 'decor@test.com', password: '123', location: 'İstanbul', createdAt: Date.now(), status: 'active', xp: 0, level: 1, badges: [] }
            ]);
            var socialDefaults = { instagram: '', tiktok: '', x: '', facebook: '', whatsapp: '', telegram: '', soundcloud: '', bandcamp: '' };
            Store.set('djProfiles', [{ userId: 1, genres: ['Techno'], bpmMin: 120, bpmMax: 130, nightlyFee: 500, bio: '', logoDataUrl: null, setSamples: [], googleDriveLink: null, techRider: '', equipmentProvided: [], soundcloudEmbed: '', spotifyEmbed: '', mixcloudEmbed: '', minNoticeDays: null, travelRadiusKm: null, ...socialDefaults }]);
            Store.set('venueProfiles', [{ userId: 2, venueName: 'The Hive Club', city: 'İzmir', capacity: '500', typicalGenres: ['Techno', 'House'], budgetRange: '5000-15000', contactPrefs: '', equipment: [], ticketPricePolicy: '', ticketCutPercent: null, ticketCutAmount: null, percentagePolicies: '', lat: null, lng: null, address: '', ...socialDefaults }]);
            Store.set('organizerProfiles', [{ userId: 3, organizerName: 'Night Events', city: 'Ankara', networkTags: [], organizationFee: null, organizationFeePercent: null, requirements: [], contactPhone: '', ...socialDefaults }]);
            Store.set('decoratorProfiles', [{ userId: 4, businessName: 'Dekor Pro', city: 'İstanbul', serviceAreaKm: 100, categories: ['LED', 'BackDrop'], portfolioDriveLinks: [], ...socialDefaults }]);
            var commonDefaults = { displayName: '', avatarDataUrl: null, coverDataUrl: null, bio: '', languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: true, preferredContactMethod: 'in_app', lastUpdated: Date.now() };
            Store.set('commonProfiles', [
                { userId: 1, ...commonDefaults, displayName: 'DJ Pulse' },
                { userId: 2, ...commonDefaults, displayName: 'The Hive Club' },
                { userId: 3, ...commonDefaults, displayName: 'Night Events' },
                { userId: 4, ...commonDefaults, displayName: 'Dekor Pro' }
            ]);
            Store.setObj('schemaVersion', SCHEMA_VERSION);
        }
        if (!Array.isArray(Store.get('commonProfiles'))) Store.set('commonProfiles', []);
        if (!Array.isArray(Store.get('messageThreads'))) Store.set('messageThreads', []);
        if (!Array.isArray(Store.get('messages'))) Store.set('messages', []);
        if (!Array.isArray(Store.get('messagingBlocklist'))) Store.set('messagingBlocklist', []);
        if (!Array.isArray(Store.get('listings'))) Store.set('listings', []);
        if (!Array.isArray(Store.get('decoratorProfiles'))) Store.set('decoratorProfiles', []);
        if (Store.get('listings').length === 0 && Store.get('users').length >= 3) {
            Store.set('listings', [
                { id: 1, createdByUserId: 1, listingType: 'djOffer', title: 'Techno Set — Hafta Sonu Müsait', genres: ['Techno', 'Minimal'], bpmTargetMin: 120, bpmTargetMax: 130, hours: 4, date: '2026-03-15', city: 'İstanbul', budget: 8000, notes: '', visibility: 'public', status: 'active', createdAt: Date.now() - 86400000 },
                { id: 2, createdByUserId: 2, listingType: 'venueNeeds', title: 'DJ Arıyoruz — Mart Etkinliği', genres: ['House', 'Techno'], bpmTargetMin: 118, bpmTargetMax: 128, hours: 5, date: '2026-03-20', city: 'İzmir', budget: 12000, notes: 'Canlı ekipman mevcut', visibility: 'public', status: 'active', createdAt: Date.now() - 43200000 },
                { id: 3, createdByUserId: 3, listingType: 'organizerEvent', title: 'Open Air Techno — Nisan', genres: ['Techno', 'Progressive'], bpmTargetMin: 125, bpmTargetMax: 135, hours: 6, date: '2026-04-10', city: 'Ankara', budget: 15000, notes: 'Dış mekân', visibility: 'public', status: 'active', createdAt: Date.now() },
                { id: 4, createdByUserId: 4, listingType: 'decorRental', title: 'LED Sahne Dekorları — Gece/Etkinlik', city: 'İstanbul', pricingModel: 'perEvent', price: 5000, currency: 'TRY', imagesDriveUrls: ['https://drive.google.com/file/d/1ABC-sample-id/view?usp=sharing'], deposit: 1000, setupFee: 500, deliveryIncluded: false, notes: 'Örnek dekor ilanı', visibility: 'public', status: 'active', createdAt: Date.now() - 3600000 },
                { id: 5, createdByUserId: 4, listingType: 'decorRental', title: 'BackDrop ve Totem Kiralama', city: 'İstanbul', pricingModel: 'perNight', price: 2500, currency: 'TRY', imagesDriveUrls: [], notes: 'BackDrop + totem seti', visibility: 'public', status: 'active', createdAt: Date.now() }
            ]);
        }
        if (!USE_SUPABASE) {
            if (!Array.isArray(Store.get('connections'))) Store.set('connections', []);
            if (!Array.isArray(Store.get('setUploads'))) Store.set('setUploads', []);
            if (!Array.isArray(Store.get('reviews'))) Store.set('reviews', []);
            if (!Array.isArray(Store.get('reports'))) Store.set('reports', []);
            if (!Array.isArray(Store.get('applications'))) Store.set('applications', []);
            if (!Array.isArray(Store.get('dealRooms'))) Store.set('dealRooms', []);
            if (!Array.isArray(Store.get('dealRoomMessages'))) Store.set('dealRoomMessages', []);
            if (!Array.isArray(Store.get('ledger'))) Store.set('ledger', []);
            migrateStore();
        }

        function nextId(key) {
            const list = Store.get(key);
            const max = list.length ? Math.max(...list.map(x => x.id || 0)) : 0;
            return max + 1;
        }
        function escapeHtml(str) { if (str == null) return ''; return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
        function renderSocialLinks(ownerSocialLinks) {
            if (!ownerSocialLinks || typeof ownerSocialLinks !== 'object') return '';
            var items = [];
            var icons = { instagram: 'fa-instagram', tiktok: 'fa-tiktok', x: 'fa-x-twitter', facebook: 'fa-facebook', whatsapp: 'fa-whatsapp', telegram: 'fa-telegram', soundcloud: 'fa-soundcloud', bandcamp: 'fa-bandcamp' };
            var labels = { instagram: 'Instagram', tiktok: 'TikTok', x: 'X', facebook: 'Facebook', whatsapp: 'WhatsApp', telegram: 'Telegram', soundcloud: 'SoundCloud', bandcamp: 'Bandcamp' };
            ['instagram','tiktok','x','facebook','whatsapp','telegram','soundcloud','bandcamp'].forEach(function(k) {
                var url = ownerSocialLinks[k];
                if (url && String(url).trim()) items.push('<a href="' + escapeHtml(String(url).trim()) + '" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition inline-flex items-center gap-1 mr-2" title="' + escapeHtml(labels[k]) + '"><i class="fa-brands ' + icons[k] + '" aria-hidden="true"></i></a>');
            });
            return items.length ? '<div class="flex flex-wrap items-center gap-1 mt-1.5">' + items.join('') + '</div>' : '';
        }

        // --- DRIVE GÖRSEL HELPERS (Dekor ilanları) ---
        function extractDriveFileId(url) {
            if (!url) return null;
            var s = String(url).trim();
            var m = s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (m) return m[1];
            m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (m) return m[1];
            return null;
        }
        function driveImageSrcFromFileId(fileId, size) {
            size = size || 1200;
            return 'https://drive.google.com/thumbnail?id=' + encodeURIComponent(fileId) + '&sz=w' + size;
        }
        function driveImageSrc(url) {
            var id = extractDriveFileId(url);
            return id ? driveImageSrcFromFileId(id) : null;
        }
        function isSafeUrl(u) {
            try {
                var url = new URL(String(u).trim());
                if (['https:', 'http:'].indexOf(url.protocol) === -1) return false;
                var host = url.hostname.toLowerCase();
                return host === 'drive.google.com' || host.endsWith('.drive.google.com');
            } catch (e) { return false; }
        }
        function validateDecorListing(payload) {
            var errs = [];
            if (!payload.title || !payload.title.trim()) errs.push('Başlık zorunlu.');
            if (!payload.city || !payload.city.trim()) errs.push('Şehir zorunlu.');
            if (!['perNight', 'perEvent'].includes(payload.pricingModel)) errs.push('Fiyat modeli seçin (Gece/Etkinlik).');
            if (!(Number(payload.price) > 0)) errs.push('Fiyat 0\'dan büyük olmalı.');
            var urls = Array.isArray(payload.imagesDriveUrls) ? payload.imagesDriveUrls : [];
            if (urls.length < 1) errs.push('En az 1 Drive görsel linki ekleyin.');
            urls.forEach(function(u) {
                if (!isSafeUrl(u)) errs.push('Geçersiz veya izin verilmeyen URL: ' + (u || '').substring(0, 50));
            });
            return errs;
        }
        function renderDecorGallery(imagesDriveUrls) {
            var urls = (imagesDriveUrls || []).filter(Boolean);
            if (!urls.length) return '<div class="text-xs text-gray-400 mt-2">Görsel yok (Drive paylaşımı açık mı?)</div>';
            var items = urls.map(function(u) { return { u: u, src: driveImageSrc(u), valid: isSafeUrl(u) }; });
            var preview = items.slice(0, 6);
            return '<div class="grid grid-cols-3 gap-2 mt-3">' + preview.map(function(x) {
                var safeHref = String(x.u).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                if (!x.valid) return '<div class="rounded border border-amber-800 bg-amber-900/20 p-2 h-24 flex flex-col justify-center items-center text-center"><span class="text-xs text-amber-400">Geçersiz link</span><a href="' + safeHref + '" target="_blank" rel="noopener noreferrer" class="text-xs text-brand-glow mt-1">Drive\'da aç</a></div>';
                var safeSrc = escapeHtml(x.src);
                var onErr = "var w=this.closest('.relative');if(w){var f=w.querySelector('.decor-fallback');if(f)f.classList.remove('hidden');this.style.display='none';}";
                return '<div class="relative"><a href="' + safeHref + '" target="_blank" rel="noopener noreferrer" class="block"><img src="' + safeSrc + '" loading="lazy" class="w-full h-24 object-cover rounded border border-gray-800" onerror="' + onErr.replace(/"/g, '&quot;') + '" alt="Dekor görseli"></a><div class="decor-fallback hidden absolute inset-0 rounded border border-gray-700 bg-gray-900/90 flex flex-col justify-center items-center p-1"><span class="text-xs text-gray-400">Görsel yüklenemedi</span><a href="' + safeHref + '" target="_blank" rel="noopener noreferrer" class="text-xs text-brand-glow mt-1">Drive\'da aç</a></div></div>';
            }).join('') + '</div>';
        }

        // --- LISTING SCHEMA (Data Contract) ---
        // ownerRole: "dj" | "venue" | "organizer" | "decorator" (tek kaynak: ROLE)
        // listingType: "DJ_OFFER" | "VENUE_NEEDS" | "ORGANIZER_EVENT" | "DECOR_RENTAL"
        const ROLE = { DJ: 'dj', VENUE: 'venue', ORGANIZER: 'organizer', DECORATOR: 'decorator' };
        function normalizeRole(raw) {
            if (!raw) return ROLE.DJ;
            var v = String(raw).toLowerCase().trim();
            if (v === 'dj') return ROLE.DJ;
            if (v === 'venue') return ROLE.VENUE;
            if (v === 'organizer') return ROLE.ORGANIZER;
            if (v === 'decorator') return ROLE.DECORATOR;
            return v;
        }
        const LISTING_TYPE = { DJ_OFFER: 'DJ_OFFER', VENUE_NEEDS: 'VENUE_NEEDS', ORGANIZER_EVENT: 'ORGANIZER_EVENT', DECOR_RENTAL: 'DECOR_RENTAL' };
        function normalizeListingType(raw) {
            if (!raw) return LISTING_TYPE.DJ_OFFER;
            const v = String(raw).toUpperCase().replace(/-/g, '_');
            if (v === 'DJ_OFFER' || v === 'DJOFFER') return LISTING_TYPE.DJ_OFFER;
            if (v === 'VENUE_NEEDS' || v === 'VENUENEEDS') return LISTING_TYPE.VENUE_NEEDS;
            if (v === 'ORGANIZER_EVENT' || v === 'ORGANIZEREVENT') return LISTING_TYPE.ORGANIZER_EVENT;
            if (v === 'DECOR_RENTAL' || v === 'DECORRENTAL') return LISTING_TYPE.DECOR_RENTAL;
            return LISTING_TYPE.DJ_OFFER;
        }
        function normalizeListing(listing, users) {
            const owner = users.find(u => u.id === listing.createdByUserId);
            const ownerRole = owner ? normalizeRole(owner.type) : ROLE.DJ;
            const ownerName = owner ? owner.name : 'Bilinmiyor';
            const type = normalizeListingType(listing.listingType);
            const genres = Array.isArray(listing.genres) ? listing.genres : (listing.genre ? [listing.genre] : []);
            const bpmMin = listing.bpmTargetMin != null ? Number(listing.bpmTargetMin) : (listing.bpmMin != null ? Number(listing.bpmMin) : null);
            const bpmMax = listing.bpmTargetMax != null ? Number(listing.bpmTargetMax) : (listing.bpmMax != null ? Number(listing.bpmMax) : null);
            const budget = listing.budget != null ? (typeof listing.budget === 'number' ? listing.budget : parseInt(String(listing.budget).replace(/[^0-9]/g, ''), 10) || null) : null;
            var logoDataUrl = null;
            var ownerGoogleDriveLink = null;
            var techRiderSummary = null;
            var ownerSocialLinks = {};
            var displayImg = { url: null, kind: null };
            if (owner && listing.createdByUserId) {
                displayImg = resolveDisplayImageForUser(owner);
                var prof = getProfile(owner);
                if (prof) {
                    if (ownerRole === 'dj') {
                        logoDataUrl = displayImg.url;
                        if (prof.googleDriveLink) ownerGoogleDriveLink = prof.googleDriveLink;
                        if (prof.techRider) techRiderSummary = String(prof.techRider).trim().slice(0, 80);
                    } else {
                        logoDataUrl = displayImg.url;
                    }
                    if (prof.instagram) ownerSocialLinks.instagram = prof.instagram;
                    if (prof.tiktok) ownerSocialLinks.tiktok = prof.tiktok;
                    if (prof.x) ownerSocialLinks.x = prof.x;
                    if (prof.facebook) ownerSocialLinks.facebook = prof.facebook;
                    if (prof.whatsapp) ownerSocialLinks.whatsapp = prof.whatsapp;
                    if (prof.telegram) ownerSocialLinks.telegram = prof.telegram;
                    if (prof.soundcloud) ownerSocialLinks.soundcloud = prof.soundcloud;
                    if (prof.bandcamp) ownerSocialLinks.bandcamp = prof.bandcamp;
                }
            }
            return {
                ...listing,
                ownerRole,
                ownerName,
                logoDataUrl: logoDataUrl || undefined,
                displayImageUrl: displayImg && displayImg.url ? displayImg.url : undefined,
                displayImageKind: displayImg && displayImg.kind ? displayImg.kind : undefined,
                ownerGoogleDriveLink: ownerGoogleDriveLink || undefined,
                techRiderSummary: techRiderSummary || undefined,
                ownerSocialLinks: Object.keys(ownerSocialLinks).length ? ownerSocialLinks : undefined,
                listingType: type,
                genres,
                bpmMin: isNaN(bpmMin) ? null : bpmMin,
                bpmMax: isNaN(bpmMax) ? null : bpmMax,
                budget: isNaN(budget) ? null : budget,
                hours: listing.hours != null ? Number(listing.hours) : null,
                date: listing.date || null,
                city: listing.city || '',
                title: listing.title || 'İlansız',
                desc: listing.notes || listing.desc || '',
                createdAt: listing.createdAt != null ? listing.createdAt : (listing.created_at || Date.now()),
                price: listing.price != null ? Number(listing.price) : listing.price,
                pricingModel: listing.pricingModel || null,
                imagesDriveUrls: Array.isArray(listing.imagesDriveUrls) ? listing.imagesDriveUrls : []
            };
        }
        function getRoleUI(ownerRole) {
            const r = (ownerRole || 'dj').toLowerCase();
            if (r === 'venue') return { label: 'MEKAN İLANI', icon: 'fa-building', stripClass: 'listing-strip-venue', badgeClass: 'listing-badge-venue', ariaLabel: 'Mekan ilanı' };
            if (r === 'organizer') return { label: 'ORGANİZATÖR İLANI', icon: 'fa-calendar-days', stripClass: 'listing-strip-organizer', badgeClass: 'listing-badge-organizer', ariaLabel: 'Organizatör ilanı' };
            if (r === 'decorator') return { label: 'DEKOR KİRALAMA', icon: 'fa-palette', stripClass: 'listing-strip-decorator', badgeClass: 'listing-badge-decorator', ariaLabel: 'Dekor kiralama ilanı' };
            return { label: 'DJ İLANI', icon: 'fa-headphones', stripClass: 'listing-strip-dj', badgeClass: 'listing-badge-dj', ariaLabel: 'DJ ilanı' };
        }
        function getTypeLabel(listingType) {
            if (listingType === LISTING_TYPE.VENUE_NEEDS) return 'VENUE NEEDS';
            if (listingType === LISTING_TYPE.ORGANIZER_EVENT) return 'EVENT';
            if (listingType === LISTING_TYPE.DECOR_RENTAL) return 'DEKOR KİRALAMA';
            return 'DJ OFFER';
        }
        function filterListings(list, filters) {
            if (!filters) return list;
            return list.filter(l => {
                if (filters.role && l.ownerRole !== filters.role) return false;
                if (filters.city && !l.city.toLowerCase().includes((filters.city || '').toLowerCase())) return false;
                if (filters.genre && (!l.genres || !l.genres.length || !l.genres.some(g => g.toLowerCase().includes((filters.genre || '').toLowerCase())))) return false;
                if (filters.bpmMin != null && filters.bpmMin !== '' && (l.bpmMax == null || l.bpmMax < Number(filters.bpmMin))) return false;
                if (filters.bpmMax != null && filters.bpmMax !== '' && (l.bpmMin == null || l.bpmMin > Number(filters.bpmMax))) return false;
                if (filters.budgetMin != null && filters.budgetMin !== '' && (l.budget == null || l.budget < Number(filters.budgetMin))) return false;
                if (filters.budgetMax != null && filters.budgetMax !== '' && (l.budget == null || l.budget > Number(filters.budgetMax))) return false;
                if (filters.date && l.date !== filters.date) return false;
                return true;
            });
        }
        function sortListings(list, sortBy) {
            const arr = [...list];
            if (sortBy === 'budget') arr.sort((a, b) => (b.budget || 0) - (a.budget || 0));
            else if (sortBy === 'priceAsc') arr.sort((a, b) => ((a.price != null ? Number(a.price) : Infinity) - (b.price != null ? Number(b.price) : Infinity)));
            else if (sortBy === 'priceDesc') arr.sort((a, b) => ((b.price != null ? Number(b.price) : 0) - (a.price != null ? Number(a.price) : 0)));
            else if (sortBy === 'bpm') arr.sort((a, b) => (a.bpmMin || 0) - (b.bpmMin || 0));
            else if (sortBy === 'date') arr.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
            else arr.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            return arr;
        }
        function renderListingCard(listing) {
            const ui = getRoleUI(listing.ownerRole);
            const typeLabel = getTypeLabel(listing.listingType);
            const isDecor = listing.ownerRole === 'decorator' || listing.listingType === LISTING_TYPE.DECOR_RENTAL;
            const meta = [];
            if (isDecor) {
                if (listing.price != null) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-turkish-lira-sign text-gray-500 mr-1" aria-hidden="true"></i>' + (listing.price >= 1000 ? (listing.price / 1000) + 'K' : listing.price) + ' TL/' + (listing.pricingModel === 'perEvent' ? 'etkinlik' : 'gece') + '</span>');
                if (listing.city) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-location-dot text-gray-500 mr-1" aria-hidden="true"></i>' + escapeHtml(listing.city) + '</span>');
            } else {
                if (listing.genres && listing.genres.length) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-music text-gray-500 mr-1" aria-hidden="true"></i>' + listing.genres.slice(0, 3).join(', ') + '</span>');
                if (listing.bpmMin != null || listing.bpmMax != null) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-gauge-high text-gray-500 mr-1" aria-hidden="true"></i>BPM ' + (listing.bpmMin ?? '?') + '–' + (listing.bpmMax ?? '?') + '</span>');
                if (listing.hours != null) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-clock text-gray-500 mr-1" aria-hidden="true"></i>' + listing.hours + ' saat</span>');
                if (listing.budget != null) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-turkish-lira-sign text-gray-500 mr-1" aria-hidden="true"></i>' + (listing.budget >= 1000 ? (listing.budget / 1000) + 'K' : listing.budget) + ' TL</span>');
                if (listing.city) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-location-dot text-gray-500 mr-1" aria-hidden="true"></i>' + listing.city + '</span>');
                if (listing.ownerRole === 'venue') {
                    var tcm = listing.ticketCutMode || 'percent';
                    if (listing.ticketCutPercent != null) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-ticket text-gray-500 mr-1" aria-hidden="true"></i>' + listing.ticketCutPercent + '% kesim</span>');
                    if (listing.ticketCutAmount != null) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-turkish-lira-sign text-gray-500 mr-1" aria-hidden="true"></i>' + listing.ticketCutAmount + ' TL/bilet</span>');
                    if (listing.percentagePolicies) meta.push('<span class="listing-meta-item text-gray-400" title="' + escapeHtml(listing.percentagePolicies) + '">Politika</span>');
                    if (listing.ticketInfo) meta.push('<span class="listing-meta-item">' + escapeHtml(String(listing.ticketInfo).slice(0, 25)) + '</span>');
                }
                if (listing.ownerRole === 'organizer') {
                    if (listing.organizerFee != null) meta.push('<span class="listing-meta-item">' + listing.organizerFee + ' TL org</span>');
                    if (listing.organizerFeePercent != null) meta.push('<span class="listing-meta-item">' + listing.organizerFeePercent + '% org</span>');
                    if (listing.requirements && listing.requirements.length) meta.push('<span class="listing-meta-item">' + listing.requirements.length + ' gereksinim</span>');
                    if (listing.deliverables && listing.deliverables.length) meta.push('<span class="listing-meta-item">' + listing.deliverables.length + ' teslim</span>');
                }
                if (listing.ownerRole === 'dj' && listing.rate && (listing.rate.baseFee != null || listing.rate.extraHourFee != null)) meta.push('<span class="listing-meta-item"><i class="fa-solid fa-turkish-lira-sign text-gray-500 mr-1" aria-hidden="true"></i>' + (listing.rate.baseFee != null ? listing.rate.baseFee + ' TL gece' : '') + (listing.rate.extraHourFee != null ? ' +' + listing.rate.extraHourFee + '/saat' : '') + '</span>');
            }
            const metaHtml = meta.length ? '<div class="listing-meta text-sm text-gray-300 mt-2 flex flex-wrap gap-x-4 gap-y-1">' + meta.join('') + '</div>' : '';
            var name = listing.ownerName || (isDecor ? 'Dekorcu' : 'DJ');
            var initial = name.trim().charAt(0).toUpperCase();
            var safeName = name.replace(/"/g, '&quot;');
            var displayUrl = listing.displayImageUrl || listing.logoDataUrl || null;
            var leftAvatarHtml = '';
            if (displayUrl) {
                var avatarUrl = displayUrl.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                leftAvatarHtml = '<div class="listing-card-avatar"><img src="' + avatarUrl + '" alt=""></div>';
            } else {
                leftAvatarHtml = '<div class="listing-card-avatar"><span class="listing-card-avatar-initial" aria-hidden="true">' + initial + '</span></div>';
            }
            var rightColumnHtml = '';
            if (isDecor) {
                rightColumnHtml = '<div class="w-full">' + renderDecorGallery(listing.imagesDriveUrls || []) + '</div>';
            } else if (listing.ownerRole === 'dj') {
                if (displayUrl) {
                    var bigLogoUrl = displayUrl.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    rightColumnHtml = '<div class="listing-logo-preview-slot"><img src="' + bigLogoUrl + '" alt="' + safeName + ' logosu" loading="lazy"></div>';
                } else {
                    rightColumnHtml = '<div class="listing-logo-preview-slot"><div class="listing-logo-fallback" aria-label="' + safeName + ' logo yok"><span class="listing-logo-fallback-initial">' + initial + '</span><span class="listing-logo-fallback-hint">Logo yok</span></div></div>';
                }
            }
            var roleLabelCard = listing.ownerRole === 'dj' ? 'DJ' : listing.ownerRole === 'venue' ? 'Mekan' : listing.ownerRole === 'decorator' ? 'Dekorcu' : 'Organizatör';
            rightColumnHtml += '<button type="button" onclick="app.router(\'profile-view\', { userId: ' + JSON.stringify(listing.createdByUserId) + ' })" class="px-3 py-2 rounded border border-gray-600 text-gray-400 text-sm hover:bg-gray-800 transition flex-shrink-0 self-center">Profil</button><button type="button" onclick="(async function(){ await Messaging.openThreadWith(' + JSON.stringify(listing.createdByUserId) + ', { listingId: ' + listing.id + ' }); app.router(\'messages\', { threadId: Messaging._lastThreadId }); })()" class="px-3 py-2 rounded border border-brand-accent text-brand-accent text-sm hover:bg-brand-accent/10 transition flex-shrink-0 self-center">Mesaj</button><button type="button" onclick="ApplicationsAPI.apply(' + listing.id + ')" class="px-4 py-2 rounded bg-brand-accent hover:bg-violet-600 text-white text-sm font-bold transition flex-shrink-0 self-center">Başvur</button>';
            return `
            <article class="listing-card rounded-xl border border-gray-800 bg-gray-900/50 hover:border-gray-600 hover:bg-gray-900/80 transition-all duration-200 flex overflow-hidden items-stretch" aria-label="${listing.title}">
                <div class="listing-strip ${ui.stripClass}" aria-hidden="true"></div>
                <div class="listing-card-left flex items-center justify-center p-2">${leftAvatarHtml}</div>
                <div class="listing-card-center flex-1 p-4 pl-2 min-w-0 flex flex-col">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="${ui.badgeClass} listing-badge inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-bold tracking-widest uppercase" role="status" aria-label="${ui.ariaLabel}"><i class="fa-solid ${ui.icon}" aria-hidden="true"></i>${ui.label}</span>
                        <span class="listing-type-chip px-2 py-0.5 rounded bg-gray-800 text-gray-400 text-xs font-mono">${typeLabel}</span>
                    </div>
                    <h3 class="font-bold text-white text-lg">${listing.title}</h3>
                    ${metaHtml}
                    <div class="mt-auto pt-3 border-t border-gray-800">
                        <span class="text-xs text-gray-400"><i class="fa-solid fa-user text-gray-500 mr-1" aria-hidden="true"></i>${listing.ownerName} <span class="text-gray-500">•</span> ${roleLabelCard}</span>
                        ${listing.ownerRole === 'dj' && listing.techRiderSummary ? '<br><span class="text-xs text-gray-500 mt-1 block">Rider: ' + escapeHtml(listing.techRiderSummary) + (listing.techRiderSummary.length >= 80 ? '…' : '') + '</span>' : ''}
                        ${listing.ownerRole === 'dj' && listing.ownerGoogleDriveLink ? '<br><a href="' + String(listing.ownerGoogleDriveLink).replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer" class="text-xs text-brand-glow hover:underline mt-1 inline-flex items-center gap-1"><i class="fa-brands fa-google-drive"></i> Portföy</a>' : ''}
                    </div>
                </div>
                <div class="listing-card-right flex flex-col items-center justify-center gap-3 p-4 flex-shrink-0">${rightColumnHtml}</div>
            </article>`;
        }

        // --- PRESETS & CONFIGS ---
        const Presets = {
            minimal: {
                styleName: "Minimal Dark Sigil",
                layout: { preset: 'stacked', iconScale: 100, textScale: 100, spacing: 40, padding: 60, perspective: 0 },
                typography: { font: 'Inter', weight: 300, tracking: 15, width: 100, slant: 0, stroke: 0, inset: 0 },
                icon: { preset: 'sigil1', detail: 20, stroke: 2, radius: 0, coreType: 'none', coreSize: 0, coreGlow: 0 },
                frame: { type: 'rect', thickness: 2, radius: 0, double: 0, notches: false },
                material: { preset: 'matte', bevel: 0, extrude: 0, specular: 0, rim: 10, ao: 20 },
                color: { primary: '#ffffff', secondary: '#333333', gradient: 'none', hue: 0, sat: 0 },
                fx: { glow: 10, bloom: 0, glitch: 0, noise: 10, vignette: 40, flare: false, scanlines: false },
                background: { type: 'solid', color: '#000000', opacity: 100 }
            },
            cyberpunk: {
                styleName: "Neon Psy Portal",
                layout: { preset: 'inline', iconScale: 120, textScale: 110, spacing: 20, padding: 40, perspective: 10 },
                typography: { font: 'Orbitron', weight: 900, tracking: 5, width: 110, slant: -5, stroke: 0, inset: 0 },
                icon: { preset: 'dna', detail: 80, stroke: 3, radius: 10, coreType: 'lens', coreSize: 60, coreGlow: 80 },
                frame: { type: 'tech', thickness: 4, radius: 10, double: 10, notches: true },
                material: { preset: 'neon', bevel: 20, extrude: 10, specular: 80, rim: 60, ao: 40 },
                color: { primary: '#00f0ff', secondary: '#7c3aed', gradient: 'linear', hue: 0, sat: 120 },
                fx: { glow: 80, bloom: 60, glitch: 20, noise: 30, vignette: 60, flare: true, scanlines: true },
                background: { type: 'nebula', color: '#1a0b2e', opacity: 90 }
            },
            industrial: {
                styleName: "Industrial Techno",
                layout: { preset: 'poster', iconScale: 80, textScale: 140, spacing: 0, padding: 20, perspective: 0 },
                typography: { font: 'Bebas Neue', weight: 400, tracking: 5, width: 90, slant: 0, stroke: 0, inset: 10 },
                icon: { preset: 'sigil2', detail: 60, stroke: 8, radius: 0, coreType: 'none', coreSize: 0, coreGlow: 0 },
                frame: { type: 'double', thickness: 8, radius: 0, double: 20, notches: false },
                material: { preset: 'gunmetal', bevel: 10, extrude: 0, specular: 40, rim: 30, ao: 80 },
                color: { primary: '#ffffff', secondary: '#ff0055', gradient: 'angular', hue: 0, sat: 0 },
                fx: { glow: 0, bloom: 0, glitch: 60, noise: 80, vignette: 20, flare: false, scanlines: true },
                background: { type: 'grid', color: '#111111', opacity: 100 }
            },
            metal3d: {
                styleName: "Heavy Metal 3D",
                layout: { preset: 'stacked', iconScale: 130, textScale: 110, spacing: 10, padding: 50, perspective: 15 },
                typography: { font: 'Audiowide', weight: 700, tracking: 0, width: 120, slant: 0, stroke: 1, inset: 0 },
                icon: { preset: 'ring', detail: 50, stroke: 15, radius: 100, coreType: 'gem', coreSize: 40, coreGlow: 40 },
                frame: { type: 'none', thickness: 0, radius: 0, double: 0, notches: false },
                material: { preset: 'chrome', bevel: 30, extrude: 50, specular: 90, rim: 80, ao: 60 },
                color: { primary: '#e2e8f0', secondary: '#94a3b8', gradient: 'linear', hue: 0, sat: 0 },
                fx: { glow: 20, bloom: 30, glitch: 0, noise: 10, vignette: 50, flare: true, scanlines: false },
                background: { type: 'smoke', color: '#0f172a', opacity: 100 }
            }
        };

        // --- HELPERS ---
        const GENRES = ['Techno', 'House', 'Trance', 'Drum & Bass', 'Dubstep', 'Electro', 'Minimal', 'Progressive', 'Hardstyle', 'Diğer'];
        function getProfile(user) {
            if (!user) return null;
            const uid = String(user.id);
            if (user.type === 'dj') return Store.get('djProfiles').find(p => String(p.userId) === uid);
            if (user.type === 'venue') return Store.get('venueProfiles').find(p => String(p.userId) === uid);
            if (user.type === 'organizer') return Store.get('organizerProfiles').find(p => String(p.userId) === uid);
            if (user.type === 'decorator') return Store.get('decoratorProfiles').find(p => String(p.userId) === uid);
            return null;
        }
        function getCommonProfile(userId) {
            return (Store.get('commonProfiles') || []).find(p => String(p.userId) === String(userId)) || null;
        }
        /* Profile System v1: commonProfiles + getFullProfile (ProfileResolver), ProfileViewPage / ProfileEditPage, UploadEngine avatar/cover, privacy toggles, listing card "Profil" + deal room mini profile. QA: profile view/edit, avatar upload, completeness %, role sections, export commonProfiles. */
        /** ProfileResolver: unified profile for view/edit. Fallback empty values show as "—". */
        function getFullProfile(userId) {
            var user = (Store.get('users') || []).find(function(u) { return String(u.id) === String(userId); });
            if (!user) return { user: null, common: null, dj: null, organizer: null, venue: null, decorator: null, completenessScore: 0, lastUpdated: 0 };
            var common = getCommonProfile(userId) || { displayName: '', avatarDataUrl: null, coverDataUrl: null, bio: '', languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: true, preferredContactMethod: 'in_app', lastUpdated: 0 };
            var roleProfile = getProfile(user);
            var dj = user.type === 'dj' ? roleProfile : null;
            var organizer = user.type === 'organizer' ? roleProfile : null;
            var venue = user.type === 'venue' ? roleProfile : null;
            var decorator = user.type === 'decorator' ? roleProfile : null;
            var displayName = (common.displayName || '').trim() || (user.name || '').trim() || '—';
            common = { ...common, displayName: displayName || '—' };
            var score = 0, total = 0;
            function add(filled) { total++; if (filled) score++; }
            add(!!displayName);
            add(!!(common.avatarDataUrl || (dj && dj.logoDataUrl)));
            add(!!(common.bio && common.bio.trim()));
            if (user.type === 'dj') { add(dj && Array.isArray(dj.genres) && dj.genres.length > 0); add(dj && (dj.nightlyFee != null || (dj.techRider && dj.techRider.trim()))); }
            if (user.type === 'venue') { add(venue && (venue.venueName || '').trim()); add(venue && (venue.city || '').trim()); add(venue && (venue.capacity != null && venue.capacity !== '')); }
            if (user.type === 'organizer') { add(organizer && (organizer.organizerName || '').trim()); add(organizer && (organizer.city || '').trim()); }
            if (user.type === 'decorator') { add(decorator && ((decorator.businessName || '').trim() || (decorator.city || '').trim())); add(decorator && Array.isArray(decorator.categories) && decorator.categories.length > 0); }
            var completenessScore = total ? Math.round((score / total) * 100) : 0;
            var lastUpdated = common.lastUpdated || (roleProfile && roleProfile.lastUpdated) || user.createdAt || 0;
            return { user, common, dj, organizer, venue, decorator, completenessScore, lastUpdated };
        }
        function profileField(val, fallback) { return (val != null && String(val).trim() !== '') ? String(val).trim() : (fallback || '—'); }

        /* Avatar Rule v1: logo > profile photo > initial. resolveDisplayImageForUser(user) returns { url, kind }. */
        function resolveDisplayImageForUser(user) {
            if (!user) return { url: null, kind: null };
            var roleProfile = getProfile(user);
            var common = getCommonProfile(user.id);
            var logoDataUrl = roleProfile && roleProfile.logoDataUrl ? roleProfile.logoDataUrl : null;
            var profilePhotoDataUrl = (roleProfile && roleProfile.profilePhotoDataUrl) || (common && common.avatarDataUrl) || null;
            var url = logoDataUrl || profilePhotoDataUrl || null;
            var kind = logoDataUrl ? 'logo' : (profilePhotoDataUrl ? 'photo' : null);
            return { url: url, kind: kind };
        }

        /** Upload engine: avatar (max 512, webp ~300KB), cover (max width 1600). localStorage base64. */
        const UploadEngine = {
            MAX_AVATAR_PX: 512,
            MAX_COVER_WIDTH: 1600,
            TARGET_AVATAR_KB: 300,
            ALLOWED_TYPES: ['image/jpeg', 'image/png', 'image/webp'],
            processFile: (file, opts, cb) => {
                opts = opts || {};
                var maxSize = opts.maxSize || UploadEngine.MAX_AVATAR_PX;
                var maxWidth = opts.maxWidth || UploadEngine.MAX_COVER_WIDTH;
                var isAvatar = !!opts.avatar;
                if (!file || !UploadEngine.ALLOWED_TYPES.includes(file.type)) { cb(new Error('Geçersiz dosya tipi. JPG, PNG veya WebP kullanın.')); return; }
                if (file.size > 8 * 1024 * 1024) { cb(new Error('Dosya 8MB\'dan küçük olmalı.')); return; }
                var img = new Image();
                var url = URL.createObjectURL(file);
                img.onload = function() {
                    URL.revokeObjectURL(url);
                    var w = img.width, h = img.height;
                    var dw = w, dh = h;
                    if (isAvatar) {
                        var s = Math.min(maxSize, w, h);
                        dw = dh = s;
                    } else {
                        if (w > maxWidth) { dw = maxWidth; dh = Math.round(h * (maxWidth / w)); }
                    }
                    var canvas = document.createElement('canvas');
                    canvas.width = dw; canvas.height = dh;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h, 0, 0, dw, dh);
                    var quality = 0.85;
                    var tryExport = function() {
                        var dataUrl = canvas.toDataURL('image/webp', quality);
                        var sizeKb = (dataUrl.length * 0.75) / 1024;
                        if (isAvatar && sizeKb > UploadEngine.TARGET_AVATAR_KB && quality > 0.3) { quality -= 0.1; tryExport(); return; }
                        cb(null, dataUrl);
                    };
                    try { tryExport(); } catch (e) { cb(e); }
                };
                img.onerror = function() { URL.revokeObjectURL(url); cb(new Error('Görsel yüklenemedi.')); };
                img.src = url;
            },
            saveAvatar: (userId, dataUrl) => {
                var list = Store.get('commonProfiles') || [];
                var i = list.findIndex(p => p.userId === userId);
                if (i >= 0) { list[i].avatarDataUrl = dataUrl; list[i].lastUpdated = Date.now(); } else { list.push({ userId: userId, avatarDataUrl: dataUrl, displayName: '', coverDataUrl: null, bio: '', languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: true, preferredContactMethod: 'in_app', lastUpdated: Date.now() }); }
                Store.set('commonProfiles', list);
            },
            saveCover: (userId, dataUrl) => {
                var list = Store.get('commonProfiles') || [];
                var i = list.findIndex(p => p.userId === userId);
                if (i >= 0) { list[i].coverDataUrl = dataUrl; list[i].lastUpdated = Date.now(); } else { list.push({ userId: userId, coverDataUrl: dataUrl, displayName: '', avatarDataUrl: null, bio: '', languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: true, preferredContactMethod: 'in_app', lastUpdated: Date.now() }); }
                Store.set('commonProfiles', list);
            }
        };

        /** Tek kaynak: Deal Room ekonomisi. terms = offerTerms (room) üstüne listing + profil fallback. */
        function getEffectiveTerms(room, listing, owner, applicant) {
            var ot = room && room.offerTerms ? room.offerTerms : {};
            var list = listing || {};
            var venueP = owner && owner.type === 'venue' ? getProfile(owner) : null;
            var orgP = owner && owner.type === 'organizer' ? getProfile(owner) : null;
            var djP = applicant && applicant.type === 'dj' ? getProfile(applicant) : null;
            var decP = (owner && owner.type === 'decorator' ? getProfile(owner) : null) || (applicant && applicant.type === 'decorator' ? getProfile(applicant) : null);
            return {
                price: ot.price != null ? ot.price : (list.rate && list.rate.baseFee != null ? list.rate.baseFee : (djP && djP.nightlyFee != null ? djP.nightlyFee : null)),
                date: ot.date || list.date || '',
                hours: ot.hours != null ? ot.hours : (list.hours != null ? list.hours : null),
                eventTitle: ot.eventTitle || list.title || '',
                eventCity: ot.eventCity || list.city || '',
                eventBudget: ot.eventBudget != null ? ot.eventBudget : (list.budget != null ? parseInt(String(list.budget).replace(/[^0-9]/g,''), 10) : null),
                ticketCutMode: ot.ticketCutMode || list.ticketCutMode || (venueP && venueP.ticketCutPercent != null ? 'percent' : 'percent'),
                ticketCutPercent: ot.ticketCutPercent != null ? ot.ticketCutPercent : (list.ticketCutPercent != null ? list.ticketCutPercent : (venueP ? venueP.ticketCutPercent : null)),
                ticketCutAmount: ot.ticketCutAmount != null ? ot.ticketCutAmount : (list.ticketCutAmount != null ? list.ticketCutAmount : (venueP ? venueP.ticketCutAmount : null)),
                percentagePolicies: ot.percentagePolicies != null ? ot.percentagePolicies : (list.percentagePolicies || (venueP ? venueP.percentagePolicies : '') || ''),
                ticketPricePolicy: ot.ticketPricePolicy != null ? ot.ticketPricePolicy : (list.ticketInfo || (venueP ? venueP.ticketPricePolicy : '') || ''),
                organizerFeeModel: ot.organizerFeeModel || list.organizerFeeModel || 'flat',
                organizerFee: ot.organizerFee != null ? ot.organizerFee : (list.organizerFee != null ? list.organizerFee : (orgP ? orgP.organizationFee : null)),
                organizerFeePercent: ot.organizerFeePercent != null ? ot.organizerFeePercent : (list.organizerFeePercent != null ? list.organizerFeePercent : (orgP ? orgP.organizationFeePercent : null)),
                requirements: ot.requirements != null ? ot.requirements : (list.requirements || (orgP ? orgP.requirements : []) || []),
                deliverables: ot.deliverables != null ? ot.deliverables : (list.deliverables || []) || [],
                rate: ot.rate != null ? ot.rate : list.rate || null,
                techRiderOverride: ot.techRiderOverride != null ? ot.techRiderOverride : (list.techRiderOverride || (djP ? djP.techRider : '') || ''),
                soundcheckMinutes: ot.soundcheckMinutes != null ? ot.soundcheckMinutes : (list.soundcheckMinutes != null ? list.soundcheckMinutes : null),
                demoLinks: ot.demoLinks != null ? ot.demoLinks : (list.demoLinks || []) || [],
                cancelPolicy: ot.cancelPolicy || list.cancelPolicy || '',
                acceptedTicketModels: ot.acceptedTicketModels != null ? ot.acceptedTicketModels : (list.acceptedTicketModels || []) || [],
                decorPrice: ot.decorPrice != null ? ot.decorPrice : (list.price != null ? list.price : null),
                decorSetupFee: ot.decorSetupFee != null ? ot.decorSetupFee : (list.setupFee != null ? list.setupFee : null),
                decorDeposit: ot.decorDeposit != null ? ot.decorDeposit : (list.deposit != null ? list.deposit : null),
                decorDeliveryFee: ot.decorDeliveryFee != null ? ot.decorDeliveryFee : (list.deliveryFee != null ? list.deliveryFee : null),
                decorDeliveryIncluded: ot.decorDeliveryIncluded != null ? ot.decorDeliveryIncluded : !!(list.deliveryIncluded),
                decorDriveLinks: ot.decorDriveLinks != null ? ot.decorDriveLinks : (list.imagesDriveUrls || []) || [],
                venueEquipment: (venueP && venueP.equipment) ? venueP.equipment : []
            };
        }
        function computeDealEconomics(listing, owner, applicant, offerTerms) {
            var terms = offerTerms || {};
            var budget = terms.eventBudget != null ? terms.eventBudget : (listing && listing.budget != null ? parseInt(String(listing.budget).replace(/[^0-9]/g,''), 10) : 0);
            var mode = terms.ticketCutMode || (listing && listing.ticketCutMode) || 'percent';
            var pct = terms.ticketCutPercent != null ? terms.ticketCutPercent : (listing && listing.ticketCutPercent != null ? listing.ticketCutPercent : 0);
            var amtPerTicket = terms.ticketCutAmount != null ? terms.ticketCutAmount : (listing && listing.ticketCutAmount != null ? listing.ticketCutAmount : 0);
            var soldSim = 100;
            var venueShare = 0;
            if (mode === 'percent') venueShare = budget * (pct / 100);
            else if (mode === 'amount') venueShare = soldSim * amtPerTicket;
            else venueShare = budget * (pct / 100) + soldSim * amtPerTicket;
            var orgModel = terms.organizerFeeModel || (listing && listing.organizerFeeModel) || 'flat';
            var orgFlat = terms.organizerFee != null ? terms.organizerFee : (listing && listing.organizerFee != null ? listing.organizerFee : 0);
            var orgPctVal = terms.organizerFeePercent != null ? terms.organizerFeePercent : (listing && listing.organizerFeePercent != null ? listing.organizerFeePercent : 0);
            var orgFee = orgModel === 'percent' ? budget * (orgPctVal / 100) : orgModel === 'hybrid' ? orgFlat + budget * (orgPctVal / 100) : orgFlat;
            var djFee = terms.price != null ? Number(terms.price) : (listing && listing.rate && listing.rate.baseFee != null ? listing.rate.baseFee : 0);
            var decorCost = 0;
            if (listing && (listing.ownerRole === 'decorator' || (owner && owner.type === 'decorator') || (applicant && applicant.type === 'decorator'))) {
                var dp = terms.decorPrice != null ? terms.decorPrice : listing.price;
                var setup = terms.decorSetupFee != null ? terms.decorSetupFee : (listing.setupFee || 0);
                var dep = terms.decorDeposit != null ? terms.decorDeposit : (listing.deposit || 0);
                decorCost = (dp != null ? Number(dp) : 0) + (setup || 0) + (dep || 0);
            }
            var net = budget - venueShare - orgFee - djFee - decorCost;
            return { budget, venueShare, orgFee, djFee, decorCost, net };
        }
        function hasCompletedOnboarding(user) {
            const p = getProfile(user);
            if (!p) return false;
            if (user.type === 'dj') return !!p.genres && p.genres.length > 0;
            if (user.type === 'venue') return !!(p.venueName && p.city);
            if (user.type === 'organizer') return !!(p.organizerName && p.city);
            if (user.type === 'decorator') return !!(p.businessName || p.city);
            return false;
        }
        function clampBPM(v) { return Math.min(220, Math.max(60, parseInt(v, 10) || 0)); }

        // --- APP CONTROLLER ---
        // var kullanılıyor: TDZ (Temporal Dead Zone) yok, inline onclick global erişim garanti.
        // id="appRoot" olarak değiştirildi, DOM çakışması kaldırıldı.
        var app = window.app = {
            currentUser: null,
            _supabaseOffline: false,
            init: () => {
                try {
                    app.currentUser = Store.getCurrentUser ? Store.getCurrentUser() : null;
                    app.updateNav();
                    if (app.currentUser) {
                        if (!hasCompletedOnboarding(app.currentUser)) app.router('onboarding');
                        else app.router('dashboard');
                    } else {
                        app.router('home');
                    }
                } catch (err) {
                    console.error('App init error:', err);
                    var main = document.getElementById('appRoot');
                    if (main && typeof Views !== 'undefined' && Views.home) main.innerHTML = Views.home();
                    try { app.updateNav(); } catch (_) {}
                }
            },
            updateNav: () => {
                const nav = document.getElementById('navLinks');
                if (app.currentUser) {
                    const u = app.currentUser;
                    const off = app._supabaseOffline;
                    const roleLabel = u.type === 'dj' ? 'DJ' : u.type === 'venue' ? 'Mekan' : u.type === 'decorator' ? 'Dekorcu' : 'Organizatör';
                    nav.innerHTML = `
                        <span class="nav-role-badge text-gray-400 hidden sm:inline text-xs sm:text-sm">${roleLabel} <span class="text-gray-300">${u.name}</span></span>
                        <button type="button" onclick="app.router('dashboard')" class="nav-btn nav-btn-panel">Panel</button>
                        <button type="button" onclick="app.router('listings')" class="nav-btn nav-btn-listings">İlanlar</button>
                        ${u.type === 'dj' ? '<button type="button" onclick="app.router(\'logo-studio\')" class="nav-btn nav-btn-logo">Logo</button><button type="button" onclick="app.router(\'set-upload\')" class="nav-btn nav-btn-set">Set</button>' : ''}
                        <button type="button" onclick="if(app._supabaseOffline){ showToast('Sunucu bağlantısı yok.'); return; } app.router('listing-create')" class="nav-btn nav-btn-create ${off ? 'opacity-50 cursor-not-allowed' : ''}" ${off ? 'disabled title="Sunucu bağlantısı yok"' : ''}>İlan Aç</button>
                        <button type="button" onclick="app.router('match')" class="nav-btn nav-btn-match">Eşleşme</button>
                        <button type="button" onclick="app.router('calendar')" class="nav-btn nav-btn-reviews">Takvim</button>
                        <button type="button" onclick="app.router('messages')" class="nav-btn nav-btn-connections relative inline-flex items-center gap-1">Mesajlar${(function(){ var n = (typeof Messaging !== 'undefined' && Messaging.getUnreadTotal) ? (Messaging.getUnreadTotal(u.id) || 0) : 0; return n > 0 ? '<span class="rounded-full bg-red-500 text-white text-xs min-w-[18px] h-[18px] flex items-center justify-center">' + n + '</span>' : ''; })()}</button>
                        <button type="button" onclick="app.router('connections')" class="nav-btn nav-btn-connections">Bağlantılar</button>
                        <button type="button" onclick="app.router('reviews')" class="nav-btn nav-btn-reviews">Değerlendirme</button>
                        <button type="button" onclick="app.router('moderation')" class="nav-btn nav-btn-moderation">Moderasyon</button>
                        <button type="button" onclick="app.router('settings')" class="nav-btn nav-btn-settings">Ayarlar</button>
                        <button type="button" onclick="app.router('profile-edit')" class="nav-btn nav-btn-settings">Profilim</button>
                        <button type="button" onclick="app.logout()" class="nav-btn nav-btn-logout">Çık</button>`;
                } else {
                    nav.innerHTML = `<button type="button" onclick="app.router('register')" class="nav-btn nav-btn-listings">Üye ol</button><button type="button" onclick="app.router('login')" class="nav-btn nav-btn-panel">Giriş yap</button>`;
                }
            },
            logout: async () => {
                if (USE_SUPABASE && supabase) { await supabase.auth.signOut(); Store.logout(); app.currentUser = null; app.updateNav(); app.router('home'); return; }
                Store.logout(); window.location.reload();
            },
            _mapInstance: null,
            _routeParams: {},
            toggleMapMode: () => {
                var modal = document.getElementById('mapModal');
                if (!modal) return;
                var isHidden = modal.classList.contains('hidden');
                if (isHidden) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    if (typeof L !== 'undefined') {
                        var list = Store.get('listings');
                        var users = Store.get('users');
                        var cityCoords = { 'İstanbul': [41.0082, 28.9784], 'İzmir': [38.4192, 27.1287], 'Ankara': [39.9334, 32.8597], 'Antalya': [36.8969, 30.7133], 'Bursa': [40.1885, 29.0610], 'İzmit': [40.7654, 29.9408], 'Adana': [37.0000, 35.3213] };
                        var container = document.getElementById('leafletMap');
                        if (app._mapInstance) { app._mapInstance.remove(); app._mapInstance = null; }
                        container.innerHTML = '';
                        var map = L.map('leafletMap').setView([39, 32], 6);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
                        list.forEach(function(l) {
                            var lat = l.lat; var lng = l.lng;
                            if (lat == null || lng == null) {
                                var city = (l.city || '').trim();
                                var coords = cityCoords[city] || (city ? [39 + Math.random() * 2, 32 + Math.random() * 2] : null);
                                if (coords) { lat = coords[0]; lng = coords[1]; }
                            }
                            if (lat != null && lng != null) {
                                var owner = users.find(function(u) { return u.id === l.createdByUserId; });
                                var name = owner ? owner.name : '?';
                                L.marker([lat, lng]).addTo(map).bindPopup('<strong>' + (l.title || 'İlan') + '</strong><br>' + (l.city || '') + '<br>' + name);
                            }
                        });
                        app._mapInstance = map;
                    }
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            },
            router: (view, params, forceLeave) => {
                if (params != null) app._routeParams = params;
                if (!forceLeave && app._currentView === 'profile-edit' && (window._profileEditDirty === true)) {
                    app._pendingRoute = { view: view, params: params || app._routeParams };
                    var modal = document.getElementById('profileUnsavedModal');
                    if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
                    return;
                }
                const main = document.getElementById('appRoot');
                if (!main) return;
                main.innerHTML = '';
                const needAuth = ['dashboard','logo-studio','set-upload','listing-create','match','connections','reviews','moderation','settings','onboarding','listings','calendar','deal-room','deal-rooms','profile-edit','messages'];
                if (needAuth.includes(view) && !app.currentUser) return app.router('login');
                if (view === 'home') main.innerHTML = Views.home();
                else if (view === 'login') main.innerHTML = Views.login();
                else if (view === 'register') main.innerHTML = Views.register();
                else if (view === 'onboarding') main.innerHTML = Views.onboarding();
                else if (view === 'dashboard') main.innerHTML = Views.dashboard();
                else if (view === 'logo-studio') { main.innerHTML = Views.logoStudio(); LogoEngine.init(); }
                else if (view === 'set-upload') main.innerHTML = Views.setUpload();
                else if (view === 'listings') { main.innerHTML = Views.listings(); }
                else if (view === 'listing-create') main.innerHTML = Views.listingCreate();
                else if (view === 'match') main.innerHTML = Views.match();
                else if (view === 'connections') main.innerHTML = Views.connections();
                else if (view === 'reviews') main.innerHTML = Views.reviews();
                else if (view === 'moderation') main.innerHTML = Views.moderation();
                else if (view === 'settings') main.innerHTML = Views.settings();
                else if (view === 'calendar') main.innerHTML = Views.calendar();
                else if (view === 'deal-room') main.innerHTML = Views.dealRoom();
                else if (view === 'deal-rooms') main.innerHTML = Views.dealRooms();
                else if (view === 'profile-view') main.innerHTML = Views.profileView(app._routeParams.userId);
                else if (view === 'profile-edit') main.innerHTML = Views.profileEdit();
                else if (view === 'messages') main.innerHTML = Views.messages(app._routeParams.threadId);
                else main.innerHTML = Views.dashboard();
                app._currentView = view;
            }
        };

        // --- LOGO ENGINE (RENDER PIPELINE) ---
        const LogoEngine = {
            ctx: null,
            canvas: null,
            params: JSON.parse(JSON.stringify(Presets.minimal)), // Deep copy default
            
            init: () => {
                LogoEngine.canvas = document.getElementById('logoCanvas');
                LogoEngine.ctx = LogoEngine.canvas.getContext('2d');
                
                // Load last session if exists
                if(app.currentUser) {
                    const saved = Store.getObj(`logoParams:${app.currentUser.id}`);
                    if(saved) LogoEngine.params = saved;
                    else LogoEngine.params.text = app.currentUser.name;
                }
                
                // Set inputs based on params
                LogoEngine.syncInputs();
                LogoEngine.draw();
                // Yüklenen logo önizlemesi (profilde varsa)
                var p = getProfile(app.currentUser);
                if (p && p.logoDataUrl) {
                    var el = document.getElementById('uploadedLogoPreview');
                    var place = document.getElementById('uploadedLogoPreviewPlaceholder');
                    var removeBtn = document.getElementById('logoUploadRemoveBtn');
                    if (el) { el.src = p.logoDataUrl; el.classList.remove('hidden'); }
                    if (place) place.classList.add('hidden');
                    if (removeBtn) removeBtn.classList.remove('hidden');
                }
            },

            loadPreset: (key) => {
                const text = document.getElementById('param_text').value;
                const tagline = document.getElementById('param_tagline').value;
                
                // Merge preset with current text
                LogoEngine.params = JSON.parse(JSON.stringify(Presets[key]));
                LogoEngine.params.text = text;
                LogoEngine.params.tagline = tagline;
                
                LogoEngine.syncInputs();
                LogoEngine.draw();
            },

            syncInputs: () => {
                // Recursive function to set input values from params object
                const traverse = (obj, prefix = 'param') => {
                    for (const [key, value] of Object.entries(obj)) {
                        if (typeof value === 'object' && value !== null) {
                            traverse(value, `${prefix}_${key}`);
                        } else {
                            const el = document.getElementById(`${prefix}_${key}`);
                            if(el) {
                                if(el.type === 'checkbox') el.checked = value;
                                else el.value = value;
                                // Update span label if exists
                                const span = document.getElementById(`${prefix}_${key}_val`);
                                if(span) span.innerText = value;
                            }
                        }
                    }
                };
                traverse(LogoEngine.params);
                // Custom fields
                document.getElementById('param_text').value = LogoEngine.params.text || app.currentUser.name;
            },

            updateParam: (path, value) => {
                const keys = path.split('.');
                let ref = LogoEngine.params;
                for(let i=0; i<keys.length-1; i++) ref = ref[keys[i]];
                
                // Type conversion
                if(typeof ref[keys[keys.length-1]] === 'number') value = parseFloat(value);
                if(value === 'true') value = true;
                if(value === 'false') value = false;
                
                ref[keys[keys.length-1]] = value;
                
                // Save & Draw
                Store.setObj(`logoParams:${app.currentUser.id}`, LogoEngine.params);
                LogoEngine.draw();
            },

            // --- DRAWING PIPELINE ---
            draw: () => {
                const cvs = LogoEngine.canvas;
                const ctx = LogoEngine.ctx;
                const p = LogoEngine.params;
                const W = cvs.width;
                const H = cvs.height;
                const CX = W/2;
                const CY = H/2;

                // 1. Clear & Background Layer
                ctx.clearRect(0,0,W,H);
                
                if(p.background.type === 'solid') {
                    ctx.fillStyle = p.background.color;
                    ctx.fillRect(0,0,W,H);
                } else if(p.background.type === 'nebula') {
                    const grd = ctx.createRadialGradient(CX, CY, 0, CX, CY, W);
                    grd.addColorStop(0, p.background.color);
                    grd.addColorStop(1, '#000000');
                    ctx.fillStyle = grd;
                    ctx.fillRect(0,0,W,H);
                    // Stars
                    for(let i=0; i<100; i++) {
                        ctx.fillStyle = `rgba(255,255,255,${Math.random() * (p.background.opacity/100)})`;
                        ctx.beginPath();
                        ctx.arc(Math.random()*W, Math.random()*H, Math.random()*2, 0, Math.PI*2);
                        ctx.fill();
                    }
                } else if(p.background.type === 'grid') {
                    ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);
                    ctx.strokeStyle = p.color.primary;
                    ctx.lineWidth = 1;
                    ctx.globalAlpha = 0.2;
                    // Floor grid simulation
                    for(let i=0; i<W; i+=50) {
                        ctx.beginPath(); ctx.moveTo(i, CY); ctx.lineTo((i-CX)*3 + CX, H); ctx.stroke();
                    }
                    for(let i=CY; i<H; i+=40) {
                        ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(W, i); ctx.stroke();
                    }
                    ctx.globalAlpha = 1;
                }

                ctx.save();
                
                // Perspective Transformation (Fake 3D Tilt)
                if(p.layout.perspective !== 0) {
                    ctx.translate(CX, CY);
                    // Simple skew based on perspective
                    ctx.transform(1, 0, p.layout.perspective/100, 1, 0, 0);
                    ctx.translate(-CX, -CY);
                }

                // 2. Content Layout Calculation
                const iconSize = p.layout.iconScale * 2;
                const textSize = p.layout.textScale;
                const gap = p.layout.spacing;
                let textY = CY;
                let iconY = CY;

                if(p.layout.preset === 'stacked') {
                    iconY = CY - (textSize/2) - (gap/2);
                    textY = CY + (iconSize/2) + (gap/2);
                } else if (p.layout.preset === 'inline') {
                    // Simplified inline for prototype
                    iconY = CY; textY = CY;
                }

                // 3. Render Loop (Shadow -> Extrude -> Main -> Shine)
                const renderPass = (layer) => {
                    const isExtrude = layer === 'extrude';
                    const isShadow = layer === 'shadow';
                    
                    if(isShadow) {
                        ctx.shadowColor = 'rgba(0,0,0,0.8)';
                        ctx.shadowBlur = p.material.ao;
                        ctx.fillStyle = 'black';
                    } else if (isExtrude) {
                        ctx.shadowBlur = 0;
                        const depth = p.material.extrude;
                        if(depth > 0) {
                            for(let i=depth; i>0; i--) {
                                ctx.fillStyle = adjustColor(p.color.primary, -40); // Darker side
                                LogoEngine.drawShape(ctx, CX+i, iconY+i, iconSize, p);
                                LogoEngine.drawText(ctx, CX+i, textY+i, textSize, p);
                            }
                        }
                    } else {
                        // Main Fill
                        ctx.shadowBlur = 0;
                        
                        // Gradient Generation
                        let fill;
                        if(p.color.gradient === 'linear') {
                            const grd = ctx.createLinearGradient(0, 0, W, H);
                            grd.addColorStop(0, p.color.primary);
                            grd.addColorStop(1, p.color.secondary);
                            fill = grd;
                        } else {
                            fill = p.color.primary;
                        }
                        ctx.fillStyle = fill;
                        
                        // Bevel Effect (Stroke)
                        if(p.material.bevel > 0) {
                            ctx.strokeStyle = p.color.secondary;
                            ctx.lineWidth = p.material.bevel;
                            ctx.lineJoin = 'round';
                        }
                    }

                    if(!isExtrude) {
                        LogoEngine.drawShape(ctx, CX, iconY, iconSize, p, layer);
                        LogoEngine.drawText(ctx, CX, textY, textSize, p, layer);
                    }
                };

                // Exec Render Passes
                renderPass('shadow');
                renderPass('extrude');
                renderPass('base');

                // 4. FX & Post-Processing
                ctx.restore(); // Reset transform for FX

                // Scanlines
                if(p.fx.scanlines) {
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    for(let i=0; i<H; i+=4) ctx.fillRect(0,i,W,2);
                }

                // Vignette
                if(p.fx.vignette > 0) {
                    const grd = ctx.createRadialGradient(CX, CY, W/3, CX, CY, W);
                    grd.addColorStop(0, 'rgba(0,0,0,0)');
                    grd.addColorStop(1, `rgba(0,0,0,${p.fx.vignette/100})`);
                    ctx.fillStyle = grd;
                    ctx.fillRect(0,0,W,H);
                }

                // Glitch
                if(p.fx.glitch > 0) {
                    const slices = 5;
                    const maxOffset = p.fx.glitch;
                    for(let i=0; i<slices; i++) {
                        const h = Math.random() * 50;
                        const y = Math.random() * H;
                        const offset = (Math.random() - 0.5) * maxOffset * 2;
                        // Use drawImage to slice itself (simulated here with color rects for perf)
                        ctx.fillStyle = `rgba(${Math.random()*255},${Math.random()*255},255,0.1)`;
                        ctx.fillRect(0, y, W, h);
                    }
                }

                // Lens Flare
                if(p.fx.flare && p.icon.coreType !== 'none') {
                    // Draw flare on icon center
                    const flareX = CX; 
                    const flareY = iconY;
                    const grad = ctx.createRadialGradient(flareX, flareY, 0, flareX, flareY, 150);
                    grad.addColorStop(0, 'rgba(255,255,255,0.8)');
                    grad.addColorStop(0.2, p.color.primary);
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.globalCompositeOperation = 'screen';
                    ctx.fillStyle = grad;
                    ctx.fillRect(0,0,W,H);
                    
                    // Anamorphic streak
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    ctx.fillRect(0, flareY-2, W, 4);
                    ctx.globalCompositeOperation = 'source-over';
                }
            },

            drawShape: (ctx, x, y, size, p, layer) => {
                if(p.icon.preset === 'none') return;
                
                ctx.beginPath();
                const r = size / 2;

                if(p.icon.preset === 'sigil1') {
                    // Ç Form
                    ctx.moveTo(x + r*0.5, y - r*0.5);
                    ctx.arc(x, y, r*0.7, -Math.PI/4, Math.PI*1.25, true);
                    ctx.lineTo(x + r*0.5, y + r*0.5);
                    // Çengel
                    ctx.moveTo(x, y+r*0.7);
                    ctx.lineTo(x, y+r);
                    ctx.lineTo(x-r*0.2, y+r*0.9);
                } else if(p.icon.preset === 'dna') {
                    // DNA Helix Simulation
                    ctx.moveTo(x-r, y);
                    for(let i=-r; i<r; i+=5) {
                        ctx.lineTo(x+i, y + Math.sin(i/20)*r*0.5);
                    }
                    ctx.moveTo(x-r, y);
                    for(let i=-r; i<r; i+=5) {
                        ctx.lineTo(x+i, y - Math.sin(i/20)*r*0.5);
                    }
                } else if(p.icon.preset === 'ring') {
                    ctx.arc(x, y, r, 0, Math.PI*2);
                    ctx.moveTo(x+r*0.7, y);
                    ctx.arc(x, y, r*0.7, 0, Math.PI*2, true);
                }

                // Fill/Stroke based on layer
                if(layer === 'base' || layer === 'extrude' || layer === 'shadow') {
                    if(p.icon.stroke > 0) {
                        ctx.lineWidth = p.icon.stroke;
                        ctx.stroke();
                    } else {
                        ctx.fill();
                    }
                }

                // Render Core (Only on base layer)
                if(layer === 'base' && p.icon.coreType !== 'none') {
                    ctx.save();
                    ctx.fillStyle = p.color.secondary;
                    ctx.shadowColor = p.color.primary;
                    ctx.shadowBlur = p.icon.coreGlow;
                    ctx.beginPath();
                    if(p.icon.coreType === 'dot') ctx.arc(x, y, p.icon.coreSize/2, 0, Math.PI*2);
                    else if(p.icon.coreType === 'gem') {
                        ctx.rect(x - p.icon.coreSize/2, y-p.icon.coreSize/2, p.icon.coreSize, p.icon.coreSize);
                        ctx.rotate(Math.PI/4);
                    }
                    ctx.fill();
                    ctx.restore();
                }
            },

            drawText: (ctx, x, y, size, p, layer) => {
                const text = p.text || 'DJ NAME';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Typography setup
                const fontSize = size;
                const weight = p.typography.weight;
                const font = p.typography.font;
                const slant = p.typography.slant > 0 ? 'italic' : '';
                ctx.font = `${slant} ${weight} ${fontSize}px "${font}"`;
                
                // Tracking (Letter spacing via custom draw)
                const tracking = p.typography.tracking;
                
                if(tracking === 0) {
                    if(layer === 'base' && p.typography.stroke > 0) {
                        ctx.lineWidth = p.typography.stroke;
                        ctx.strokeText(text, x, y);
                    }
                    ctx.fillText(text, x, y);
                } else {
                    // Manual letter spacing
                    const chars = text.split('');
                    const totalWidth = ctx.measureText(text).width + (chars.length-1)*tracking;
                    let startX = x - totalWidth/2;
                    chars.forEach(char => {
                        if(layer === 'base' && p.typography.stroke > 0) ctx.strokeText(char, startX, y);
                        ctx.fillText(char, startX, y);
                        startX += ctx.measureText(char).width + tracking;
                    });
                }
                
                // Sublines for Poster Mode
                if(p.layout.preset === 'poster' && p.tagline && layer === 'base') {
                    ctx.font = `300 ${fontSize*0.3}px "Inter"`;
                    ctx.letterSpacing = '5px';
                    ctx.fillStyle = '#aaa';
                    ctx.fillText(p.tagline.toUpperCase(), x, y + fontSize);
                    
                    // Poster Details
                    ctx.font = `600 ${fontSize*0.2}px "Inter"`;
                    ctx.fillStyle = p.color.primary;
                    ctx.fillText("7 MART 2026 • THE HIVE", x, y - fontSize);
                    
                    // Separator
                    ctx.beginPath();
                    ctx.moveTo(x - 100, y + fontSize + 20);
                    ctx.lineTo(x + 100, y + fontSize + 20);
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }
        };

        // Helper: Hex Color adjustment
        function adjustColor(color, amount) {
            return color; // Simplified for prototype, would use RGB math
        }

        // --- VIEWS ---
        const Views = {
            home: () => `
                <div class="h-full flex items-center justify-center bg-gradient-to-b from-[#0a0a0b] via-[#1a0a1a] to-[#0a0a0b] bg-cover bg-center p-4 sm:p-6">
                    <div class="glass-panel p-6 sm:p-8 rounded-2xl w-full max-w-md backdrop-blur-xl text-center border border-gray-800">
                        <h2 class="text-3xl font-display font-bold mb-1 text-white">CoreMind</h2>
                        <p class="text-sm mb-4 text-[#c084ff]" style="text-shadow: 0 0 14px rgba(192,132,252,0.9);">Akıl · Yaratım</p>
                        <p class="text-gray-500 text-xs mb-2">DJ · Mekan · Organizatör Eşleşme Platformu</p>
                        <p class="text-gray-600 text-xs mb-6">Platforma erişim için üye olun veya giriş yapın.</p>
                        <button onclick="app.router('login')" class="w-full bg-brand-accent hover:bg-violet-600 text-white font-bold py-3 rounded transition mb-3">GİRİŞ YAP</button>
                        <button onclick="app.router('register')" class="w-full border border-gray-600 text-gray-400 py-3 rounded hover:bg-gray-800/80 transition">ÜYE OL</button>
                        <p class="text-xs text-gray-600 mt-4">DJ, Mekan sahibi veya Organizatör olarak üye olabilirsiniz.</p>
                    </div>
                </div>`,

            login: () => `
                <div class="h-full flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1574169208507-84376144848b?q=80&w=2000')] bg-cover bg-center p-4 sm:p-6">
                    <div class="glass-panel p-6 sm:p-8 rounded-2xl w-full max-w-md backdrop-blur-xl">
                        <h2 class="text-3xl font-display font-bold mb-2 text-center">ÜYELİK GİRİŞİ</h2>
                        <p class="text-gray-400 text-sm text-center mb-6">Üye hesabınızla giriş yapın</p>
                        <form id="loginForm" onsubmit="return false;">
                            <input type="email" id="loginEmail" class="w-full bg-black/50 border border-gray-700 rounded p-3 mb-4 text-white placeholder-gray-500" placeholder="Email" required>
                            <input type="password" id="loginPass" class="w-full bg-black/50 border border-gray-700 rounded p-3 mb-4 text-white placeholder-gray-500" placeholder="Şifre" required>
                            <button type="submit" class="w-full bg-brand-accent hover:bg-violet-600 text-white font-bold py-3 rounded transition">GİRİŞ YAP</button>
                        </form>
                        <p class="text-center text-sm text-gray-500 mt-4"><a href="#" onclick="app.router('register'); return false;">Üyeliğim yok, üye ol</a></p>
                    </div>
                </div>`,

            register: () => `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-lg mx-auto">
                        <h2 class="text-2xl font-display font-bold mb-2 text-center">ÜYE OL</h2>
                        <p class="text-gray-400 text-sm mb-4 text-center">Üyelik türünü seçin: <strong class="text-white">DJ</strong>, <strong class="text-white">Mekan sahibi</strong> veya <strong class="text-white">Organizatör</strong>. Sonradan değiştirilemez.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <button type="button" onclick="Views.setRegisterRole('dj')" id="regRoleDj" class="reg-role p-4 rounded-xl border-2 border-gray-700 hover:border-brand-glow bg-gray-900/50 transition flex flex-col items-center gap-2">
                                <i class="fa-solid fa-compact-disc text-2xl text-brand-glow"></i>
                                <span class="font-bold">DJ</span>
                                <span class="text-xs text-gray-500">Sanatçı · Set · Logo</span>
                            </button>
                            <button type="button" onclick="Views.setRegisterRole('venue')" id="regRoleVenue" class="reg-role p-4 rounded-xl border-2 border-gray-700 hover:border-brand-accent bg-gray-900/50 transition flex flex-col items-center gap-2">
                                <i class="fa-solid fa-building text-2xl text-brand-accent"></i>
                                <span class="font-bold">Mekan</span>
                                <span class="text-xs text-gray-500">Mekan sahibi</span>
                            </button>
                            <button type="button" onclick="Views.setRegisterRole('organizer')" id="regRoleOrganizer" class="reg-role p-4 rounded-xl border-2 border-gray-700 hover:border-brand-acid bg-gray-900/50 transition flex flex-col items-center gap-2">
                                <i class="fa-solid fa-users text-2xl text-brand-acid"></i>
                                <span class="font-bold">Organizatör</span>
                                <span class="text-xs text-gray-500">Etkinlik · Bağlantı</span>
                            </button>
                            <button type="button" onclick="Views.setRegisterRole('decorator')" id="regRoleDecorator" class="reg-role p-4 rounded-xl border-2 border-gray-700 hover:border-gray-500 bg-gray-900/50 transition flex flex-col items-center gap-2">
                                <i class="fa-solid fa-palette text-2xl text-gray-400"></i>
                                <span class="font-bold">Dekorcu</span>
                                <span class="text-xs text-gray-500">Dekor kiralama · Görseller</span>
                            </button>
                        </div>
                        <form id="registerForm" onsubmit="return false;" class="space-y-4">
                            <input type="text" id="regName" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Sahne adı (DJ) / Mekan adı / İsim (Organizatör)" required>
                            <input type="email" id="regEmail" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Email" required>
                            <input type="password" id="regPass" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Şifre" required>
                            <input type="text" id="regLocation" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Şehir (opsiyonel)">
                            <button type="submit" class="w-full bg-brand-accent hover:bg-violet-600 text-white font-bold py-3 rounded transition">ÜYELİK OLUŞTUR</button>
                        </form>
                        <p class="text-center text-sm text-gray-500 mt-4"><a href="#" onclick="app.router('login'); return false;">Zaten üyeyim, giriş yap</a></p>
                    </div>
                </div>`,

            setRegisterRole: (role) => {
                document.querySelectorAll('.reg-role').forEach(el => { el.classList.remove('border-brand-accent', 'border-gray-500'); el.classList.add('border-gray-700'); });
                const id = role === 'dj' ? 'regRoleDj' : role === 'venue' ? 'regRoleVenue' : role === 'organizer' ? 'regRoleOrganizer' : 'regRoleDecorator';
                const el = document.getElementById(id);
                if (el) { el.classList.remove('border-gray-700'); el.classList.add(role === 'decorator' ? 'border-gray-500' : 'border-brand-accent'); }
                window._registerRole = role;
            },

            onboarding: () => {
                const u = app.currentUser;
                if (!u) return Views.login();
                const type = u.type;
                if (type === 'dj') {
                    const p = getProfile(u) || { genres: [], bpmMin: 120, bpmMax: 130, nightlyFee: 0, bio: '', techRider: '', equipmentProvided: [], soundcloudEmbed: '', spotifyEmbed: '', mixcloudEmbed: '', minNoticeDays: null, travelRadiusKm: null };
                    const eqProvided = Array.isArray(p.equipmentProvided) ? p.equipmentProvided.join('\n') : (p.equipmentProvided || '');
                    return `
                    <div class="h-full overflow-y-auto page-content">
                        <div class="max-w-lg mx-auto">
                            <h2 class="text-2xl font-display font-bold mb-2">DJ Profilini Tamamla</h2>
                            <p class="text-gray-400 text-sm mb-6">Tarzlar, BPM, tech rider ve müzik örnekleri.</p>
                            <form id="onboardDjForm" onsubmit="return false;" class="space-y-4">
                                <label class="block text-sm text-gray-400">Tarzlar (en az bir)</label>
                                <div class="flex flex-wrap gap-2">${GENRES.map(g => `<label class="flex items-center gap-2"><input type="checkbox" name="genre" value="${g}" ${(p.genres||[]).includes(g)?'checked':''}> <span class="text-sm">${g}</span></label>`).join('')}</div>
                                <div><label class="block text-sm text-gray-400 mb-1">BPM Min</label><input type="number" id="obBpmMin" min="60" max="220" value="${p.bpmMin||120}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">BPM Max</label><input type="number" id="obBpmMax" min="60" max="220" value="${p.bpmMax||130}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Gecelik ücret (TL)</label><input type="number" id="obFee" min="0" value="${p.nightlyFee||0}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Bio</label><textarea id="obBio" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-20" placeholder="Kısa tanıtım">${p.bio||''}</textarea></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Tech Rider <span class="text-gray-500">(beklediğiniz / sağlamak istediğiniz ekipman, satır satır)</span></label><textarea id="obTechRider" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-24" placeholder="Örn: 2x Pioneer CDJ-3000, 1x DJM-900NXS2">${p.techRider||''}</textarea></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Getirdiğiniz ekipman <span class="text-gray-500">(satır satır)</span></label><textarea id="obEquipmentProvided" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Boş bırakabilirsiniz">${eqProvided}</textarea></div>
                                <div><label class="block text-sm text-gray-400 mb-1">SoundCloud embed URL</label><input type="text" id="obSoundcloud" value="${p.soundcloudEmbed||''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="https://soundcloud.com/..."></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Spotify embed URL</label><input type="text" id="obSpotify" value="${p.spotifyEmbed||''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="https://open.spotify.com/embed/..."></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Min. kaç gün önceden teklif</label><input type="number" id="obMinNotice" min="0" value="${p.minNoticeDays!=null?p.minNoticeDays:''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Opsiyonel"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Seyahat edebileceğim max mesafe (km)</label><input type="number" id="obTravelKm" min="0" value="${p.travelRadiusKm!=null?p.travelRadiusKm:''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Opsiyonel"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Google Drive portföy linki</label><input type="url" id="obGoogleDrive" value="${(p.googleDriveLink || '')}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="https://drive.google.com/..."></div>
                                <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded">KAYDET VE DEVAM</button>
                            </form>
                        </div>
                    </div>`;
                }
                if (type === 'venue') {
                    const p = getProfile(u) || {};
                    const eqList = Array.isArray(p.equipment) ? p.equipment.join('\n') : (p.equipment || '');
                    return `
                    <div class="h-full overflow-y-auto page-content">
                        <div class="max-w-lg mx-auto">
                            <h2 class="text-2xl font-display font-bold mb-2">Mekan Profilini Tamamla</h2>
                            <p class="text-gray-400 text-sm mb-4">Ekipman, bilet politikası ve kesim oranlarını belirtin.</p>
                            <form id="onboardVenueForm" onsubmit="return false;" class="space-y-4">
                                <input type="text" id="obVenueName" value="${escapeHtml(p.venueName||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Mekan adı" required>
                                <input type="text" id="obCity" value="${escapeHtml(p.city||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Şehir" required>
                                <input type="text" id="obAddress" value="${escapeHtml(p.address||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Açık adres (opsiyonel)">
                                <input type="number" id="obCapacity" value="${p.capacity||''}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Kapasite (opsiyonel)">
                                <label class="block text-sm text-gray-400">Tarzlar</label>
                                <div class="flex flex-wrap gap-2">${GENRES.map(g => `<label class="flex items-center gap-2"><input type="checkbox" name="vGenre" value="${g}" ${(p.typicalGenres||[]).includes(g)?'checked':''}> <span class="text-sm">${g}</span></label>`).join('')}</div>
                                <input type="text" id="obBudget" value="${escapeHtml(p.budgetRange||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Bütçe aralığı (örn: 1000-5000 TL)">
                                <div><label class="block text-sm text-gray-400 mb-1">Mekandaki ekipman <span class="text-gray-500">(satır satır)</span></label><textarea id="obEquipment" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-20" placeholder="Örn: 2x CDJ-3000, DJM-900">${escapeHtml(eqList)}</textarea></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Bilet fiyatlandırma politikası</label><textarea id="obTicketPolicy" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Bilet fiyatı ve politikası">${escapeHtml(p.ticketPricePolicy||'')}</textarea></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Talep edilen bilet kesim yüzdesi (%)</label><input type="number" id="obTicketCutPct" min="0" max="100" step="0.5" value="${p.ticketCutPercent!=null?p.ticketCutPercent:''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Örn: 15"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Veya sabit bilet kesim tutarı (TL)</label><input type="number" id="obTicketCutAmt" min="0" value="${p.ticketCutAmount!=null?p.ticketCutAmount:''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Opsiyonel"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Diğer yüzde politikaları (kapora, iptal vb.)</label><textarea id="obPctPolicies" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Metin olarak yazın">${escapeHtml(p.percentagePolicies||'')}</textarea></div>
                                <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded">KAYDET VE DEVAM</button>
                            </form>
                        </div>
                    </div>`;
                }
                if (type === 'organizer') {
                    const p = getProfile(u) || {};
                    const reqList = Array.isArray(p.requirements) ? p.requirements.join('\n') : (p.requirements || '');
                    return `
                    <div class="h-full overflow-y-auto page-content">
                        <div class="max-w-lg mx-auto">
                            <h2 class="text-2xl font-display font-bold mb-2">Organizatör Profilini Tamamla</h2>
                            <p class="text-gray-400 text-sm mb-4">Organizasyon ücreti ve gereksinimlerinizi belirtin.</p>
                            <form id="onboardOrgForm" onsubmit="return false;" class="space-y-4">
                                <input type="text" id="obOrgName" value="${escapeHtml(p.organizerName||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="İsim / Marka" required>
                                <input type="text" id="obOrgCity" value="${escapeHtml(p.city||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Şehir" required>
                                <input type="text" id="obOrgPhone" value="${escapeHtml(p.contactPhone||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="İletişim telefonu">
                                <input type="text" id="obNetworkTags" value="${escapeHtml((p.networkTags||[]).join(', '))}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Ağ etiketleri (virgülle ayır)">
                                <div><label class="block text-sm text-gray-400 mb-1">Organizasyon ücreti (TL)</label><input type="number" id="obOrgFee" min="0" value="${p.organizationFee!=null?p.organizationFee:''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Sabit ücret"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Veya organizasyon ücreti yüzdesi (%)</label><input type="number" id="obOrgFeePct" min="0" max="100" step="0.5" value="${p.organizationFeePercent!=null?p.organizationFeePercent:''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Örn: 10"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Gereksinimler <span class="text-gray-500">(madde madde, satır satır)</span></label><textarea id="obRequirements" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-24" placeholder="Örn: Ses sistemi sağlanacak, bilet satışı mekanda">${escapeHtml(reqList)}</textarea></div>
                                <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded">KAYDET VE DEVAM</button>
                            </form>
                        </div>
                    </div>`;
                }
                if (type === 'decorator') {
                    const p = getProfile(u) || {};
                    return `
                    <div class="h-full overflow-y-auto page-content">
                        <div class="max-w-lg mx-auto">
                            <h2 class="text-2xl font-display font-bold mb-2">Dekorcu Profilini Tamamla</h2>
                            <p class="text-gray-400 text-sm mb-4">İşletme adı ve şehir. Görselleri ilan açarken Drive linkleriyle ekleyeceksiniz.</p>
                            <form id="onboardDecorForm" onsubmit="return false;" class="space-y-4">
                                <input type="text" id="obDecorBusiness" value="${escapeHtml(p.businessName||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="İşletme / marka adı">
                                <input type="text" id="obDecorCity" value="${escapeHtml(p.city||'')}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Şehir" required>
                                <input type="number" id="obDecorArea" min="0" value="${p.serviceAreaKm!=null?p.serviceAreaKm:''}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Servis alanı (km, opsiyonel)">
                                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded">KAYDET VE DEVAM</button>
                            </form>
                        </div>
                    </div>`;
                }
                return Views.dashboard();
            },

            dashboard: () => {
                const u = app.currentUser;
                const p = getProfile(u);
                const listings = Store.get('listings');
                const myListings = listings.filter(l => String(l.createdByUserId) === String(u.id));
                const roleLabel = u.type === 'dj' ? 'DJ' : u.type === 'venue' ? 'Mekan sahibi' : u.type === 'decorator' ? 'Dekorcu' : 'Organizatör';
                const roleDesc = u.type === 'dj' ? 'Logo tasarla, set yükle, ilanlara başvur.' : u.type === 'venue' ? 'İhtiyaç ilanı aç, DJ bul, eşleş.' : u.type === 'decorator' ? 'Dekor kiralama ilanı aç, Drive görselleri ekle.' : 'Etkinlik ilanı aç, tanıdık bildir, eşleş.';
                const drivePortfolioLink = (u.type === 'dj' && p && p.googleDriveLink) ? `<p class="text-sm mb-4"><a href="${String(p.googleDriveLink).replace(/"/g, '&quot;')}" target="_blank" rel="noopener noreferrer" class="text-brand-glow hover:underline inline-flex items-center gap-1"><i class="fa-brands fa-google-drive"></i> Google Drive portföyüm</a></p>` : '';
                const dashSocial = '';
                const xp = u.xp != null ? u.xp : 0;
                const level = u.level != null ? u.level : 1;
                const badges = Array.isArray(u.badges) ? u.badges : [];
                const badgeLabels = { '5_gigs': '5 Gig', '10_gigs': '10 Gig', 'verified_dj': 'Onaylı DJ', 'verified_venue': 'Onaylı Mekan', 'fast_responder': 'Hızlı Yanıt', 'first_offer': 'İlk Teklif', 'top_rated': 'Yüksek Puan' };
                const xpBadgeBlock = '<p class="text-xs text-gray-500 mb-2"><span class="text-brand-glow font-bold">' + xp + ' XP</span> · Seviye ' + level + (badges.length ? ' · ' + badges.map(function(b){ return badgeLabels[b] || b; }).join(', ') : '') + '</p>';
                return `
                <div class="h-full overflow-y-auto flex flex-col">
                    <div class="page-shell flex-1">
                        <header class="mb-4 text-left">
                            <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${u.type === 'dj' ? 'bg-brand-glow/20 text-brand-glow' : u.type === 'venue' ? 'bg-brand-accent/20 text-brand-accent' : u.type === 'decorator' ? 'bg-amber-500/20 text-amber-400' : 'bg-brand-acid/20 text-brand-acid'}">${roleLabel}</span>
                                <h1 class="text-xl sm:text-2xl font-display font-bold">Hoş geldin, ${u.name}</h1>
                            </div>
                            <p class="text-gray-400 text-sm mb-2">${roleDesc}</p>
                            ${drivePortfolioLink}
                            ${dashSocial}
                            ${xpBadgeBlock}
                        </header>
                        <section class="dashboard-grid mb-8">
                            <button onclick="app.router('listings')" class="dashboard-card hover:border-brand-accent">
                                <i class="fa-solid fa-list text-2xl text-brand-glow mb-2"></i>
                                <div><div class="font-bold">İlanlar</div><div class="text-sm text-gray-500">${listings.length} ilan</div></div>
                            </button>
                            ${u.type === 'dj' ? `
                            <button onclick="app.router('logo-studio')" class="dashboard-card hover:border-brand-accent">
                                <i class="fa-solid fa-palette text-2xl text-brand-accent mb-2"></i>
                                <div><div class="font-bold">Logo Studio</div><div class="text-sm text-gray-500">Logo tasarla</div></div>
                            </button>
                            <button onclick="app.router('set-upload')" class="dashboard-card hover:border-brand-accent">
                                <i class="fa-solid fa-upload text-2xl text-brand-acid mb-2"></i>
                                <div><div class="font-bold">Set Yükle</div><div class="text-sm text-gray-500">Portföy ekle</div></div>
                            </button>
                            ` : ''}
                            <button onclick="if(app._supabaseOffline){ showToast('Sunucu bağlantısı yok.'); return; } app.router('listing-create')" class="dashboard-card hover:border-brand-accent ${app._supabaseOffline ? 'opacity-50 cursor-not-allowed' : ''}" ${app._supabaseOffline ? 'disabled title="Sunucu bağlantısı yok"' : ''}>
                                <i class="fa-solid fa-plus text-2xl text-brand-glow mb-2"></i>
                                <div><div class="font-bold">İlan Aç</div><div class="text-sm text-gray-500">${myListings.length} ilanın var</div></div>
                            </button>
                            <button onclick="app.router('match')" class="dashboard-card hover:border-brand-accent">
                                <i class="fa-solid fa-heart text-2xl text-brand-danger mb-2"></i>
                                <div><div class="font-bold">Eşleşme</div><div class="text-sm text-gray-500">Öneriler</div></div>
                            </button>
                            <button onclick="app.router('deal-rooms')" class="dashboard-card hover:border-amber-500/50">
                                <i class="fa-solid fa-comments text-2xl text-amber-400 mb-2"></i>
                                <div><div class="font-bold">Teklif odalarım</div><div class="text-sm text-gray-500">${(Store.get('dealRooms') || []).filter(r => String(r.applicantUserId) === String(u.id) || String(r.listingOwnerUserId) === String(u.id)).length} oda</div></div>
                            </button>
                            <button onclick="app.router('profile-edit')" class="dashboard-card hover:border-brand-glow/50">
                                <i class="fa-solid fa-user-circle text-2xl text-brand-glow mb-2"></i>
                                <div><div class="font-bold">Profilim</div><div class="text-sm text-gray-500">${(function(){ var f = getFullProfile(u.id); return f.completenessScore + '% tamamlandı'; })()}</div></div>
                            </button>
                            <button onclick="app.router('connections')" class="dashboard-card hover:border-brand-accent">
                                <i class="fa-solid fa-link text-2xl text-brand-accent mb-2"></i>
                                <div><div class="font-bold">Bağlantılar</div><div class="text-sm text-gray-500">Tanıdık bildirimi</div></div>
                            </button>
                            <button type="button" onclick="ContractAPI.downloadDraft()" class="dashboard-card hover:border-amber-500/50">
                                <i class="fa-solid fa-file-contract text-2xl text-amber-400 mb-2"></i>
                                <div><div class="font-bold">Sözleşme taslağı</div><div class="text-sm text-gray-500">DOCX indir</div></div>
                            </button>
                        </section>
                        <div class="text-center text-sm text-gray-500 pt-2 pb-4">${listings.length} ilan · ${(Store.get('dealRooms') || []).filter(r => String(r.applicantUserId) === String(u.id) || String(r.listingOwnerUserId) === String(u.id)).length} teklif odası</div>
                    </div>
                </div>`;
            },

            setUpload: () => {
                const uploads = Store.get('setUploads').filter(s => s.djUserId === app.currentUser.id);
                const setItemHtml = (s) => {
                    const driveUrl = (s.driveUrl || '').trim();
                    const driveLink = driveUrl ? `<a href="${driveUrl.replace(/"/g, '&quot;')}" target="_blank" rel="noopener noreferrer" class="text-brand-glow hover:underline text-sm inline-flex items-center gap-1"><i class="fa-brands fa-google-drive"></i> Drive'da dinle</a>` : '<span class="text-gray-500 text-sm">Link yok</span>';
                    return `<li class="p-3 rounded border border-gray-800 flex flex-wrap justify-between items-center gap-2"><div class="min-w-0"><span class="font-medium">${escapeHtml(s.title)}</span> — ${s.duration} dk</div><div class="flex items-center gap-3 flex-shrink-0">${driveLink}<button type="button" onclick="SetUploadAPI.remove(${s.id})" class="text-red-500 text-sm hover:underline">Sil</button></div></li>`;
                };
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-display font-bold mb-2">Set Yükle (Portföy)</h2>
                        <p class="text-gray-400 text-sm mb-4">1 saatlik seti Google Drive'a yükleyip buraya linkini ekle; portföyün olarak sergilensin.</p>
                        <div class="rounded-xl border border-brand-accent/40 bg-brand-accent/5 p-4 mb-6 text-sm text-gray-300">
                            <strong class="text-brand-glow">Google Drive:</strong> Set dosyanı (veya klasörünü) Drive'da paylaşıma aç, "Bağlantıyı kopyala" ile linki alıp aşağıya yapıştır. Dinleyenler bu linkten setine ulaşır.
                        </div>
                        <form id="setUploadForm" onsubmit="return false;" class="space-y-4 mb-8">
                            <input type="text" id="setTitle" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Set başlığı" required>
                            <input type="number" id="setDuration" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Süre (dakika)" min="1" max="120" value="60">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Google Drive set linki <span class="text-gray-500">(paylaşıma açık dosya veya klasör linki)</span></label>
                                <input type="url" id="setDriveUrl" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white placeholder-gray-500" placeholder="https://drive.google.com/...">
                            </div>
                            <input type="file" id="setFile" accept=".mp3,.wav,.m4a" class="w-full text-gray-400 text-sm">
                            <div class="flex items-center gap-2 text-sm text-gray-400"><input type="checkbox" id="setCopyright" required> <label for="setCopyright">Yüklediğim içeriğin kullanım hakkı bende / telif ihlali yok</label></div>
                            <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded">KAYDET VE PORTFÖYE EKLE</button>
                        </form>
                        <h3 class="font-bold mb-2">Portföyündeki setler</h3>
                        <ul class="space-y-2">${uploads.length ? uploads.map(setItemHtml).join('') : '<li class="text-gray-500 text-sm">Henüz set eklemedin. Yukarıdan set başlığı ve Drive linki ile ekle.</li>'}</ul>
                    </div>
                </div>`;
            },

            listings: () => {
                const users = Store.get('users');
                const rawList = Store.get('listings');
                const list = rawList.map(l => normalizeListing(l, users));
                var f = window._listingsFilter || {};
                var sortBy = window._listingsSort || 'newest';
                const filtered = filterListings(list, f);
                const sorted = sortListings(filtered, sortBy);
                const cardsHtml = sorted.length ? sorted.map(renderListingCard).join('') : '<p class="text-gray-400 py-8 text-center">Bu kriterlere uygun ilan yok. Filtreleri değiştirin veya ilan ekleyin.</p>';
                return `
                <div class="h-full flex flex-col min-h-0">
                    <div class="page-content border-b border-gray-800 bg-brand-panel/50">
                        <h2 class="text-lg sm:text-xl font-display font-bold mb-3 sm:mb-4">İlanlar</h2>
                        <div class="flex flex-wrap items-center gap-3 mb-3">
                            <span class="text-xs text-gray-500 uppercase font-bold mr-1">Rol:</span>
                            <button type="button" onclick="ListingsAPI.setFilterRole('')" class="listing-filter-btn px-3 py-1.5 rounded text-sm font-medium ${!f.role ? 'bg-brand-accent text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}">Tümü</button>
                            <button type="button" onclick="ListingsAPI.setFilterRole('dj')" class="listing-filter-btn px-3 py-1.5 rounded text-sm font-medium ${f.role === 'dj' ? 'bg-brand-accent text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}"><i class="fa-solid fa-headphones mr-1" aria-hidden="true"></i>DJ İlanı</button>
                            <button type="button" onclick="ListingsAPI.setFilterRole('venue')" class="listing-filter-btn px-3 py-1.5 rounded text-sm font-medium ${f.role === 'venue' ? 'bg-brand-accent text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}"><i class="fa-solid fa-building mr-1" aria-hidden="true"></i>Mekan İlanı</button>
                            <button type="button" onclick="ListingsAPI.setFilterRole('organizer')" class="listing-filter-btn px-3 py-1.5 rounded text-sm font-medium ${f.role === 'organizer' ? 'bg-brand-accent text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}"><i class="fa-solid fa-calendar-days mr-1" aria-hidden="true"></i>Organizatör İlanı</button>
                            <button type="button" onclick="ListingsAPI.setFilterRole('decorator')" class="listing-filter-btn px-3 py-1.5 rounded text-sm font-medium ${f.role === 'decorator' ? 'bg-amber-500 text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}"><i class="fa-solid fa-palette mr-1" aria-hidden="true"></i>Dekor Kiralama</button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="filterCity" placeholder="Şehir" value="${f.city || ''}" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white w-28">
                            <input type="text" id="filterGenre" placeholder="Tarz" value="${f.genre || ''}" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white w-28">
                            <input type="number" id="filterBpmMin" placeholder="BPM min" value="${f.bpmMin ?? ''}" min="60" max="220" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white w-20">
                            <input type="number" id="filterBpmMax" placeholder="BPM max" value="${f.bpmMax ?? ''}" min="60" max="220" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white w-20">
                            <input type="number" id="filterBudgetMin" placeholder="Bütçe min" value="${f.budgetMin ?? ''}" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white w-24">
                            <input type="number" id="filterBudgetMax" placeholder="Bütçe max" value="${f.budgetMax ?? ''}" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white w-24">
                            <input type="date" id="filterDate" value="${f.date || ''}" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white">
                            <button type="button" onclick="ListingsAPI.applyFilters()" class="px-4 py-2 rounded bg-brand-accent text-white text-sm font-bold">Filtrele</button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-3">
                            <label for="sortListings" class="text-xs text-gray-500">Sırala:</label>
                            <select id="sortListings" onchange="ListingsAPI.setSort(this.value); app.router('listings');" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white">
                                <option value="newest" ${sortBy === 'newest' ? 'selected' : ''}>En yeni</option>
                                <option value="budget" ${sortBy === 'budget' ? 'selected' : ''}>En yüksek bütçe</option>
                                <option value="priceAsc" ${sortBy === 'priceAsc' ? 'selected' : ''}>Fiyat (artan)</option>
                                <option value="priceDesc" ${sortBy === 'priceDesc' ? 'selected' : ''}>Fiyat (azalan)</option>
                                <option value="bpm" ${sortBy === 'bpm' ? 'selected' : ''}>En yakın BPM</option>
                                <option value="date" ${sortBy === 'date' ? 'selected' : ''}>En yakın tarih</option>
                            </select>
                            <button type="button" onclick="app.toggleMapMode()" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-white text-sm font-bold inline-flex items-center gap-2">
                                <i class="fa-solid fa-map-location-dot"></i> Haritada Gör
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <div class="page-shell space-y-4" id="listingsContainer">${cardsHtml}</div>
                    </div>
                </div>`;
            },

            listingCreate: () => {
                const u = app.currentUser;
                const type = u.type;
                if (type === 'decorator') {
                    return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-lg mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-6">Dekor Kiralama İlanı Aç</h2>
                        <form id="listingForm" onsubmit="return false;" class="space-y-4">
                            <input type="hidden" id="listingType" value="decorRental">
                            <input type="text" id="listingTitle" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Başlık (örn: LED Sahne + Backdrop)" required>
                            <input type="text" id="listingCity" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Şehir" required>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Fiyat modeli</label>
                                <select id="listingPricingModel" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" required>
                                    <option value="perNight">Gece başı</option>
                                    <option value="perEvent">Etkinlik başı</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Fiyat (TRY)</label>
                                <input type="number" id="listingPrice" min="1" step="1" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="TL" required>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Drive görsel linkleri (her satıra 1 link)</label>
                                <textarea id="listingImagesDrive" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white h-32" placeholder="https://drive.google.com/file/d/.../view?usp=sharing" required></textarea>
                                <div class="text-xs text-gray-400 mt-2 space-y-1" role="group" aria-label="Drive görsel gereksinimleri">
                                    <p class="font-medium text-amber-400/90">Gereksinimler:</p>
                                    <ul class="list-disc list-inside ml-1"><li>Görselleri Google Drive’a yükleyin.</li><li>Dosyaya sağ tık → Paylaş → &quot;Bağlantıya sahip olan herkes görüntüleyebilir&quot; yapın.</li><li>Link formatı: <code class="text-gray-500">https://drive.google.com/file/d/FILE_ID/view?...</code></li><li>Her satıra 1 link; yalnızca drive.google.com kabul edilir.</li></ul>
                                    <p class="text-amber-400/90 mt-1">Görünmüyorsa: paylaşım kapalıdır veya Drive hotlink engelliyordur — linke tıklayıp tarayıcıda açabiliyor musunuz kontrol edin.</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm text-gray-400 mb-1">Depozito (TL, opsiyonel)</label><input type="number" id="listingDeposit" min="0" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="0"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Kurulum ücreti (TL, opsiyonel)</label><input type="number" id="listingSetupFee" min="0" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="0"></div>
                            </div>
                            <label class="flex items-center gap-2 text-sm text-gray-400"><input type="checkbox" id="listingDeliveryIncluded" class="rounded"> Teslimat dahil</label>
                            <textarea id="listingNotes" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white h-20" placeholder="Notlar (opsiyonel)"></textarea>
                            <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded">İLANI YAYINLA</button>
                        </form>
                    </div>
                </div>`;
                }
                const vp = type === 'venue' ? getProfile(u) : null;
                const op = type === 'organizer' ? getProfile(u) : null;
                const templates = type === 'dj' ? ['djOffer'] : type === 'venue' ? ['venueNeeds'] : ['organizerEvent'];
                const venueExtra = type === 'venue' ? `
                            <div><label class="block text-sm text-gray-400 mb-1">Sunulan ekipman (bu ilan için)</label><textarea id="listingEquipment" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Profilinizden doldurulabilir">${vp && Array.isArray(vp.equipment) ? escapeHtml(vp.equipment.join('\n')) : ''}</textarea></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Bilet bilgisi</label><input type="text" id="listingTicketInfo" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Bilet fiyatı veya politikası"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Kesim tipi</label><select id="listingTicketCutMode" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><option value="percent">Yüzde</option><option value="amount">Bilet başı TL</option><option value="mixed">Hibrit</option></select></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Bilet kesim % (0–100)</label><input type="number" id="listingTicketCutPct" min="0" max="100" step="0.5" value="${vp && vp.ticketCutPercent != null ? vp.ticketCutPercent : ''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Örn: 15"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Bilet başı kesim (TL)</label><input type="number" id="listingTicketCutAmt" min="0" value="" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Örn: 50"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Yüzde politikaları (satır satır: VIP:%20, Online:%15)</label><textarea id="listingPctPolicies" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Kapı:%10, Online:%15"></textarea></div>` : '';
                const orgExtra = type === 'organizer' ? `
                            <div><label class="block text-sm text-gray-400 mb-1">Ücret modeli</label><select id="listingOrgFeeModel" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><option value="flat">Sabit (TL)</option><option value="percent">Yüzde</option><option value="hybrid">Hibrit</option></select></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Organizasyon ücreti (TL)</label><input type="number" id="listingOrgFee" min="0" value="${op && op.organizationFee != null ? op.organizationFee : ''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Sabit tutar"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Organizasyon ücreti (%)</label><input type="number" id="listingOrgFeePercent" min="0" max="100" step="0.5" value="${op && op.organizationFeePercent != null ? op.organizationFeePercent : ''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Yüzde"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Gereksinimler (bu ilan için)</label><textarea id="listingRequirements" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-20" placeholder="Madde madde">${op && Array.isArray(op.requirements) ? escapeHtml(op.requirements.join('\n')) : ''}</textarea></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Teslim edilecekler (promo, biletleme, güvenlik vb.)</label><textarea id="listingDeliverables" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Satır satır"></textarea></div>` : '';
                const djExtra = type === 'dj' ? `
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Fiyat kırılımı (ilan bazında)</div>
                            <div class="grid grid-cols-2 gap-2"><input type="number" id="listingRateBaseFee" min="0" placeholder="Gecelik (TL)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="listingRateExtraHour" min="0" placeholder="Ek saat (TL)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="listingRateTravel" min="0" placeholder="Yol (TL)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="listingRateAfterParty" min="0" placeholder="After party (TL)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Depozito (TL, opsiyonel)</label><input type="number" id="listingRateDeposit" min="0" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="0"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Tech rider (bu ilan için override)</label><textarea id="listingTechRiderOverride" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Boş bırakırsanız profil rider kullanılır"></textarea></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Soundcheck (dk)</label><input type="number" id="listingSoundcheckMinutes" min="0" max="180" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Örn: 60"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Demo / set linkleri (her satıra 1)</label><textarea id="listingDemoLinks" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="https://soundcloud.com/..."></textarea></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Kabul ettiğim bilet kesim</label><div class="flex flex-wrap gap-2"><label class="flex items-center gap-1"><input type="checkbox" name="listingAcceptedTicket" value="percent"> Yüzde</label><label class="flex items-center gap-1"><input type="checkbox" name="listingAcceptedTicket" value="amount"> Bilet başı TL</label><label class="flex items-center gap-1"><input type="checkbox" name="listingAcceptedTicket" value="mixed"> Hibrit</label></div></div>
                            <div><label class="block text-sm text-gray-400 mb-1">İptal politikası</label><select id="listingCancelPolicy" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><option value="">Seçin</option><option value="flexible">Esnek</option><option value="standard">Standart (7 gün)</option><option value="strict">Katı (14 gün)</option></select></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Talep ettiğim ekipman (bu ilan için)</label><textarea id="listingEquipmentRequested" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16" placeholder="Örn: 2x CDJ, mixer"></textarea></div>` : '';
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-lg mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-6">İlan Aç</h2>
                        <form id="listingForm" onsubmit="return false;" class="space-y-4">
                            <input type="hidden" id="listingType" value="${templates[0]}">
                            <input type="text" id="listingTitle" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Başlık" required>
                            <div><label class="block text-sm text-gray-400 mb-1">Tarzlar</label><div class="flex flex-wrap gap-2">${GENRES.map(g => `<label class="flex items-center gap-1"><input type="checkbox" name="listingGenre" value="${g}"> <span class="text-sm">${g}</span></label>`).join('')}</div></div>
                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm text-gray-400">BPM Min</label><input type="number" id="listingBpmMin" min="60" max="220" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="60"></div><div><label class="block text-sm text-gray-400">BPM Max</label><input type="number" id="listingBpmMax" min="60" max="220" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="130"></div></div>
                            <input type="number" id="listingHours" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Saat (1-12)" min="1" max="12" step="0.5">
                            <input type="text" id="listingCity" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Şehir">
                            <input type="text" id="listingBudget" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Bütçe (TL)">
                            <input type="date" id="listingDate" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white">
                            ${venueExtra}
                            ${orgExtra}
                            ${djExtra}
                            <textarea id="listingNotes" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white h-24" placeholder="Notlar"></textarea>
                            <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded">İLANI YAYINLA</button>
                        </form>
                    </div>
                </div>`;
            },

            match: () => {
                const u = app.currentUser;
                const listings = Store.get('listings');
                const rawList = listings.map(l => normalizeListing(l, Store.get('users')));
                const djProfiles = Store.get('djProfiles');
                const venueProfiles = Store.get('venueProfiles');
                const users = Store.get('users');
                const scoreDj = (listing, profile) => {
                    if (!profile) return 0;
                    let s = 0;
                    const g1 = new Set(listing.genres || []);
                    const g2 = new Set(profile.genres || []);
                    const overlap = [...g1].filter(x => g2.has(x)).length;
                    s += (overlap / Math.max(g1.size, 1)) * 30;
                    if (listing.date) s += 15;
                    const bpmMid = (listing.bpmTargetMin + (listing.bpmTargetMax || listing.bpmTargetMin)) / 2;
                    if (profile.bpmMin <= bpmMid && profile.bpmMax >= bpmMid) s += 20;
                    const budgetNum = listing.budget != null ? parseInt(String(listing.budget).replace(/[^0-9]/g, ''), 10) : 0;
                    if (budgetNum && profile.nightlyFee && profile.nightlyFee <= budgetNum) s += 25;
                    if (listing.city && profile.city && String(listing.city).toLowerCase() === String(profile.city).toLowerCase()) s += 10;
                    const eqProvided = (listing.equipmentProvided || []).join(' ').toLowerCase();
                    const rider = (profile.techRider || '').toLowerCase();
                    if (rider && eqProvided && rider.split(/\s+/).some(w => w.length > 2 && eqProvided.indexOf(w) >= 0)) s += 10;
                    return Math.min(100, Math.round(s));
                };
                const scoreDecor = (listing, eventListing) => {
                    if (!eventListing || listing.listingType !== 'DECOR_RENTAL') return 0;
                    let s = 0;
                    if (listing.city && eventListing.city && String(listing.city).toLowerCase() === String(eventListing.city).toLowerCase()) s += 40;
                    const budgetNum = eventListing.budget != null ? parseInt(String(eventListing.budget).replace(/[^0-9]/g, ''), 10) : 0;
                    if (budgetNum && listing.price != null && listing.price <= budgetNum * 0.5) s += 30;
                    if (eventListing.date) s += 20;
                    return Math.min(100, s);
                };
                const eventListings = rawList.filter(l => l.listingType === 'ORGANIZER_EVENT' || l.listingType === 'VENUE_NEEDS');
                const withScores = eventListings.map(l => {
                    const creator = users.find(x => x.id === l.createdByUserId);
                    const prof = creator && creator.type === 'dj' ? djProfiles.find(p => p.userId === creator.id) : null;
                    return { listing: l, creator, profile: prof, score: prof ? scoreDj(l, prof) : 0 };
                }).sort((a, b) => b.score - a.score).slice(0, 10);
                const decorListings = rawList.filter(l => l.listingType === LISTING_TYPE.DECOR_RENTAL);
                const decorWithScores = eventListings.length && decorListings.length ? decorListings.map(dl => {
                    const best = eventListings.reduce((acc, el) => { const sc = scoreDecor(dl, el); return sc > acc.score ? { listing: el, score: sc } : acc; }, { listing: null, score: 0 });
                    return { decor: dl, eventListing: best.listing, score: best.score };
                }).sort((a, b) => b.score - a.score).slice(0, 5) : [];
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-2">Eşleşme Önerileri</h2>
                        <p class="text-gray-400 text-sm mb-6">Genre, BPM, bütçe ve konum uyumuna göre sıralanır.</p>
                        <h3 class="font-bold text-gray-300 mb-2">Etkinlik / Mekan ilanları ↔ DJ uyumu</h3>
                        <ul class="space-y-4 mb-8">${withScores.map(({ listing, creator, score: sc }) => `<li class="p-4 rounded-xl border border-gray-800 bg-gray-900/50 flex justify-between items-center"><div><h3 class="font-bold">${escapeHtml(listing.title)}</h3><p class="text-sm text-gray-400">${creator ? escapeHtml(creator.name) : ''} · ${(listing.genres||[]).join(', ')}</p></div><span class="text-brand-glow font-bold">${sc}% uyum</span></li>`).join('') || '<li class="text-gray-500">İlan bulunamadı.</li>'}</ul>
                        ${decorWithScores.length ? '<h3 class="font-bold text-gray-300 mb-2">Dekor ilanı ↔ Etkinlik uyumu</h3><ul class="space-y-4">' + decorWithScores.map(({ decor, eventListing, score: sc }) => '<li class="p-4 rounded-xl border border-gray-800 bg-gray-900/50 flex justify-between items-center"><div><h3 class="font-bold">' + escapeHtml(decor.title) + '</h3><p class="text-sm text-gray-400">' + (eventListing ? escapeHtml(eventListing.title) : '') + ' · ' + (decor.city || '') + '</p></div><span class="text-amber-400 font-bold">' + sc + '% uyum</span></li>').join('') + '</ul>' : ''}
                    </div>
                </div>`;
            },

            calendar: () => {
                const listings = Store.get('listings');
                const users = Store.get('users');
                const withDate = listings.filter(l => l.date).map(l => ({ ...l, owner: users.find(u => u.id === l.createdByUserId) }));
                const byMonth = {};
                withDate.forEach(l => {
                    const d = l.date;
                    const monthKey = d.substring(0, 7);
                    if (!byMonth[monthKey]) byMonth[monthKey] = [];
                    byMonth[monthKey].push(l);
                });
                const months = Object.keys(byMonth).sort();
                const monthNames = { '01': 'Ocak', '02': 'Şubat', '03': 'Mart', '04': 'Nisan', '05': 'Mayıs', '06': 'Haziran', '07': 'Temmuz', '08': 'Ağustos', '09': 'Eylül', '10': 'Ekim', '11': 'Kasım', '12': 'Aralık' };
                const html = months.length ? months.map(m => {
                    const [y, mo] = m.split('-');
                    const label = monthNames[mo] + ' ' + y;
                    const items = byMonth[m].sort((a,b) => (a.date || '').localeCompare(b.date || ''));
                    return '<div class="mb-6"><h3 class="text-lg font-bold text-gray-300 mb-2">' + label + '</h3><ul class="space-y-2">' + items.map(l => '<li class="p-3 rounded border border-gray-800 flex justify-between items-center"><span>' + escapeHtml(l.title) + '</span><span class="text-sm text-gray-500">' + l.date + (l.owner ? ' · ' + escapeHtml(l.owner.name) : '') + '</span></li>').join('') + '</ul></div>';
                }).join('') : '<p class="text-gray-500">Tarih içeren ilan yok.</p>';
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-2">Takvim</h2>
                        <p class="text-gray-400 text-sm mb-6">İlan tarihlerine göre görünüm.</p>
                        ${html}
                    </div>
                </div>`;
            },

            connections: () => {
                const u = app.currentUser;
                const conns = Store.get('connections');
                const received = conns.filter(c => String(c.toUserId) === String(u.id));
                const users = Store.get('users');
                const getName = (id) => (users.find(x => x.id === id) || {}).name || '?';
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-6">Bağlantılar (Tanıdık Bildirimi)</h2>
                        <h3 class="font-bold mb-2">Bana gelen</h3>
                        <ul class="space-y-2 mb-8">${received.length ? received.map(c => `<li class="p-3 rounded border border-gray-800 flex items-center justify-between gap-2 flex-wrap"><span>${getName(c.fromUserId)} → "${c.message || ''}" (${c.type})</span><button type="button" onclick="(async function(){ await Messaging.openThreadWith('${String(c.fromUserId).replace(/'/g, "\\'")}'); app.router('messages', { threadId: Messaging._lastThreadId }); app.updateNav(); })()" class="text-sm text-brand-accent hover:underline">Mesaj</button></li>`).join('') : '<li class="text-gray-500">Henüz bildirim yok.</li>'}</ul>
                        <h3 class="font-bold mb-2">Tanıdık bildirimi gönder</h3>
                        <p class="text-sm text-gray-400 mb-4">Organizatörler "Bu DJ'yi tanıyorum" veya "Bu mekanı tanıyorum" diyerek bağlantı gönderebilir. MVP: Basit liste.</p>
                        <form id="connectionForm" onsubmit="return false;" class="space-y-4">
                            <select id="connToUser" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white">${users.filter(x => x.id !== u.id).map(x => `<option value="${x.id}">${x.name} (${x.type})</option>`).join('')}</select>
                            <select id="connType" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white"><option value="knowsDJ">DJ tanıyorum</option><option value="knowsVenue">Mekan tanıyorum</option></select>
                            <input type="text" id="connMessage" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Kısa mesaj">
                            <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded">GÖNDER</button>
                        </form>
                    </div>
                </div>`;
            },

            dealRoom: () => {
                const listingId = app._routeParams.listingId;
                const applicantUserId = app._routeParams.applicantUserId;
                if (listingId == null || applicantUserId == null) return '<div class="p-6 text-gray-400">İlan veya başvuran bilgisi yok. <button type="button" onclick="app.router(\'listings\')" class="text-brand-glow underline">İlanlara dön</button></div>';
                const room = DealRoomAPI.get(listingId, applicantUserId);
                if (!room) return '<div class="p-6 text-gray-400">Deal room bulunamadı. <button type="button" onclick="app.router(\'listings\')" class="text-brand-glow underline">İlanlara dön</button></div>';
                const listing = Store.get('listings').find(l => l.id === listingId);
                const users = Store.get('users');
                const applicant = users.find(u => u.id === applicantUserId);
                const owner = users.find(u => u.id === room.listingOwnerUserId);
                const messages = DealRoomAPI.getMessages(room.id);
                const ledgerEntries = LedgerAPI.getByRoom(room.id);
                const terms = getEffectiveTerms(room, listing, owner, applicant);
                const ot = room.offerTerms || {};
                const statusLabels = { initiated: 'Başlatıldı', negotiating: 'Pazarlık', accepted: 'Kabul', escrow_pending: 'Ödeme bekleniyor', confirmed: 'Onaylı', completed: 'Tamamlandı', dispute: 'İhtilaf' };
                const canEdit = app.currentUser && (String(app.currentUser.id) === String(applicantUserId) || String(app.currentUser.id) === String(room.listingOwnerUserId));
                const econ = listing ? computeDealEconomics(listing, owner, applicant, terms) : null;
                const dealSummaryHtml = econ ? '<div class="rounded border border-gray-700 p-3 bg-gray-900/50 text-sm"><div class="font-bold text-gray-300 mb-2">Deal özeti (sim)</div><ul class="space-y-1 text-gray-400"><li>Bütçe: ' + (econ.budget || 0) + ' TL</li><li>Mekan payı: ' + Math.round(econ.venueShare) + ' TL</li><li>Organizatör: ' + Math.round(econ.orgFee) + ' TL</li><li>DJ ücreti: ' + econ.djFee + ' TL</li>' + (econ.decorCost > 0 ? '<li>Dekor: ' + econ.decorCost + ' TL</li>' : '') + '<li class="text-brand-glow font-bold">Net (kalan): ' + Math.round(econ.net) + ' TL</li></ul></div>' : '';
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-3xl mx-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-display font-bold">Teklif Odası</h2>
                            <button type="button" onclick="app.router(\'listings\')" class="text-sm text-gray-400 hover:text-white">← İlanlara dön</button>
                        </div>
                        <p class="text-gray-400 text-sm mb-4">${escapeHtml(listing ? listing.title : '')}</p>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            ${(function(){ var o = owner ? getFullProfile(owner.id) : null; var a = applicant ? getFullProfile(applicant.id) : null; var av = (u) => { var d = u ? resolveDisplayImageForUser(u) : null; var f = u ? getFullProfile(u.id) : null; var common = f && f.common; var avatarUrl = d && d.url ? d.url : null; var name = (common && common.displayName) || (u && u.name) || '—'; return { avatarUrl, name, userId: u && u.id }; }; var oa = o ? av(owner) : { name: '—', avatarUrl: null, userId: null }; var aa = a ? av(applicant) : { name: '—', avatarUrl: null, userId: null }; return '<div class="rounded-lg border border-gray-800 p-3 flex items-center gap-3"><div class="w-10 h-10 rounded-lg overflow-hidden bg-gray-800 flex items-center justify-center flex-shrink-0">' + (oa.avatarUrl ? '<img src="' + oa.avatarUrl.replace(/"/g, '&quot;') + '" alt="" class="w-full h-full object-cover">' : '<span class="text-gray-500 font-bold">' + (oa.name.charAt(0) || '?') + '</span>') + '</div><div class="min-w-0"><p class="font-medium text-white truncate">' + escapeHtml(oa.name) + '</p><p class="text-xs text-gray-500">Mekan/Organizatör</p>' + (oa.userId ? '<button type="button" onclick="app.router(\'profile-view\', { userId: ' + oa.userId + ' })" class="text-xs text-brand-glow hover:underline mt-0.5">Profil</button><button type="button" onclick="Messaging.openThreadWith(' + oa.userId + ', { dealRoomId: ' + room.id + ' }); app.router(\'messages\', { threadId: Messaging._lastThreadId }); app.updateNav();" class="text-xs text-brand-accent hover:underline mt-0.5 ml-2">Mesaj</button>' : '') + '</div></div><div class="rounded-lg border border-gray-800 p-3 flex items-center gap-3"><div class="w-10 h-10 rounded-lg overflow-hidden bg-gray-800 flex items-center justify-center flex-shrink-0">' + (aa.avatarUrl ? '<img src="' + aa.avatarUrl.replace(/"/g, '&quot;') + '" alt="" class="w-full h-full object-cover">' : '<span class="text-gray-500 font-bold">' + (aa.name.charAt(0) || '?') + '</span>') + '</div><div class="min-w-0"><p class="font-medium text-white truncate">' + escapeHtml(aa.name) + '</p><p class="text-xs text-gray-500">Başvuran</p>' + (aa.userId ? '<button type="button" onclick="app.router(\'profile-view\', { userId: ' + aa.userId + ' })" class="text-xs text-brand-glow hover:underline mt-0.5">Profil</button><button type="button" onclick="Messaging.openThreadWith(' + aa.userId + ', { dealRoomId: ' + room.id + ' }); app.router(\'messages\', { threadId: Messaging._lastThreadId }); app.updateNav();" class="text-xs text-brand-accent hover:underline mt-0.5 ml-2">Mesaj</button>' : '') + '</div></div>'; })()}
                        </div>
                        <span class="inline-block px-2 py-1 rounded text-xs font-bold bg-gray-800 text-gray-300">${statusLabels[room.status] || room.status}</span>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-4 mb-4">
                            <button type="button" onclick="document.getElementById(\'tabChat\').classList.remove(\'hidden\'); document.getElementById(\'tabOffer\').classList.add(\'hidden\'); document.getElementById(\'tabContract\').classList.add(\'hidden\'); document.getElementById(\'tabPayment\').classList.add(\'hidden\')" class="px-3 py-2 rounded bg-gray-800 text-gray-300 text-sm font-medium">Sohbet</button>
                            <button type="button" onclick="document.getElementById(\'tabOffer\').classList.remove(\'hidden\'); document.getElementById(\'tabChat\').classList.add(\'hidden\'); document.getElementById(\'tabContract\').classList.add(\'hidden\'); document.getElementById(\'tabPayment\').classList.add(\'hidden\')" class="px-3 py-2 rounded bg-gray-800 text-gray-300 text-sm font-medium">Teklif</button>
                            <button type="button" onclick="document.getElementById(\'tabContract\').classList.remove(\'hidden\'); document.getElementById(\'tabChat\').classList.add(\'hidden\'); document.getElementById(\'tabOffer\').classList.add(\'hidden\'); document.getElementById(\'tabPayment\').classList.add(\'hidden\')" class="px-3 py-2 rounded bg-gray-800 text-gray-300 text-sm font-medium">Sözleşme</button>
                            <button type="button" onclick="document.getElementById(\'tabPayment\').classList.remove(\'hidden\'); document.getElementById(\'tabChat\').classList.add(\'hidden\'); document.getElementById(\'tabOffer\').classList.add(\'hidden\'); document.getElementById(\'tabContract\').classList.add(\'hidden\')" class="px-3 py-2 rounded bg-gray-800 text-gray-300 text-sm font-medium">Ödeme (sim)</button>
                        </div>
                        <div id="tabChat" class="space-y-3">
                            <div class="rounded border border-gray-800 p-3 max-h-64 overflow-y-auto space-y-2">${messages.length ? messages.map(m => { const u = users.find(x => x.id === m.userId); return '<div class="text-sm"><span class="text-gray-500">' + (u ? escapeHtml(u.name) : '') + '</span>: ' + escapeHtml(m.text) + '</div>'; }).join('') : '<p class="text-gray-500 text-sm">Henüz mesaj yok.</p>'}</div>
                            ${canEdit ? '<form onsubmit="if(app._supabaseOffline){ showToast(\'Sunucu bağlantısı yok.\'); return false; } (async function(){ var t=document.getElementById(\'dealMsgText\'); if(t && t.value.trim()){ await DealRoomAPI.sendMessage(' + room.id + ', t.value.trim()); t.value=\'\'; app.router(\'deal-room\', app._routeParams); } })(); return false;"><input type="text" id="dealMsgText" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Mesaj yazın" ' + (app._supabaseOffline ? 'disabled' : '') + '><button type="submit" class="mt-2 px-4 py-2 rounded bg-brand-accent text-white text-sm font-bold ' + (app._supabaseOffline ? 'opacity-50 cursor-not-allowed' : '') + '" ' + (app._supabaseOffline ? 'disabled title="Sunucu bağlantısı yok"' : '') + '>Gönder</button></form>' : ''}
                        </div>
                        <div id="tabOffer" class="hidden space-y-3">
                            ${dealSummaryHtml}
                            <div class="rounded border border-gray-800 p-3 space-y-4">
                                <div class="text-xs font-bold text-gray-400 uppercase mb-2">Teklif şartları (v2) — İlan + profil varsayılanları üzerine yazılır</div>
                                ${canEdit ? (function(){
                                    var t = terms;
                                    var r = t.rate || {};
                                    var reqText = Array.isArray(t.requirements) ? t.requirements.join('\n') : '';
                                    var delText = Array.isArray(t.deliverables) ? t.deliverables.join('\n') : '';
                                    var demoText = Array.isArray(t.demoLinks) ? t.demoLinks.join('\n') : '';
                                    return '<form onsubmit="(async function(){ await DealRoomAPI.updateOffer(' + room.id + ', collectOfferTermsFromForm()); app.router(\'deal-room\', app._routeParams); })(); return false;" class="space-y-4">' +
                                    '<div class="grid grid-cols-1 sm:grid-cols-3 gap-2"><input type="number" id="offerPrice" placeholder="Ücret (TL)" value="' + (t.price != null ? t.price : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="date" id="offerDate" value="' + (t.date || '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerHours" placeholder="Saat" value="' + (t.hours != null ? t.hours : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div>' +
                                    '<div class="grid grid-cols-1 sm:grid-cols-3 gap-2"><input type="text" id="offerEventTitle" placeholder="Etkinlik adı" value="' + escapeHtml(t.eventTitle || '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white sm:col-span-2"><input type="text" id="offerEventCity" placeholder="Şehir" value="' + escapeHtml(t.eventCity || '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div>' +
                                    '<input type="number" id="offerEventBudget" placeholder="Bütçe (TL)" value="' + (t.eventBudget != null ? t.eventBudget : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white">' +
                                    '<div class="border-t border-gray-700 pt-2"><span class="text-xs text-gray-500">Mekan</span><div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-1"><select id="offerTicketCutMode" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><option value="percent"' + (t.ticketCutMode === 'percent' ? ' selected' : '') + '>Yüzde</option><option value="amount"' + (t.ticketCutMode === 'amount' ? ' selected' : '') + '>Bilet başı TL</option><option value="mixed"' + (t.ticketCutMode === 'mixed' ? ' selected' : '') + '>Hibrit</option></select><input type="number" id="offerTicketCutPct" placeholder="%" value="' + (t.ticketCutPercent != null ? t.ticketCutPercent : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerTicketCutAmt" placeholder="TL/bilet" value="' + (t.ticketCutAmount != null ? t.ticketCutAmount : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="text" id="offerTicketPolicy" placeholder="Bilet politikası" value="' + escapeHtml(t.ticketPricePolicy || '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div><textarea id="offerPctPolicies" placeholder="Yüzde politikaları (Kapı/Online/VIP)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mt-1 h-12">' + escapeHtml(t.percentagePolicies || '') + '</textarea></div>' +
                                    '<div class="border-t border-gray-700 pt-2"><span class="text-xs text-gray-500">Organizatör</span><div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-1"><select id="offerOrgModel" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><option value="flat"' + (t.organizerFeeModel === 'flat' ? ' selected' : '') + '>Sabit TL</option><option value="percent"' + (t.organizerFeeModel === 'percent' ? ' selected' : '') + '>Yüzde</option><option value="hybrid"' + (t.organizerFeeModel === 'hybrid' ? ' selected' : '') + '>Hibrit</option></select><input type="number" id="offerOrgFee" placeholder="TL" value="' + (t.organizerFee != null ? t.organizerFee : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerOrgPct" placeholder="%" value="' + (t.organizerFeePercent != null ? t.organizerFeePercent : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div><textarea id="offerRequirements" placeholder="Gereksinimler (satır satır)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mt-1 h-16">' + escapeHtml(reqText) + '</textarea><textarea id="offerDeliverables" placeholder="Teslim edilecekler" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mt-1 h-12">' + escapeHtml(delText) + '</textarea></div>' +
                                    '<div class="border-t border-gray-700 pt-2"><span class="text-xs text-gray-500">DJ</span><div class="grid grid-cols-2 sm:grid-cols-5 gap-2 mt-1"><input type="number" id="offerRateBase" placeholder="Baz TL" value="' + (r.baseFee != null ? r.baseFee : t.price != null ? t.price : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerRateExtraHour" placeholder="Ek saat TL" value="' + (r.extraHourFee != null ? r.extraHourFee : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerRateTravel" placeholder="Yol TL" value="' + (r.travelFee != null ? r.travelFee : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerRateAfterParty" placeholder="After party TL" value="' + (r.afterPartyFee != null ? r.afterPartyFee : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerDeposit" placeholder="Depozito" value="' + (r.depositAmount != null ? r.depositAmount : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div><textarea id="offerTechRider" placeholder="Tech rider (override)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mt-1 h-12">' + escapeHtml(t.techRiderOverride || '') + '</textarea><input type="number" id="offerSoundcheck" placeholder="Soundcheck (dk)" value="' + (t.soundcheckMinutes != null ? t.soundcheckMinutes : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mt-1"><textarea id="offerDemoLinks" placeholder="Demo/set linkleri (satır satır)" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mt-1 h-12">' + escapeHtml(demoText) + '</textarea><input type="text" id="offerCancelPolicy" placeholder="İptal politikası" value="' + escapeHtml(t.cancelPolicy || '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mt-1"></div>' +
                                    '<div class="border-t border-gray-700 pt-2"><span class="text-xs text-gray-500">Dekor</span><div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-1"><input type="number" id="offerDecorPrice" placeholder="Kira TL" value="' + (t.decorPrice != null ? t.decorPrice : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerDecorSetup" placeholder="Kurulum TL" value="' + (t.decorSetupFee != null ? t.decorSetupFee : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerDecorDeposit" placeholder="Depozito" value="' + (t.decorDeposit != null ? t.decorDeposit : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"><input type="number" id="offerDecorDeliveryFee" placeholder="Teslimat TL" value="' + (t.decorDeliveryFee != null ? t.decorDeliveryFee : '') + '" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white"></div><label class="flex items-center gap-2 text-sm text-gray-400 mt-1"><input type="checkbox" id="offerDecorDeliveryIncluded"' + (t.decorDeliveryIncluded ? ' checked' : '') + '> Teslimat dahil</label></div>' +
                                    '<div class="flex flex-wrap gap-2"><button type="submit" class="px-4 py-2 rounded bg-brand-accent text-white text-sm font-bold">Teklifi kaydet</button>' + (room.status !== 'accepted' ? '<button type="button" onclick="(async function(){ await DealRoomAPI.updateStatus(' + room.id + ', \'accepted\'); app.router(\'deal-room\', app._routeParams); })()" class="px-4 py-2 rounded bg-amber-600 text-white text-sm font-bold">Kabul et (snapshot alınır)</button>' : '') + '</div></form>';
                                })() : '<p class="text-sm text-gray-400">Ücret: ' + (terms.price != null ? terms.price + ' TL' : '-') + ', Tarih: ' + (terms.date || '-') + ', Saat: ' + (terms.hours != null ? terms.hours : '-') + '</p>'}
                            </div>
                        </div>
                        <div id="tabContract" class="hidden space-y-3">
                            <p class="text-sm text-gray-400">Kabul edilen teklif şartları sözleşme taslağına yansıtılır. Platform sözleşme taslağını PDF olarak indirebilirsiniz.</p>
                            <button type="button" onclick="ContractAPI.downloadDraft()" class="px-4 py-2 rounded bg-amber-600 text-white text-sm font-bold">Sözleşme taslağı indir (DOCX)</button>
                        </div>
                        <div id="tabPayment" class="hidden space-y-3">
                            ${dealSummaryHtml}
                            <div class="rounded border border-gray-800 p-3">
                                <div class="text-xs font-bold text-gray-400 uppercase mb-2">Ledger (sim)</div>
                                ${ledgerEntries.length ? '<ul class="space-y-1 text-sm text-gray-400">' + ledgerEntries.map(e => '<li>' + e.amount + ' TL · ' + e.status + ' · ' + (e.payerUserId === app.currentUser.id ? 'Ödedim' : 'Alacak') + '</li>').join('') + '</ul>' : '<p class="text-gray-500 text-sm">Henüz ödeme kaydı yok.</p>'}
                                ${canEdit ? '<button type="button" onclick="(async function(){ var amt=prompt(\'Tutar (TL)\'); if(amt){ var payee=' + JSON.stringify(room.listingOwnerUserId === app.currentUser.id ? applicantUserId : room.listingOwnerUserId) + '; await LedgerAPI.add(' + room.id + ', parseFloat(amt), app.currentUser.id, payee, \'held\'); await DealRoomAPI.updateStatus(' + room.id + ', \'escrow_pending\'); app.router(\'deal-room\', app._routeParams); } })()" class="mt-2 px-4 py-2 rounded bg-amber-600 text-white text-sm font-bold">Ödeme yap (sim)</button>' : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            },

            dealRooms: () => {
                const u = app.currentUser;
                const rooms = (Store.get('dealRooms') || []).filter(r => String(r.applicantUserId) === String(u.id) || String(r.listingOwnerUserId) === String(u.id));
                const listings = Store.get('listings');
                const users = Store.get('users');
                const statusLabels = { initiated: 'Başlatıldı', negotiating: 'Pazarlık', accepted: 'Kabul', escrow_pending: 'Ödeme bekleniyor', confirmed: 'Onaylı', completed: 'Tamamlandı', dispute: 'İhtilaf' };
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-xl font-display font-bold mb-4">Teklif odalarım</h2>
                        ${rooms.length ? '<ul class="space-y-3">' + rooms.map(r => {
                            const list = listings.find(l => l.id === r.listingId);
                            const applicant = users.find(x => x.id === r.applicantUserId);
                            const owner = users.find(x => x.id === r.listingOwnerUserId);
                            return '<li class="p-4 rounded-xl border border-gray-800 bg-gray-900/50 flex justify-between items-center"><div><h3 class="font-bold">' + escapeHtml(list ? list.title : 'İlan #' + r.listingId) + '</h3><p class="text-sm text-gray-400">' + (owner ? escapeHtml(owner.name) : '') + ' ↔ ' + (applicant ? escapeHtml(applicant.name) : '') + ' · ' + (statusLabels[r.status] || r.status) + '</p></div><button type="button" onclick="app.router(\'deal-room\', { listingId: ' + r.listingId + ', applicantUserId: ' + r.applicantUserId + ' })" class="px-4 py-2 rounded bg-amber-600 text-white text-sm font-bold">Aç</button></li>';
                        }).join('') + '</ul>' : '<p class="text-gray-500">Henüz teklif odanız yok. İlanlardan "Başvur" ile açabilirsiniz.</p>'}
                    </div>
                </div>`;
            },

            profileView: (userId) => {
                userId = userId != null ? Number(userId) : null;
                if (userId == null) return '<div class="page-shell"><p class="text-gray-400">Profil bulunamadı.</p><button type="button" onclick="app.router(\'listings\')" class="text-brand-glow underline">İlanlara dön</button></div>';
                var full = getFullProfile(userId);
                var user = full.user;
                var common = full.common;
                var isOwner = app.currentUser && String(app.currentUser.id) === String(userId);
                if (!user) return '<div class="page-shell"><p class="text-gray-400">Kullanıcı bulunamadı.</p></div>';
                var roleLabel = user.type === 'dj' ? 'DJ' : user.type === 'venue' ? 'Mekan' : user.type === 'organizer' ? 'Organizatör' : 'Dekorcu';
                var displayImg = resolveDisplayImageForUser(user);
                var avatarUrl = displayImg.url || null;
                var displayName = (common && common.displayName) || user.name || '—';
                var bio = profileField(common && common.bio);
                var location = profileField(user.location);
                var avatarHtml = avatarUrl ? '<img src="' + avatarUrl.replace(/"/g, '&quot;') + '" alt="" class="w-full h-full object-cover">' : '<span class="text-3xl font-bold text-gray-500">' + (displayName.charAt(0) || '?') + '</span>';
                var coverHtml = (common && common.coverDataUrl) ? '<div class="h-40 sm:h-52 rounded-t-xl bg-cover bg-center" style="background-image:url(\'' + (common.coverDataUrl.replace(/'/g, "\\'")) + '\')"></div>' : '';
                var actions = '';
                if (!isOwner && app.currentUser) {
                    actions = '<div class="flex flex-wrap gap-2 mt-3"><button type="button" onclick="(async function(){ await Messaging.openThreadWith(' + JSON.stringify(userId) + '); app.router(\'messages\', { threadId: Messaging._lastThreadId }); })()" class="px-4 py-2 rounded bg-brand-accent text-white text-sm font-bold">Mesaj Gönder</button><button type="button" onclick="if(navigator.share){navigator.share({title:\'' + escapeHtml(displayName) + '\',url:location.href}).catch(function(){});}else{ navigator.clipboard.writeText(location.href); alert(\'Link kopyalandı\');}" class="px-4 py-2 rounded border border-gray-600 text-gray-400 text-sm">Paylaş</button></div>';
                }
                if (isOwner) actions = '<div class="flex flex-wrap gap-2 mt-3"><button type="button" onclick="app.router(\'profile-edit\')" class="px-4 py-2 rounded bg-brand-accent text-white text-sm font-bold">Profili düzenle</button></div>';
                var contactBlock = !isOwner ? '<p class="text-sm text-gray-500 mt-2">İletişim yalnızca uygulama içi mesajlaşma ile yapılır.</p>' : '';
                var roleSection = '';
                if (full.dj) { var g = (full.dj.genres || []).join(', ') || '—'; var fee = full.dj.nightlyFee != null ? full.dj.nightlyFee + ' TL' : '—'; roleSection += '<div class="rounded-xl border border-gray-800 p-4 mb-4"><h3 class="font-bold text-gray-300 mb-2">DJ bilgileri</h3><p class="text-sm">Türler: ' + escapeHtml(g) + '</p><p class="text-sm">Gece ücreti: ' + fee + '</p><p class="text-sm">Rider: ' + profileField(full.dj.techRider) + '</p></div>'; }
                if (full.venue) { roleSection += '<div class="rounded-xl border border-gray-800 p-4 mb-4"><h3 class="font-bold text-gray-300 mb-2">Mekan</h3><p class="text-sm">Kapasite: ' + profileField(full.venue.capacity) + '</p><p class="text-sm">Şehir: ' + profileField(full.venue.city) + '</p><p class="text-sm">Adres: ' + profileField(full.venue.address) + '</p></div>'; }
                if (full.organizer) { roleSection += '<div class="rounded-xl border border-gray-800 p-4 mb-4"><h3 class="font-bold text-gray-300 mb-2">Organizatör</h3><p class="text-sm">Şehir: ' + profileField(full.organizer.city) + '</p></div>'; }
                if (full.decorator) { roleSection += '<div class="rounded-xl border border-gray-800 p-4 mb-4"><h3 class="font-bold text-gray-300 mb-2">Dekorcu</h3><p class="text-sm">Kategoriler: ' + ((full.decorator.categories || []).join(', ') || '—') + '</p><p class="text-sm">Şehir: ' + profileField(full.decorator.city) + '</p></div>'; }
                return `
                <div class="h-full overflow-y-auto">
                    <div class="page-shell">
                        ${coverHtml}
                        <div class="rounded-b-xl border border-t-0 border-gray-800 bg-gray-900/80 -mt-0 p-4 sm:p-6">
                            <div class="flex flex-col sm:flex-row items-start gap-4">
                                <div class="profile-avatar">${avatarHtml}</div>
                                <div class="flex-1 min-w-0">
                                    <h1 class="text-xl sm:text-2xl font-display font-bold text-white">${escapeHtml(displayName)}</h1>
                                    <span class="inline-block mt-1 px-2 py-0.5 rounded text-xs font-bold ${user.type === 'dj' ? 'bg-cyan-900/40 text-cyan-300' : user.type === 'venue' ? 'bg-violet-900/40 text-violet-300' : user.type === 'organizer' ? 'bg-pink-900/40 text-pink-300' : 'bg-amber-900/40 text-amber-300'}">${escapeHtml(roleLabel)}</span>
                                    <p class="text-sm text-gray-400 mt-1">${escapeHtml(location)}</p>
                                    <div class="flex items-center gap-2 mt-1"><span class="text-xs text-gray-500">Profil tamamlanma: ${full.completenessScore}%</span></div>
                                    ${actions}
                                </div>
                            </div>
                            <div class="mt-6 border-t border-gray-800 pt-4">
                                <h2 class="font-bold text-gray-300 mb-2">Hakkında</h2>
                                <p class="text-gray-300 whitespace-pre-wrap">${escapeHtml(bio)}</p>
                                ${contactBlock ? '<div class="mt-3">' + contactBlock + '</div>' : ''}
                            </div>
                            ${roleSection}
                        </div>
                    </div>
                </div>`;
            },

            profileEdit: () => {
                window._profileEditDirty = false;
                var u = app.currentUser;
                if (!u) return '<div class="page-shell"><p class="text-gray-400">Giriş yapın.</p></div>';
                var full = getFullProfile(u.id);
                var common = full.common || {};
                var tab = window._profileEditTab || 'basic';
                var displayName = (common.displayName || '').trim() || (u.name || '');
                var bio = (common.bio || '').trim();
                var displayImg = resolveDisplayImageForUser(u);
                var avatarUrl = displayImg.url || null;
                var roleLabel = u.type === 'dj' ? 'DJ' : u.type === 'venue' ? 'Mekan' : u.type === 'organizer' ? 'Organizatör' : 'Dekorcu';
                var avatarHtml = avatarUrl ? '<img src="' + avatarUrl.replace(/"/g, '&quot;') + '" alt="" class="w-full h-full object-cover">' : '<span class="text-2xl font-bold text-gray-500">' + (displayName.charAt(0) || '?') + '</span>';
                var tabClass = function(t) { return (tab === t ? 'bg-brand-accent text-white' : 'bg-gray-800 text-gray-300'); };
                return `
                <div class="h-full overflow-y-auto">
                    <div class="page-shell">
                        <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">
                            <aside class="flex-shrink-0 w-full lg:w-72">
                                <div class="profile-edit-card sticky top-4">
                                    <div class="avatar-wrap" id="profileEditAvatarCard">${avatarHtml}</div>
                                    <table class="info-table">
                                        <tr><td>Görünen ad</td><td class="text-white font-medium">${escapeHtml(displayName) || '—'}</td></tr>
                                        <tr><td>Rol</td><td class="text-white">${escapeHtml(roleLabel)}</td></tr>
                                        <tr><td>Tamamlanma</td><td class="text-white">${full.completenessScore}%</td></tr>
                                    </table>
                                </div>
                            </aside>
                            <div class="flex-1 min-w-0">
                                <h2 class="text-xl font-display font-bold mb-2">Profili düzenle</h2>
                                <p class="text-gray-400 text-sm mb-4">${escapeHtml(roleLabel)} · Tamamlanma: <strong class="text-white">${full.completenessScore}%</strong></p>
                                <div class="flex flex-wrap gap-2 mb-6">
                                    <button type="button" onclick="ProfileEditUI.showTab('basic')" class="px-3 py-2 rounded ${tabClass('basic')} text-sm font-medium">Temel</button>
                                    <button type="button" onclick="ProfileEditUI.showTab('role')" class="px-3 py-2 rounded ${tabClass('role')} text-sm font-medium">Rol bilgisi</button>
                                    <button type="button" onclick="ProfileEditUI.showTab('media')" class="px-3 py-2 rounded ${tabClass('media')} text-sm font-medium">Medya</button>
                                    <button type="button" onclick="ProfileEditUI.showTab('privacy')" class="px-3 py-2 rounded ${tabClass('privacy')} text-sm font-medium">Gizlilik</button>
                                </div>
                                <div id="profileTabBasic" class="profile-edit-tab ${tab === 'basic' ? '' : 'hidden'}">
                                    <form onsubmit="ProfileAPI.saveBasic(this); return false;" class="space-y-4 max-w-xl">
                                        <div class="flex items-center gap-4">
                                            <div class="profile-avatar-edit" id="profileEditAvatarPreview">${avatarHtml}</div>
                                            <div><label class="block text-sm text-gray-400 mb-1">Profil fotoğrafı</label><input type="file" accept="image/jpeg,image/png,image/webp" id="profileAvatarInput" class="text-sm text-gray-300" onchange="ProfileEditUI.previewAvatar(this)"><button type="button" id="profileAvatarUploadBtn" onclick="ProfileAPI.uploadAvatar()" class="mt-2 px-3 py-1 rounded bg-gray-700 text-white text-sm">Yükle</button></div>
                                        </div>
                                        <div><label class="block text-sm text-gray-400 mb-1">Görünen ad *</label><input type="text" name="displayName" value="${escapeHtml(displayName)}" required class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Ad veya sahne adı" oninput="window._profileEditDirty=true"></div>
                                        <div><label class="block text-sm text-gray-400 mb-1">Hakkında</label><textarea name="bio" rows="4" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white" placeholder="Kısa biyografi" oninput="window._profileEditDirty=true">${escapeHtml(bio)}</textarea></div>
                                        <button type="submit" class="px-4 py-2 rounded bg-brand-accent text-white font-bold">Kaydet</button>
                                    </form>
                                </div>
                        <div id="profileTabRole" class="profile-edit-tab ${tab === 'role' ? '' : 'hidden'}">
                            <div class="max-w-xl"><p class="text-gray-400 text-sm mb-4">Rol bilgileriniz Ayarlar sayfasından düzenlenir.</p><button type="button" onclick="app.router('settings')" class="px-4 py-2 rounded bg-gray-700 text-white">Ayarlara git</button></div>
                        </div>
                        <div id="profileTabMedia" class="profile-edit-tab ${tab === 'media' ? '' : 'hidden'}">
                            <div class="max-w-xl space-y-4">
                                <p class="text-xs text-gray-500 mb-2">Logo (DJ: Logo Studio) öncelikli; yoksa profil fotoğrafı ilanlarda gösterilir.</p>
                                <div><label class="block text-sm text-gray-400 mb-1">Profil fotoğrafı</label><input type="file" accept="image/jpeg,image/png,image/webp" id="profileAvatarInputMedia" class="text-sm text-gray-300" onchange="ProfileEditUI.previewAvatar(this)"><button type="button" onclick="ProfileAPI.uploadAvatar()" class="mt-2 px-3 py-1 rounded bg-gray-700 text-white text-sm">Yükle</button></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Kapak görseli</label><input type="file" accept="image/jpeg,image/png,image/webp" id="profileCoverInput"><button type="button" onclick="ProfileAPI.uploadCover()" class="mt-2 px-3 py-1 rounded bg-gray-700 text-white text-sm">Yükle</button></div>
                                <p class="text-xs text-gray-500">Profil foto: max 512px, kapak: max 1600px. JPG/PNG/WebP, max 5MB.</p>
                            </div>
                        </div>
                        <div id="profileTabPrivacy" class="profile-edit-tab ${tab === 'privacy' ? '' : 'hidden'}">
                            <div class="max-w-xl space-y-4">
                                <p class="text-sm text-gray-400 rounded-lg border border-gray-700 p-4 bg-gray-900/50">İletişim yalnızca CoreMind uygulama içi mesajlaşma ile yapılır. E-posta veya telefon bilgisi paylaşılmaz.</p>
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="allowDirectBooking" ${common.allowDirectBooking !== false ? 'checked' : ''} onchange="window._profileEditDirty=true"> Doğrudan teklif isteğine izin ver</label>
                                <button type="button" onclick="ProfileAPI.savePrivacySimple(document.querySelector('#profileTabPrivacy input[name=allowDirectBooking]'))" class="px-4 py-2 rounded bg-brand-accent text-white font-bold">Kaydet</button>
                            </div>
                        </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            },

            messages: (selectedThreadId) => {
                var u = app.currentUser;
                if (!u) return '<div class="page-shell"><p class="text-gray-400">Giriş yapın.</p></div>';
                var threads = Messaging.getThreadsForUser(u.id);
                var users = Store.get('users');
                var selectedId = selectedThreadId != null ? Number(selectedThreadId) : (threads.length ? threads[0].id : null);
                if (selectedId) Messaging.markThreadRead(selectedId, u.id);
                var threadListHtml = threads.map(function(t) {
                    var otherId = String(t.participantIds[0]) === String(u.id) ? t.participantIds[1] : t.participantIds[0];
                    var other = users.find(function(x) { return x.id === otherId; });
                    var full = other ? getFullProfile(other.id) : null;
                    var common = full && full.common;
                    var displayName = (common && common.displayName) || (other && other.name) || '—';
                    var displayImg = other ? resolveDisplayImageForUser(other) : null;
                    var avatarUrl = displayImg && displayImg.url ? displayImg.url : null;
                    var initial = displayName.charAt(0).toUpperCase();
                    var preview = (t.lastMessageText || '').slice(0, 40) + ((t.lastMessageText || '').length > 40 ? '…' : '');
                    var dateStr = t.lastMessageAt ? new Date(t.lastMessageAt).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : '';
                    var unread = (t.unreadBy && t.unreadBy[u.id]) ? t.unreadBy[u.id] : 0;
                    var active = t.id === selectedId;
                    var avatarHtml = avatarUrl ? '<img src="' + avatarUrl.replace(/"/g, '&quot;') + '" alt="" class="w-full h-full object-cover">' : '<span class="text-sm font-bold text-gray-500">' + initial + '</span>';
                    return '<button type="button" onclick="app.router(\'messages\', { threadId: ' + t.id + ' }); app.updateNav();" class="w-full text-left p-3 rounded-lg border ' + (active ? 'border-brand-accent bg-gray-800/80' : 'border-gray-800 hover:bg-gray-800/50') + ' flex items-center gap-3">' +
                        '<div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-700 flex items-center justify-center">' + avatarHtml + '</div>' +
                        '<div class="flex-1 min-w-0"><p class="font-medium text-gray-200 truncate">' + escapeHtml(displayName) + '</p><p class="text-xs text-gray-500 truncate">' + escapeHtml(preview) + '</p></div>' +
                        '<div class="flex-shrink-0 text-right"><span class="text-xs text-gray-500">' + dateStr + '</span>' + (unread > 0 ? '<span class="block rounded-full bg-red-500 text-white text-xs mt-1 min-w-[18px] h-[18px] inline-flex items-center justify-center">' + unread + '</span>' : '') + '</div></button>';
                }).join('') || '<p class="text-gray-500 text-sm p-4">Henüz mesaj yok. Profil veya ilan kartından "Mesaj" ile başlatın.</p>';
                var chatHtml = '';
                if (selectedId) {
                    var selThread = threads.find(function(x) { return x.id === selectedId; });
                    var otherId = selThread ? (String(selThread.participantIds[0]) === String(u.id) ? selThread.participantIds[1] : selThread.participantIds[0]) : null;
                    var otherUser = otherId ? users.find(function(x) { return x.id === otherId; }) : null;
                    var otherName = otherUser ? (getFullProfile(otherId).common && getFullProfile(otherId).common.displayName) || otherUser.name : '—';
                    var msgs = Messaging.getMessages(selectedId);
                    var bubbles = msgs.map(function(m) {
                        var isMe = String(m.senderId) === String(u.id);
                        return '<div class="flex ' + (isMe ? 'justify-end' : 'justify-start') + '"><div class="max-w-[80%] rounded-xl px-4 py-2 ' + (isMe ? 'bg-brand-accent text-white' : 'bg-gray-700 text-gray-200') + '"><p class="text-sm whitespace-pre-wrap">' + escapeHtml(m.text) + '</p><p class="text-xs mt-1 opacity-75">' + new Date(m.createdAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) + '</p></div></div>';
                    }).join('');
                    chatHtml = '<div class="flex flex-col h-full"><div class="border-b border-gray-800 p-3 flex items-center justify-between gap-2 flex-wrap"><span class="font-medium text-gray-200">' + escapeHtml(otherName) + '</span><div class="flex gap-2"><button type="button" onclick="var r=prompt(\'Rapor nedeni (kısa)\'); if(r!=null){ Messaging.reportThread(' + selectedId + ', r); if(typeof showToast===\'function\') showToast(\'Rapor kaydedildi.\'); app.router(\'messages\', { threadId: ' + selectedId + ' }); }" class="text-xs text-gray-400 hover:text-white">Raporla</button><button type="button" onclick="if(confirm(\'Bu kullanıcıyı engellemek istediğinize emin misiniz? Engellenen size mesaj atamaz.\')){ Messaging.blockUser(' + JSON.stringify(u.id) + ', ' + JSON.stringify(otherId) + '); app.router(\'messages\'); app.updateNav(); }" class="text-xs text-gray-400 hover:text-red-400">Engelle</button></div></div>' +
                        '<div id="messagesChatArea" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">' + bubbles + '</div>' +
                        '<div class="border-t border-gray-800 p-3"><form onsubmit="if(app._supabaseOffline){ showToast(\'Sunucu bağlantısı yok.\'); return false; } (async function(){ var ta=document.getElementById(\'messageComposer\'); var t=ta&&ta.value?ta.value.trim():\'\'; if(t){ await Messaging.sendMessage(' + selectedId + ', app.currentUser.id, t); ta.value=\'\'; app.router(\'messages\', { threadId: ' + selectedId + ' }); app.updateNav(); } })(); return false;" class="flex gap-2">' +
                        '<textarea id="messageComposer" rows="2" class="flex-1 bg-gray-800 border border-gray-700 rounded-lg p-2 text-white placeholder-gray-500 resize-none" placeholder="Mesaj yazın (Enter gönder, Shift+Enter yeni satır)" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){ event.preventDefault(); this.form.requestSubmit(); }" ' + (app._supabaseOffline ? 'disabled' : '') + '></textarea>' +
                        '<button type="submit" class="px-4 py-2 rounded-lg bg-brand-accent text-white font-bold self-end ' + (app._supabaseOffline ? 'opacity-50 cursor-not-allowed' : '') + '" ' + (app._supabaseOffline ? 'disabled title="Sunucu bağlantısı yok"' : '') + '>Gönder</button></form></div></div>';
                } else {
                    chatHtml = '<div class="flex-1 flex items-center justify-center text-gray-500"><p>Bir sohbet seçin veya profil/ilandan "Mesaj" ile yeni başlatın.</p></div>';
                }
                return '<div class="h-full flex flex-col overflow-hidden"><div class="page-shell flex flex-1 min-h-0"><div class="flex w-full max-w-4xl mx-auto gap-4 h-full min-h-0">' +
                    '<div class="w-full sm:w-80 flex-shrink-0 flex flex-col border border-gray-800 rounded-xl overflow-hidden bg-gray-900/50"><div class="p-2 border-b border-gray-800"><input type="text" id="messagesSearch" placeholder="Ara..." class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white placeholder-gray-500" oninput="app.router(\'messages\');"></div><div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">' + threadListHtml + '</div></div>' +
                    '<div class="flex-1 min-w-0 flex flex-col border border-gray-800 rounded-xl overflow-hidden bg-gray-900/30">' + chatHtml + '</div></div></div></div>';
            },

            reviews: () => {
                const u = app.currentUser;
                const reviews = Store.get('reviews');
                const users = Store.get('users');
                const getName = (id) => (users.find(x => x.id === id) || {}).name || '?';
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-6">Değerlendirmeler</h2>
                        <p class="text-gray-400 text-sm mb-4">DJ, set veya ilan için puan ve yorum. Aynı hedefe 24 saatte 1 yorum.</p>
                        <ul class="space-y-4 mb-8">${reviews.slice(-20).reverse().map(r => `<li class="p-4 rounded border border-gray-800"><div class="flex justify-between"><span class="font-bold">${getName(r.authorUserId)}</span><span>${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</span></div><p class="text-sm text-gray-400">${r.targetType} #${r.targetId}</p><p>${r.comment || '-'}</p></li>`).join('') || '<li class="text-gray-500">Henüz değerlendirme yok.</li>'}</ul>
                        <h3 class="font-bold mb-2">Yeni değerlendirme</h3>
                        <form id="reviewForm" onsubmit="return false;" class="space-y-4">
                            <select id="reviewTargetType" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white"><option value="dj">DJ</option><option value="set">Set</option><option value="listing">İlan</option></select>
                            <input type="number" id="reviewTargetId" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white" placeholder="Hedef ID (örn. user id veya listing id)" min="1">
                            <div><label class="block text-sm text-gray-400">Puan (1-5)</label><input type="range" id="reviewRating" min="1" max="5" value="5" class="w-full" oninput="var s=document.getElementById('reviewRatingVal');if(s)s.textContent=this.value"> <span id="reviewRatingVal">5</span></div>
                            <textarea id="reviewComment" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white h-20" placeholder="Yorum"></textarea>
                            <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded">GÖNDER</button>
                        </form>
                    </div>
                </div>`;
            },

            moderation: () => {
                const reports = Store.get('reports');
                const users = Store.get('users');
                const getName = (id) => (users.find(x => x.id === id) || {}).name || '?';
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-6">Moderasyon (Admin-lite)</h2>
                        <p class="text-gray-400 text-sm mb-4">Raporlanan içerikler ve flag'li yorumlar.</p>
                        <ul class="space-y-4">${reports.length ? reports.map(r => `<li class="p-4 rounded border border-gray-800 flex justify-between items-center"><div><p class="font-bold">${r.targetType} #${r.targetId}</p><p class="text-sm text-gray-400">${r.reason} — ${getName(r.reporterUserId)}</p></div><span class="text-xs text-gray-500">${r.status || 'pending'}</span></li>`).join('') : '<li class="text-gray-500">Rapor yok.</li>'}</ul>
                    </div>
                </div>`;
            },

            settings: () => {
                const u = app.currentUser;
                const isDj = u && u.type === 'dj';
                const isVenue = u && u.type === 'venue';
                const isOrg = u && u.type === 'organizer';
                const isDecorator = u && u.type === 'decorator';
                const dp = isDj ? getProfile(u) : null;
                const vp = isVenue ? getProfile(u) : null;
                const op = isOrg ? getProfile(u) : null;
                const decP = isDecorator ? getProfile(u) : null;
                const anyProfile = getProfile(u);
                const social = anyProfile ? { instagram: anyProfile.instagram || '', tiktok: anyProfile.tiktok || '', x: anyProfile.x || '', facebook: anyProfile.facebook || '', whatsapp: anyProfile.whatsapp || '', telegram: anyProfile.telegram || '', soundcloud: anyProfile.soundcloud || '', bandcamp: anyProfile.bandcamp || '' } : { instagram: '', tiktok: '', x: '', facebook: '', whatsapp: '', telegram: '', soundcloud: '', bandcamp: '' };
                const driveLink = (dp && dp.googleDriveLink) ? dp.googleDriveLink : '';
                const djDriveBlock = isDj ? `
                        <div class="rounded-xl border border-gray-800 bg-gray-900/40 p-4 mb-6">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Google Drive portföy</div>
                            <p class="text-sm text-gray-400 mb-3">Genel Drive linkin. İlanlarda ve portföyünde kullanılır.</p>
                            <input type="url" id="settingsDriveLink" value="${escapeHtml(driveLink)}" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white placeholder-gray-500 mb-2" placeholder="https://drive.google.com/...">
                            <button type="button" onclick="SettingsAPI.saveDriveLink(document.getElementById(\'settingsDriveLink\').value.trim()); app.router(\'settings\');" class="w-full border border-brand-accent text-brand-glow py-2 rounded text-sm hover:bg-brand-accent/10">Drive linkini kaydet</button>
                        </div>
                        <div class="rounded-xl border border-gray-800 bg-gray-900/40 p-4 mb-6">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Tech Rider & Müzik örnekleri</div>
                            <label class="block text-sm text-gray-400 mb-1">Tech Rider</label>
                            <textarea id="settingsTechRider" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-20 mb-2" placeholder="Ekipman talepleriniz">${escapeHtml((dp && dp.techRider) || '')}</textarea>
                            <label class="block text-sm text-gray-400 mb-1">SoundCloud / Spotify embed URL</label>
                            <input type="text" id="settingsSoundcloud" value="${escapeHtml((dp && dp.soundcloudEmbed) || '')}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="SoundCloud">
                            <input type="text" id="settingsSpotify" value="${escapeHtml((dp && dp.spotifyEmbed) || '')}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="Spotify embed">
                            <button type="button" onclick="SettingsAPI.saveDjExtra(); app.router(\'settings\');" class="w-full border border-brand-glow text-brand-glow py-2 rounded text-sm hover:bg-brand-glow/10">Kaydet</button>
                        </div>` : '';
                const venueBlock = isVenue && vp ? `
                        <div class="rounded-xl border border-gray-800 bg-gray-900/40 p-4 mb-6">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Ekipman & Bilet politikası</div>
                            <label class="block text-sm text-gray-400 mb-1">Mekandaki ekipman (satır satır)</label>
                            <textarea id="settingsVenueEquipment" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16 mb-2">${escapeHtml(Array.isArray(vp.equipment) ? vp.equipment.join('\n') : (vp.equipment || ''))}</textarea>
                            <label class="block text-sm text-gray-400 mb-1">Bilet kesim yüzdesi (%)</label>
                            <input type="number" id="settingsTicketCutPct" min="0" max="100" step="0.5" value="${vp.ticketCutPercent != null ? vp.ticketCutPercent : ''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2">
                            <label class="block text-sm text-gray-400 mb-1">Bilet politikası metni</label>
                            <textarea id="settingsTicketPolicy" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-16 mb-2">${escapeHtml(vp.ticketPricePolicy || '')}</textarea>
                            <button type="button" onclick="SettingsAPI.saveVenueExtra(); app.router(\'settings\');" class="w-full border border-brand-accent text-brand-accent py-2 rounded text-sm hover:bg-brand-accent/10">Kaydet</button>
                        </div>` : '';
                const orgBlock = isOrg && op ? `
                        <div class="rounded-xl border border-gray-800 bg-gray-900/40 p-4 mb-6">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Organizasyon ücreti & Gereksinimler</div>
                            <label class="block text-sm text-gray-400 mb-1">Organizasyon ücreti (TL)</label>
                            <input type="number" id="settingsOrgFee" min="0" value="${op.organizationFee != null ? op.organizationFee : ''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2">
                            <label class="block text-sm text-gray-400 mb-1">Ücret yüzdesi (%)</label>
                            <input type="number" id="settingsOrgFeePct" min="0" max="100" step="0.5" value="${op.organizationFeePercent != null ? op.organizationFeePercent : ''}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2">
                            <label class="block text-sm text-gray-400 mb-1">Gereksinimler (satır satır)</label>
                            <textarea id="settingsOrgRequirements" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white h-20 mb-2">${escapeHtml(Array.isArray(op.requirements) ? op.requirements.join('\n') : (op.requirements || ''))}</textarea>
                            <label class="block text-sm text-gray-400 mb-1">İletişim telefonu</label>
                            <input type="text" id="settingsOrgPhone" value="${escapeHtml(op.contactPhone || '')}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2">
                            <button type="button" onclick="SettingsAPI.saveOrganizerExtra(); app.router(\'settings\');" class="w-full border border-brand-acid text-brand-acid py-2 rounded text-sm hover:bg-brand-acid/10">Kaydet</button>
                        </div>` : '';
                const socialBlock = `
                        <div class="rounded-xl border border-gray-800 bg-gray-900/40 p-4 mb-6">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Sosyal medya linkleri</div>
                            <p class="text-sm text-gray-400 mb-3">Profil ve ilanlarınızda görünecek. Her biri opsiyonel.</p>
                            <label class="block text-sm text-gray-400 mb-1">Instagram</label>
                            <input type="url" id="settingsInstagram" value="${escapeHtml(social.instagram)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://instagram.com/...">
                            <label class="block text-sm text-gray-400 mb-1">TikTok</label>
                            <input type="url" id="settingsTiktok" value="${escapeHtml(social.tiktok)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://tiktok.com/...">
                            <label class="block text-sm text-gray-400 mb-1">X (Twitter)</label>
                            <input type="url" id="settingsX" value="${escapeHtml(social.x)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://x.com/...">
                            <label class="block text-sm text-gray-400 mb-1">Facebook</label>
                            <input type="url" id="settingsFacebook" value="${escapeHtml(social.facebook)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://facebook.com/...">
                            <label class="block text-sm text-gray-400 mb-1">WhatsApp (link veya numara)</label>
                            <input type="text" id="settingsWhatsapp" value="${escapeHtml(social.whatsapp)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://wa.me/90... veya 905...">
                            <label class="block text-sm text-gray-400 mb-1">Telegram</label>
                            <input type="url" id="settingsTelegram" value="${escapeHtml(social.telegram)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://t.me/...">
                            <label class="block text-sm text-gray-400 mb-1">SoundCloud</label>
                            <input type="url" id="settingsSocialSoundcloud" value="${escapeHtml(social.soundcloud)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://soundcloud.com/...">
                            <label class="block text-sm text-gray-400 mb-1">Bandcamp</label>
                            <input type="url" id="settingsSocialBandcamp" value="${escapeHtml(social.bandcamp)}" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white mb-2" placeholder="https://...bandcamp.com/...">
                            <button type="button" onclick="SettingsAPI.saveSocialLinks(); app.router(\'settings\');" class="w-full border border-gray-500 text-gray-300 py-2 rounded text-sm hover:bg-white/5">Sosyal medya linklerini kaydet</button>
                        </div>`;
                return `
                <div class="h-full overflow-y-auto page-content">
                    <div class="max-w-lg mx-auto">
                        <h2 class="text-xl sm:text-2xl font-display font-bold mb-6">Ayarlar</h2>
                        ${djDriveBlock}
                        ${venueBlock}
                        ${orgBlock}
                        ${socialBlock}
                        <div class="rounded-xl border border-gray-800 bg-gray-900/40 p-4 mb-6">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">KVKK / Veri</div>
                            <p class="text-sm text-gray-400 mb-4">Verileriniz yerel depolamada (LocalStorage) tutulur. Hesap silindiğinde tüm veriler kaldırılır.</p>
                            <button onclick="SettingsAPI.exportData()" class="w-full border border-gray-700 text-gray-300 py-2 rounded text-sm hover:bg-white/5 mb-2">Verilerimi dışa aktar</button>
                            <button onclick="if(confirm(\'Tüm verileriniz silinecek. Emin misiniz?\')) SettingsAPI.deleteAccount();" class="w-full border border-red-800 text-red-400 py-2 rounded text-sm hover:bg-red-500/10">Hesabı sil</button>
                        </div>
                        ${USE_SUPABASE && supabase ? `<div class="rounded-xl border border-gray-700 bg-gray-900/40 p-4 mb-6">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Supabase RLS Self Test</div>
                            <p class="text-sm text-gray-400 mb-2">listings / messages / applications select ve yetkisiz erişim kontrolü.</p>
                            <button type="button" onclick="RLSAPI.runSelfTestUI()" class="w-full border border-amber-700 text-amber-300 py-2 rounded text-sm hover:bg-amber-500/10 mb-2">RLS SELF TEST çalıştır</button>
                            <div id="rlsTestResult" class="min-h-[2rem] text-sm text-gray-400"></div>
                        </div>` : ''}
                    </div>
                </div>`;
            },

            logoStudio: () => `
                <div class="logo-studio-wrap flex h-full min-h-0 flex-1">
                    <!-- LEFT SIDEBAR: CONTROLS -->
                    <div class="logo-studio-sidebar w-96 flex-none bg-brand-panel border-r border-gray-800 flex flex-col h-full min-h-0 z-10 overflow-y-auto">
                        <div class="p-4 border-b border-gray-800 bg-brand-dark flex-shrink-0">
                            <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-3">Hızlı Başlangıç (Presets)</h2>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="LogoEngine.loadPreset('minimal')" class="p-2 bg-gray-800 rounded hover:bg-white/10 text-xs flex flex-col items-center gap-1 transition"><i class="fa-solid fa-square"></i> Minimal</button>
                                <button onclick="LogoEngine.loadPreset('cyberpunk')" class="p-2 bg-gray-800 rounded hover:bg-brand-glow/20 text-xs flex flex-col items-center gap-1 transition text-brand-glow"><i class="fa-solid fa-bolt"></i> Cyber</button>
                                <button onclick="LogoEngine.loadPreset('industrial')" class="p-2 bg-gray-800 rounded hover:bg-brand-danger/20 text-xs flex flex-col items-center gap-1 transition text-brand-danger"><i class="fa-solid fa-industry"></i> Acid</button>
                                <button onclick="LogoEngine.loadPreset('metal3d')" class="p-2 bg-gray-800 rounded hover:bg-gray-600 text-xs flex flex-col items-center gap-1 transition"><i class="fa-solid fa-cube"></i> Metal</button>
                            </div>
                        </div>

                        <!-- PARAMETERS SCROLL AREA -->
                        <div class="sidebar-scroll flex-1 min-h-0 p-4 pb-8 space-y-1">
                            <!-- 0. KENDİ LOGONU YÜKLE -->
                            <div class="bg-gray-900/50 rounded border border-gray-800 overflow-hidden mb-3">
                                <div class="p-3 bg-gray-800/50 text-xs font-bold text-gray-300 uppercase tracking-wide flex items-center gap-2">
                                    <i class="fa-solid fa-upload"></i> Kendi logonu yükle
                                </div>
                                <div class="p-3 space-y-2">
                                    <p class="text-xs text-gray-500">PNG, JPG veya WebP. Önerilen: kare, max 2MB.</p>
                                    <input type="file" id="logoUploadInput" accept="image/png,image/jpeg,image/webp" class="w-full text-gray-400 text-xs file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:bg-brand-accent file:text-white file:text-xs" onchange="LogoUploadAPI.handleFile(this)">
                                    <div id="uploadedLogoPreviewWrap" class="mt-2 rounded border border-gray-700 overflow-hidden bg-black/50 flex flex-col items-center justify-center min-h-[80px]">
                                        <span id="uploadedLogoPreviewPlaceholder" class="text-gray-500 text-xs">Yüklenen logo burada görünecek</span>
                                        <img id="uploadedLogoPreview" src="" alt="Yüklenen logo" class="max-h-20 max-w-full object-contain hidden">
                                        <button type="button" id="logoUploadRemoveBtn" onclick="LogoUploadAPI.remove()" class="mt-2 text-xs text-gray-500 hover:text-red-400 hidden">Yüklenen logoyu kaldır</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 1. KIMLIK -->
                            ${createAccordion('Kimlik & Metin', 'identity', `
                                <div class="space-y-3 p-2">
                                    <input type="text" id="param_text" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white font-bold" oninput="LogoEngine.params.text=this.value; LogoEngine.draw()">
                                    <input type="text" id="param_tagline" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white text-sm" placeholder="Slogan..." oninput="LogoEngine.params.tagline=this.value; LogoEngine.draw()">
                                </div>
                            `)}

                            <!-- 2. LAYOUT -->
                            ${createAccordion('Layout & Kompozisyon', 'layout', `
                                ${createSelect('param_layout_preset', 'Preset', ['stacked','inline','poster'], 'layout.preset')}
                                ${createSlider('param_layout_iconScale', 'İkon Boyutu', 0, 200, 'layout.iconScale')}
                                ${createSlider('param_layout_textScale', 'Yazı Boyutu', 0, 200, 'layout.textScale')}
                                ${createSlider('param_layout_spacing', 'Boşluk', -50, 200, 'layout.spacing')}
                                ${createSlider('param_layout_perspective', 'Perspektif (3D Tilt)', -30, 30, 'layout.perspective')}
                            `)}

                            <!-- 3. TYPOGRAPHY -->
                            ${createAccordion('Tipografi', 'typography', `
                                ${createSelect('param_typography_font', 'Font', ['Orbitron','Inter','Bebas Neue','Syncopate','Audiowide'], 'typography.font')}
                                ${createSlider('param_typography_weight', 'Kalınlık', 100, 900, 'typography.weight')}
                                ${createSlider('param_typography_tracking', 'Harf Aralığı', 0, 50, 'typography.tracking')}
                                ${createSlider('param_typography_stroke', 'Kontur (Outline)', 0, 10, 'typography.stroke')}
                                ${createSlider('param_typography_slant', 'Eğim (Italic)', 0, 20, 'typography.slant')}
                            `)}

                            <!-- 4. ICON & FRAME -->
                            ${createAccordion('İkon & Çerçeve', 'icon', `
                                ${createSelect('param_icon_preset', 'Şekil', ['none','sigil1','dna','ring'], 'icon.preset')}
                                ${createSlider('param_icon_stroke', 'Çizgi Kalınlığı', 1, 20, 'icon.stroke')}
                                ${createSelect('param_icon_coreType', 'Merkez Çekirdek', ['none','dot','gem'], 'icon.coreType')}
                                ${createSlider('param_icon_coreGlow', 'Çekirdek Parlaklığı', 0, 100, 'icon.coreGlow')}
                                <div class="h-px bg-white/10 my-2"></div>
                                ${createSelect('param_frame_type', 'Çerçeve Tipi', ['none','rect','double','tech'], 'frame.type')}
                                ${createSlider('param_frame_thickness', 'Çerçeve Kalınlığı', 0, 20, 'frame.thickness')}
                            `)}

                            <!-- 5. MATERIAL & LIGHT -->
                            ${createAccordion('Malzeme & 3D', 'material', `
                                ${createSelect('param_material_preset', 'Materyal', ['matte','chrome','neon','gunmetal'], 'material.preset')}
                                ${createSlider('param_material_extrude', '3D Derinlik', 0, 80, 'material.extrude')}
                                ${createSlider('param_material_bevel', 'Kabartma (Bevel)', 0, 20, 'material.bevel')}
                                ${createSlider('param_material_ao', 'Gölge (AO)', 0, 100, 'material.ao')}
                            `)}

                            <!-- 6. COLORS -->
                            ${createAccordion('Renkler', 'color', `
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <input type="color" id="param_color_primary" class="w-full h-8 rounded cursor-pointer" oninput="LogoEngine.updateParam('color.primary', this.value)">
                                    <input type="color" id="param_color_secondary" class="w-full h-8 rounded cursor-pointer" oninput="LogoEngine.updateParam('color.secondary', this.value)">
                                </div>
                                ${createSelect('param_color_gradient', 'Gradient', ['none','linear','radial'], 'color.gradient')}
                            `)}

                            <!-- 7. FX & BG -->
                            ${createAccordion('Efektler & Arka Plan', 'fx', `
                                ${createSlider('param_fx_glow', 'Glow', 0, 100, 'fx.glow')}
                                ${createSlider('param_fx_glitch', 'Glitch', 0, 100, 'fx.glitch')}
                                ${createSlider('param_fx_vignette', 'Vignette', 0, 100, 'fx.vignette')}
                                <div class="flex items-center justify-between py-1">
                                    <span class="text-xs text-gray-400">Lens Flare</span>
                                    <input type="checkbox" id="param_fx_flare" class="accent-brand-accent" onchange="LogoEngine.updateParam('fx.flare', this.checked)">
                                </div>
                                <div class="flex items-center justify-between py-1">
                                    <span class="text-xs text-gray-400">Scanlines</span>
                                    <input type="checkbox" id="param_fx_scanlines" class="accent-brand-accent" onchange="LogoEngine.updateParam('fx.scanlines', this.checked)">
                                </div>
                                <div class="h-px bg-white/10 my-2"></div>
                                ${createSelect('param_background_type', 'Arkaplan', ['solid','nebula','grid','smoke'], 'background.type')}
                                <input type="color" id="param_background_color" class="w-full h-6 rounded cursor-pointer mt-2" oninput="LogoEngine.updateParam('background.color', this.value)">
                            `)}
                        </div>

                        <!-- EXPORT BAR -->
                        <div class="p-4 border-t border-gray-800 bg-brand-dark space-y-2 flex-shrink-0">
                            <button onclick="(function(){ var c = document.getElementById('logoCanvas'); if(c){ var a = document.createElement('a'); a.href = c.toDataURL('image/png'); a.download = 'gigcore-logo.png'; a.click(); } })()" class="w-full bg-brand-accent text-white font-bold py-2 rounded text-sm hover:bg-violet-600 transition">LOGOYU İNDİR (PNG)</button>
                            <button onclick="(function(){ if(LogoEngine.canvas && app.currentUser){ const list = Store.get('djProfiles'); const i = list.findIndex(p => p.userId === app.currentUser.id); if(i>=0) list[i].logoDataUrl = LogoEngine.canvas.toDataURL('image/png'); Store.set('djProfiles', list); } app.router('dashboard'); })()" class="w-full border border-gray-700 text-gray-400 py-2 rounded text-sm hover:text-white transition">KAYDET VE ÇIK</button>
                            <div class="text-xs font-bold text-gray-400 uppercase mt-3 mb-2">Logoyu sosyal medyada paylaş</div>
                            <button onclick="(function(){ var c = document.getElementById('logoCanvas'); if(!c || !navigator.share) return; c.toBlob(function(blob){ if(!blob) return; var f = new File([blob], 'gigcore-logo.png', { type: 'image/png' }); navigator.share({ title: 'GigCore Logo', text: 'GigCore\'da logomu tasarladım', files: [f] }).catch(function(){}); }); })()" class="w-full border border-brand-glow text-brand-glow py-2 rounded text-sm hover:bg-brand-glow/10 transition">Cihazda paylaş</button>
                            <p class="text-xs text-gray-500 mt-1">X, WhatsApp, Telegram: aşağıdaki butonlarla paylaşım sayfası açılır; logoyu önce indirip ekleyebilirsiniz.</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <a href="#" onclick="var t=encodeURIComponent('GigCore\'da logomu tasarladım'); window.open('https://twitter.com/intent/tweet?text='+t, '_blank', 'noopener'); return false;" class="flex-1 min-w-0 px-2 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs text-center"><i class="fa-brands fa-x-twitter mr-1"></i>X</a>
                                <a href="#" onclick="var t=encodeURIComponent('GigCore\'da logomu tasarladım'); window.open('https://wa.me/?text='+t, '_blank', 'noopener'); return false;" class="flex-1 min-w-0 px-2 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs text-center"><i class="fa-brands fa-whatsapp mr-1"></i>WhatsApp</a>
                                <a href="#" onclick="var t=encodeURIComponent('GigCore\'da logomu tasarladım'); window.open('https://t.me/share/url?url='+encodeURIComponent(window.location.href)+'&text='+t, '_blank', 'noopener'); return false;" class="flex-1 min-w-0 px-2 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs text-center"><i class="fa-brands fa-telegram mr-1"></i>Telegram</a>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Instagram ve TikTok için önce &quot;Logoyu indir&quot; ile PNG alıp uygulama içinden paylaşın.</p>
                        </div>
                    </div>

                    <!-- RIGHT AREA: CANVAS VIEWER -->
                    <div class="logo-studio-canvas-wrap flex-grow bg-black relative flex items-center justify-center overflow-hidden min-h-0">
                        <!-- Grid Background Pattern -->
                        <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 40px 40px;"></div>
                        
                        <div class="relative z-10 shadow-2xl border border-gray-800 rounded-lg overflow-hidden bg-black">
                            <canvas id="logoCanvas" width="800" height="600" class="max-w-[80vw] max-h-[80vh] object-contain"></canvas>
                        </div>

                        <!-- Overlay Info -->
                        <div class="absolute bottom-4 right-4 text-xs text-gray-600 font-mono">
                            RENDER ENGINE v2.0 | <span class="text-brand-glow">WEBGL SIMULATED</span>
                        </div>
                    </div>
                </div>
            `
        };

        // --- UI HELPERS ---
        function toggleAccordion(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(id + '_icon');
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                el.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function createAccordion(title, id, content) {
            return `
                <div class="bg-gray-900/50 rounded border border-gray-800 overflow-hidden">
                    <div class="control-header p-3 flex justify-between items-center text-xs font-bold text-gray-300 uppercase tracking-wide bg-gray-800/50" onclick="toggleAccordion('${id}_content')">
                        ${title}
                        <i id="${id}_content_icon" class="fa-solid fa-chevron-down transition-transform duration-200"></i>
                    </div>
                    <div id="${id}_content" class="p-3 space-y-3 ${id === 'layout' || id === 'identity' ? '' : 'hidden'}">
                        ${content}
                    </div>
                </div>
            `;
        }

        function createSlider(id, label, min, max, paramPath) {
            return `
                <div>
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>${label}</span>
                        <span id="${id}_val" class="text-brand-glow"></span>
                    </div>
                    <input type="range" id="${id}" min="${min}" max="${max}" oninput="document.getElementById('${id}_val').innerText=this.value; LogoEngine.updateParam('${paramPath}', this.value)">
                </div>
            `;
        }

        function createSelect(id, label, options, paramPath) {
            return `
                <div>
                    <label class="block text-xs text-gray-500 mb-1">${label}</label>
                    <select id="${id}" class="w-full bg-black border border-gray-700 rounded text-xs p-1 text-white uppercase focus:border-brand-accent outline-none" onchange="LogoEngine.updateParam('${paramPath}', this.value)">
                        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                </div>
            `;
        }

        // --- FORM / API HANDLERS ---
        const RegisterAPI = {
            submit: async () => {
                const role = window._registerRole;
                if (!role) { alert('Lütfen üyelik türünü seçin: DJ, Mekan veya Organizatör.'); return; }
                const name = document.getElementById('regName').value.trim();
                const email = document.getElementById('regEmail').value.trim();
                const pass = document.getElementById('regPass').value;
                const city = (document.getElementById('regLocation') && document.getElementById('regLocation').value) ? document.getElementById('regLocation').value.trim() : '';
                if (!name || !email || !pass) { alert('Ad, email ve şifre zorunludur.'); return; }
                if (USE_SUPABASE && supabase) {
                    const { data, error } = await supabase.auth.signUp({ email, password: pass });
                    if (error) { showSupabaseError(error, 'signUp'); alert(error.message || 'Kayıt başarısız.'); return; }
                    const uid = data.user.id;
                    await supabase.from('profiles').insert({ user_id: uid, role, display_name: name, city });
                    if (role === 'dj') await supabase.from('dj_profiles').insert({ user_id: uid, genres: [], bpm_min: 120, bpm_max: 130, nightly_fee: 0, bio: '', tech_rider: '', equipment_provided: [], soundcloud_embed: '', spotify_embed: '', mixcloud_embed: '', min_notice_days: null, travel_radius_km: null });
                    if (role === 'venue') await supabase.from('venue_profiles').insert({ user_id: uid, venue_name: name, city, capacity: '', typical_genres: [], budget_range: '', equipment: [], ticket_price_policy: '', ticket_cut_percent: null, ticket_cut_amount: null, percentage_policies: '' });
                    if (role === 'organizer') await supabase.from('organizer_profiles').insert({ user_id: uid, organizer_name: name, city, network_tags: [], organization_fee: null, organization_fee_percent: null, requirements: [], contact_phone: '' });
                    if (role === 'decorator') await supabase.from('decorator_profiles').insert({ user_id: uid, business_name: name, city, service_area_km: null, categories: [], portfolio_drive_links: [] });
                    await supabase.from('common_profiles').insert({ user_id: uid, display_name: name, bio: '', languages: [], tags: [], working_cities: [], show_email: false, show_phone: false, allow_direct_booking: true, preferred_contact_method: 'in_app', last_updated: Date.now() });
                    const user = { id: uid, email, type: role, name };
                    Store.setCurrentUser(user);
                    app.currentUser = user;
                    app.updateNav();
                    await SupabaseDataService.loadProfilesAndUsers();
                    app.router('onboarding');
                    return;
                }
                const users = Store.get('users');
                if (users.some(u => u.email === email)) { alert('Bu email zaten kayıtlı.'); return; }
                const id = nextId('users');
                const user = { id, type: role, name, email, password: pass, location: city, createdAt: Date.now(), status: 'active', xp: 0, level: 1, badges: [] };
                users.push(user);
                Store.set('users', users);
                var socialEmpty = { instagram: '', tiktok: '', x: '', facebook: '', whatsapp: '', telegram: '', soundcloud: '', bandcamp: '' };
                if (role === 'dj') { const dp = Store.get('djProfiles'); dp.push({ userId: id, genres: [], bpmMin: 120, bpmMax: 130, nightlyFee: 0, bio: '', logoDataUrl: null, setSamples: [], googleDriveLink: null, techRider: '', equipmentProvided: [], soundcloudEmbed: '', spotifyEmbed: '', mixcloudEmbed: '', minNoticeDays: null, travelRadiusKm: null, ...socialEmpty }); Store.set('djProfiles', dp); }
                if (role === 'venue') { const vp = Store.get('venueProfiles'); vp.push({ userId: id, venueName: name, city: '', capacity: '', typicalGenres: [], budgetRange: '', contactPrefs: '', equipment: [], ticketPricePolicy: '', ticketCutPercent: null, ticketCutAmount: null, percentagePolicies: '', lat: null, lng: null, address: '', ...socialEmpty }); Store.set('venueProfiles', vp); }
                if (role === 'organizer') { const op = Store.get('organizerProfiles'); op.push({ userId: id, organizerName: name, city: '', networkTags: [], organizationFee: null, organizationFeePercent: null, requirements: [], contactPhone: '', ...socialEmpty }); Store.set('organizerProfiles', op); }
                if (role === 'decorator') { const dp = Store.get('decoratorProfiles'); dp.push({ userId: id, businessName: name, city: '', serviceAreaKm: null, categories: [], portfolioDriveLinks: [], ...socialEmpty }); Store.set('decoratorProfiles', dp); }
                var cp = Store.get('commonProfiles') || [];
                if (!cp.find(p => p.userId === id)) cp.push({ userId: id, displayName: (name || '').trim(), avatarDataUrl: null, coverDataUrl: null, bio: '', languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: true, preferredContactMethod: 'in_app', lastUpdated: Date.now() });
                Store.set('commonProfiles', cp);
                Store.setCurrentUser(user);
                app.currentUser = user;
                app.updateNav();
                app.router('onboarding');
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // ═══════════════════════════════════════════════════════════
            // 1) UI ÖNCE HAZIR OLSUN — Supabase'den bağımsız çalışır.
            //    Butonlar, nav, router hemen aktif.
            // ═══════════════════════════════════════════════════════════
            app.init();

            // ═══════════════════════════════════════════════════════════
            // 2) SUPABASE BOOTSTRAP — hata olursa UI çalışmaya devam eder.
            // ═══════════════════════════════════════════════════════════
            try {
                // Runtime config yükle (key'ler /api/public-config'den gelir)
                await __loadRuntimeConfig();

                if (USE_SUPABASE && SUPABASE_URL && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.length > 50) {
                    const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    await SupabaseDataService.loadAll();
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session && session.user) {
                        const { data: prof } = await supabase.from('profiles').select('*').eq('user_id', session.user.id).single();
                        __cache.currentUser = prof ? { id: session.user.id, email: session.user.email, type: prof.role, name: prof.display_name || session.user.email } : { id: session.user.id, email: session.user.email, type: 'dj', name: session.user.email };
                    }
                    supabase.auth.onAuthStateChange(async (ev, s) => {
                        if (!s || !s.user) { __cache.currentUser = null; app.updateNav(); app.router('home'); return; }
                        const { data: prof } = await supabase.from('profiles').select('*').eq('user_id', s.user.id).single();
                        __cache.currentUser = prof ? { id: s.user.id, email: s.user.email, type: prof.role, name: prof.display_name || s.user.email } : { id: s.user.id, email: s.user.email, type: 'dj', name: s.user.email };
                        app.currentUser = __cache.currentUser;
                        app.updateNav();
                        await SupabaseDataService.loadMessages();
                    });
                    app._realtime = app._realtime || {};
                    if (!app._realtime.listings) {
                        const chList = supabase.channel('listings-rt');
                        chList.on('postgres_changes', { event: '*', schema: 'public', table: 'listings' }, async () => { await SupabaseDataService.loadListings(); if (app._currentView === 'listings') app.router('listings'); });
                        chList.subscribe();
                        app._realtime.listings = chList;
                    }
                    if (!app._realtime.messages) {
                        const chMsg = supabase.channel('messages-rt');
                        chMsg.on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, async () => { if (app.currentUser) await SupabaseDataService.loadMessages(); if (app._currentView === 'messages') app.router('messages', app._routeParams); });
                        chMsg.subscribe();
                        app._realtime.messages = chMsg;
                    }
                    // Supabase başarılı — UI'ı güncelle (session varsa dashboard'a geç)
                    app.currentUser = Store.getCurrentUser ? Store.getCurrentUser() : null;
                    app.updateNav();
                    if (app.currentUser) {
                        if (typeof hasCompletedOnboarding === 'function' && !hasCompletedOnboarding(app.currentUser)) app.router('onboarding');
                        else app.router('dashboard');
                    }
                }
            } catch (e) {
                console.error('[BOOTSTRAP FAIL]', e);
                if (typeof showSupabaseError === 'function') showSupabaseError(e, 'bootstrap');
                if (ALLOW_LOCAL_FALLBACK) { USE_SUPABASE = false; supabase = null; }
                else { app._supabaseOffline = true; supabase = null; var ob = document.getElementById('offlineBanner'); if (ob) ob.classList.remove('hidden'); }
            }
            // CoreMind Background v1: parallax (mouse) + Strategy B watermark
            if (typeof COREMIND_LOGO_URL === 'string' && COREMIND_LOGO_URL.length > 0) {
                document.documentElement.style.setProperty('--coremind-watermark-url', 'url(' + COREMIND_LOGO_URL + ')');
            }
            var cmPending = { mx: 0, my: 0 };
            var cmRaf = null;
            var reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            function cmSetVars() {
                document.documentElement.style.setProperty('--cm-mx', String(cmPending.mx));
                document.documentElement.style.setProperty('--cm-my', String(cmPending.my));
                cmRaf = null;
            }
            if (!reduceMotion) {
                document.addEventListener('pointermove', function(e) {
                    var w = window.innerWidth, h = window.innerHeight;
                    if (w <= 0 || h <= 0) return;
                    cmPending.mx = (e.clientX / w) - 0.5;
                    cmPending.my = (e.clientY / h) - 0.5;
                    if (cmRaf === null) cmRaf = requestAnimationFrame(cmSetVars);
                }, { passive: true });
            }
            document.body.addEventListener('submit', (e) => {
                const form = e.target;
                if (form.id === 'loginForm') {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const pass = document.getElementById('loginPass').value;
                    if (USE_SUPABASE && supabase) {
                        (async () => {
                            const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
                            if (error) { showSupabaseError(error, 'signIn'); return; }
                            const { data: prof } = await supabase.from('profiles').select('*').eq('user_id', data.user.id).single();
                            const user = prof ? { id: data.user.id, email: data.user.email, type: prof.role, name: prof.display_name || data.user.email } : { id: data.user.id, email: data.user.email, type: 'dj', name: data.user.email };
                            Store.setCurrentUser(user);
                            app.currentUser = user;
                            app.updateNav();
                            if (!hasCompletedOnboarding(user)) app.router('onboarding');
                            else app.router('dashboard');
                        })();
                        return;
                    }
                    const user = Store.get('users').find(u => u.email === email && u.password === pass);
                    if (!user) { alert('Email veya şifre hatalı.'); return; }
                    Store.setCurrentUser(user);
                    app.currentUser = user;
                    app.updateNav();
                    if (!hasCompletedOnboarding(user)) app.router('onboarding');
                    else app.router('dashboard');
                }
                if (form.id === 'registerForm') { e.preventDefault(); RegisterAPI.submit(); }
                if (form.id === 'onboardDjForm') {
                    e.preventDefault();
                    const u = app.currentUser;
                    const genres = [...form.querySelectorAll('input[name="genre"]:checked')].map(c => c.value);
                    if (!genres.length) { alert('En az bir tarz seçin.'); return; }
                    const list = Store.get('djProfiles');
                    const idx = list.findIndex(p => p.userId === u.id);
                    const p = list[idx] || {};
                    p.genres = genres;
                    p.bpmMin = clampBPM(document.getElementById('obBpmMin').value);
                    p.bpmMax = clampBPM(document.getElementById('obBpmMax').value);
                    p.nightlyFee = parseInt(document.getElementById('obFee').value, 10) || 0;
                    p.bio = document.getElementById('obBio').value.trim();
                    p.techRider = (document.getElementById('obTechRider') && document.getElementById('obTechRider').value) ? document.getElementById('obTechRider').value.trim() : '';
                    var eqEl = document.getElementById('obEquipmentProvided');
                    p.equipmentProvided = eqEl && eqEl.value ? eqEl.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean) : [];
                    p.soundcloudEmbed = (document.getElementById('obSoundcloud') && document.getElementById('obSoundcloud').value) ? document.getElementById('obSoundcloud').value.trim() : '';
                    p.spotifyEmbed = (document.getElementById('obSpotify') && document.getElementById('obSpotify').value) ? document.getElementById('obSpotify').value.trim() : '';
                    var mn = document.getElementById('obMinNotice'); p.minNoticeDays = mn && mn.value ? parseInt(mn.value, 10) : null;
                    var tk = document.getElementById('obTravelKm'); p.travelRadiusKm = tk && tk.value ? parseInt(tk.value, 10) : null;
                    var obDrive = document.getElementById('obGoogleDrive');
                    p.googleDriveLink = (obDrive && obDrive.value) ? obDrive.value.trim() : null;
                    if (idx >= 0) list[idx] = p; else list.push(p);
                    Store.set('djProfiles', list);
                    app.router('dashboard');
                }
                if (form.id === 'onboardVenueForm') {
                    e.preventDefault();
                    const u = app.currentUser;
                    const list = Store.get('venueProfiles');
                    const idx = list.findIndex(p => p.userId === u.id);
                    const typicalGenres = [...form.querySelectorAll('input[name="vGenre"]:checked')].map(c => c.value);
                    var eqT = (document.getElementById('obEquipment') && document.getElementById('obEquipment').value) ? document.getElementById('obEquipment').value.trim().split(/\n/).map(s => s.trim()).filter(Boolean) : [];
                    var tcp = document.getElementById('obTicketCutPct'); var tca = document.getElementById('obTicketCutAmt');
                    const p = { userId: u.id, venueName: document.getElementById('obVenueName').value.trim(), city: document.getElementById('obCity').value.trim(), address: (document.getElementById('obAddress') && document.getElementById('obAddress').value) ? document.getElementById('obAddress').value.trim() : '', capacity: (document.getElementById('obCapacity') && document.getElementById('obCapacity').value) ? document.getElementById('obCapacity').value.trim() : '', typicalGenres, budgetRange: (document.getElementById('obBudget') && document.getElementById('obBudget').value) ? document.getElementById('obBudget').value.trim() : '', contactPrefs: (list[idx] && list[idx].contactPrefs) ? list[idx].contactPrefs : '', equipment: eqT, ticketPricePolicy: (document.getElementById('obTicketPolicy') && document.getElementById('obTicketPolicy').value) ? document.getElementById('obTicketPolicy').value.trim() : '', ticketCutPercent: tcp && tcp.value ? parseFloat(tcp.value) : null, ticketCutAmount: tca && tca.value ? parseFloat(tca.value) : null, percentagePolicies: (document.getElementById('obPctPolicies') && document.getElementById('obPctPolicies').value) ? document.getElementById('obPctPolicies').value.trim() : '', lat: (list[idx] && list[idx].lat) != null ? list[idx].lat : null, lng: (list[idx] && list[idx].lng) != null ? list[idx].lng : null };
                    if (idx >= 0) list[idx] = p; else list.push(p);
                    Store.set('venueProfiles', list);
                    app.router('dashboard');
                }
                if (form.id === 'onboardOrgForm') {
                    e.preventDefault();
                    const u = app.currentUser;
                    const list = Store.get('organizerProfiles');
                    const idx = list.findIndex(p => p.userId === u.id);
                    const tags = document.getElementById('obNetworkTags').value.trim().split(',').map(s => s.trim()).filter(Boolean);
                    var reqEl = document.getElementById('obRequirements');
                    var reqList = reqEl && reqEl.value ? reqEl.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean) : [];
                    var ofEl = document.getElementById('obOrgFee'); var ofpEl = document.getElementById('obOrgFeePct');
                    const p = { userId: u.id, organizerName: document.getElementById('obOrgName').value.trim(), city: document.getElementById('obOrgCity').value.trim(), networkTags: tags, contactPhone: (document.getElementById('obOrgPhone') && document.getElementById('obOrgPhone').value) ? document.getElementById('obOrgPhone').value.trim() : '', organizationFee: ofEl && ofEl.value ? parseFloat(ofEl.value) : null, organizationFeePercent: ofpEl && ofpEl.value ? parseFloat(ofpEl.value) : null, requirements: reqList };
                    if (idx >= 0) list[idx] = p; else list.push(p);
                    Store.set('organizerProfiles', list);
                    app.router('dashboard');
                }
                if (form.id === 'onboardDecorForm') {
                    e.preventDefault();
                    const u = app.currentUser;
                    const list = Store.get('decoratorProfiles');
                    const idx = list.findIndex(p => p.userId === u.id);
                    var areaEl = document.getElementById('obDecorArea');
                    const p = { userId: u.id, businessName: (document.getElementById('obDecorBusiness') && document.getElementById('obDecorBusiness').value) ? document.getElementById('obDecorBusiness').value.trim() : '', city: (document.getElementById('obDecorCity') && document.getElementById('obDecorCity').value) ? document.getElementById('obDecorCity').value.trim() : '', serviceAreaKm: areaEl && areaEl.value ? parseInt(areaEl.value, 10) : null, categories: (list[idx] && list[idx].categories) ? list[idx].categories : [], portfolioDriveLinks: (list[idx] && list[idx].portfolioDriveLinks) ? list[idx].portfolioDriveLinks : [] };
                    if (idx >= 0) list[idx] = p; else list.push(p);
                    Store.set('decoratorProfiles', list);
                    app.router('dashboard');
                }
                if (form.id === 'setUploadForm') {
                    e.preventDefault();
                    const title = document.getElementById('setTitle').value.trim();
                    const duration = parseInt(document.getElementById('setDuration').value, 10) || 60;
                    const driveUrlEl = document.getElementById('setDriveUrl');
                    const driveUrl = (driveUrlEl && driveUrlEl.value) ? driveUrlEl.value.trim() : null;
                    const file = document.getElementById('setFile').files[0];
                    const list = Store.get('setUploads');
                    const id = nextId('setUploads');
                    list.push({ id, djUserId: app.currentUser.id, title, duration, driveUrl: driveUrl || null, fileMeta: file ? { name: file.name, size: file.size } : null, storageRef: null, createdAt: Date.now(), moderationStatus: 'ok' });
                    Store.set('setUploads', list);
                    app.router('set-upload');
                }
                if (form.id === 'listingForm') {
                    e.preventDefault();
                    if (app._supabaseOffline) { showToast('Sunucu bağlantısı yok.'); return; }
                    const rawType = document.getElementById('listingType').value;
                    if (rawType === 'decorRental' || rawType === LISTING_TYPE.DECOR_RENTAL) {
                        const title = document.getElementById('listingTitle').value.trim();
                        const city = document.getElementById('listingCity').value.trim();
                        const pricingModel = (document.getElementById('listingPricingModel') && document.getElementById('listingPricingModel').value) || 'perNight';
                        const priceVal = document.getElementById('listingPrice') ? parseFloat(document.getElementById('listingPrice').value) : 0;
                        const imagesRaw = (document.getElementById('listingImagesDrive') && document.getElementById('listingImagesDrive').value) ? document.getElementById('listingImagesDrive').value.trim().split(/\n/).map(s => s.trim()).filter(Boolean) : [];
                        const imagesDriveUrls = imagesRaw.filter(u => isSafeUrl(u));
                        const payload = { title, city, pricingModel, price: priceVal, currency: 'TRY', imagesDriveUrls };
                        const errs = validateDecorListing(payload);
                        if (errs.length) { alert(errs.join('\n')); return; }
                        const listing = {
                            createdByUserId: app.currentUser.id,
                            listingType: LISTING_TYPE.DECOR_RENTAL,
                            ownerRole: 'decorator',
                            title,
                            city,
                            visibility: 'public',
                            status: 'active',
                            pricingModel,
                            price: priceVal,
                            currency: 'TRY',
                            imagesDriveUrls,
                            deposit: (document.getElementById('listingDeposit') && document.getElementById('listingDeposit').value) ? parseFloat(document.getElementById('listingDeposit').value) : null,
                            setupFee: (document.getElementById('listingSetupFee') && document.getElementById('listingSetupFee').value) ? parseFloat(document.getElementById('listingSetupFee').value) : null,
                            deliveryIncluded: !!(document.getElementById('listingDeliveryIncluded') && document.getElementById('listingDeliveryIncluded').checked),
                            notes: (document.getElementById('listingNotes') && document.getElementById('listingNotes').value) ? document.getElementById('listingNotes').value.trim() : null
                        };
                        if (USE_SUPABASE && supabase) {
                            (async () => { const row = SupabaseDataService.listingToRow(listing); const { error } = await supabase.from('listings').insert(row); if (error) { showSupabaseError(error, 'listing insert'); return; } await SupabaseDataService.loadListings(); app.router('listings'); })();
                            return;
                        }
                        listing.id = nextId('listings'); listing.createdAt = Date.now();
                        const list = Store.get('listings'); list.push(listing); Store.set('listings', list);
                        app.router('listings');
                        return;
                    }
                    const genres = [...form.querySelectorAll('input[name="listingGenre"]:checked')].map(c => c.value);
                    const lt = document.getElementById('listingType').value;
                    const ownerRole = (lt === 'VENUE_NEEDS' || lt === 'venueNeeds') ? 'venue' : (lt === 'ORGANIZER_EVENT' || lt === 'organizerEvent') ? 'organizer' : 'dj';
                    const listing = {
                        createdByUserId: app.currentUser.id,
                        ownerRole,
                        listingType: lt,
                        title: document.getElementById('listingTitle').value.trim(),
                        genres,
                        bpmTargetMin: clampBPM(document.getElementById('listingBpmMin').value) || null,
                        bpmTargetMax: clampBPM(document.getElementById('listingBpmMax').value) || null,
                        hours: parseFloat(document.getElementById('listingHours').value) || null,
                        date: document.getElementById('listingDate').value || null,
                        city: document.getElementById('listingCity').value.trim() || null,
                        budget: document.getElementById('listingBudget').value.trim() || null,
                        notes: document.getElementById('listingNotes').value.trim() || null,
                        visibility: 'public',
                        status: 'active',
                        createdAt: Date.now()
                    };
                    var el = document.getElementById('listingEquipment');
                    if (el && el.value) listing.equipmentProvided = el.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean);
                    el = document.getElementById('listingTicketInfo'); if (el && el.value) listing.ticketInfo = el.value.trim();
                    el = document.getElementById('listingTicketCutMode'); if (el && el.value) listing.ticketCutMode = el.value;
                    el = document.getElementById('listingTicketCutPct'); if (el && el.value) listing.ticketCutPercent = parseFloat(el.value);
                    el = document.getElementById('listingTicketCutAmt'); if (el && el.value) listing.ticketCutAmount = parseFloat(el.value);
                    el = document.getElementById('listingPctPolicies'); if (el && el.value) listing.percentagePolicies = el.value.trim();
                    el = document.getElementById('listingOrgFeeModel'); if (el && el.value) listing.organizerFeeModel = el.value;
                    el = document.getElementById('listingOrgFee'); if (el && el.value) listing.organizerFee = parseFloat(el.value);
                    el = document.getElementById('listingOrgFeePercent'); if (el && el.value) listing.organizerFeePercent = parseFloat(el.value);
                    el = document.getElementById('listingRequirements'); if (el && el.value) listing.requirements = el.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean);
                    el = document.getElementById('listingDeliverables'); if (el && el.value) listing.deliverables = el.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean);
                    var rbf = document.getElementById('listingRateBaseFee'); var reh = document.getElementById('listingRateExtraHour'); var rtr = document.getElementById('listingRateTravel'); var rap = document.getElementById('listingRateAfterParty'); var rdp = document.getElementById('listingRateDeposit');
                    listing.rate = { baseFee: rbf && rbf.value ? parseFloat(rbf.value) : null, extraHourFee: reh && reh.value ? parseFloat(reh.value) : null, travelFee: rtr && rtr.value ? parseFloat(rtr.value) : null, afterPartyFee: rap && rap.value ? parseFloat(rap.value) : null, depositAmount: rdp && rdp.value ? parseFloat(rdp.value) : null };
                    el = document.getElementById('listingTechRiderOverride'); if (el && el.value) listing.techRiderOverride = el.value.trim();
                    el = document.getElementById('listingSoundcheckMinutes'); if (el && el.value) listing.soundcheckMinutes = parseInt(el.value, 10);
                    el = document.getElementById('listingDemoLinks'); if (el && el.value) listing.demoLinks = el.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean);
                    el = document.getElementById('listingCancelPolicy'); if (el && el.value) listing.cancelPolicy = el.value;
                    var atc = form.querySelectorAll('input[name="listingAcceptedTicket"]:checked'); listing.acceptedTicketModels = atc.length ? [...atc].map(c => c.value) : [];
                    el = document.getElementById('listingEquipmentRequested'); if (el && el.value) listing.equipmentRequested = el.value.trim();
                    if (USE_SUPABASE && supabase) {
                        (async () => { const row = SupabaseDataService.listingToRow(listing); const { error } = await supabase.from('listings').insert(row); if (error) { showSupabaseError(error, 'listing insert'); return; } await SupabaseDataService.loadListings(); app.router('listings'); })();
                        return;
                    }
                    listing.id = nextId('listings');
                    const list = Store.get('listings');
                    list.push(listing);
                    Store.set('listings', list);
                    app.router('listings');
                }
                if (form.id === 'connectionForm') {
                    e.preventDefault();
                    const toId = parseInt(document.getElementById('connToUser').value, 10);
                    const type = document.getElementById('connType').value;
                    const message = document.getElementById('connMessage').value.trim();
                    const list = Store.get('connections');
                    list.push({ id: nextId('connections'), fromUserId: app.currentUser.id, toUserId: toId, type, message, trustLevel: 1, createdAt: Date.now() });
                    Store.set('connections', list);
                    app.router('connections');
                }
                if (form.id === 'reviewForm') {
                    e.preventDefault();
                    const targetType = document.getElementById('reviewTargetType').value;
                    const targetId = parseInt(document.getElementById('reviewTargetId').value, 10);
                    const rating = parseInt(document.getElementById('reviewRating').value, 10);
                    const comment = document.getElementById('reviewComment').value.trim();
                    const list = Store.get('reviews');
                    list.push({ id: nextId('reviews'), targetType, targetId, authorUserId: app.currentUser.id, rating, comment, createdAt: Date.now(), flags: [], visibility: 'public' });
                    Store.set('reviews', list);
                    app.router('reviews');
                }
            });
        });

        const SetUploadAPI = { remove: (id) => { const list = Store.get('setUploads').filter(s => s.id !== id); Store.set('setUploads', list); app.router('set-upload'); } };

        // === PDF FONT + TEXT ENGINE (Unicode/TR safe) ===
        // QA: PDF'de su test cumlesi dogru gorunmeli: Istanbul, Izmir, igusoc IGUSOC, Sirket, Calisma, Odeme, Ucret
        // NotoSans-Regular.ttf base64: node -e "const fs=require('fs'); console.log(fs.readFileSync('NotoSans-Regular.ttf').toString('base64'));"
        const PDF_FONTS = {
            "NotoSans-Regular.ttf": "PASTE_BASE64_TTF_HERE",
            "NotoSans-Bold.ttf": "PASTE_BASE64_TTF_BOLD_HERE"
        };
        const PdfEngine = {
            _fontsRegistered: false,
            _hasRealFont: function() {
                var r = PDF_FONTS["NotoSans-Regular.ttf"] || "";
                return r && r.indexOf("PASTE_BASE64") === -1;
            },
            registerFonts: function(doc) {
                if (this._fontsRegistered) return;
                if (!this._hasRealFont()) {
                    var msg = "PDF icin Unicode font eksik (NotoSans-Regular.ttf base64). CDN yuklemesi basarisiz veya base64 yapistirilmamis.";
                    console.error("[GigCore PDF]", msg);
                    console.error("[GigCore PDF] Elle cozum: NotoSans-Regular.ttf indir, sonra node -e \"const fs=require('fs'); console.log(fs.readFileSync('NotoSans-Regular.ttf').toString('base64'));\" ile base64 uret, PDF_FONTS['NotoSans-Regular.ttf'] icine yapistir.");
                    alert("PDF icin Unicode font eksik. Once agdan yukleniyor deneniyor; basarisiz olursa konsolu (F12) kontrol edin.\n\nElle cozum: NotoSans-Regular.ttf indirip base64 uretin ve PDF_FONTS icine yapistirin.");
                    throw new Error("Missing PDF font base64");
                }
                doc.addFileToVFS("NotoSans-Regular.ttf", PDF_FONTS["NotoSans-Regular.ttf"]);
                doc.addFont("NotoSans-Regular.ttf", "NotoSans", "normal");
                var bold = PDF_FONTS["NotoSans-Bold.ttf"] || "";
                if (bold && bold.indexOf("PASTE_BASE64") === -1) {
                    doc.addFileToVFS("NotoSans-Bold.ttf", bold);
                    doc.addFont("NotoSans-Bold.ttf", "NotoSans", "bold");
                }
                this._fontsRegistered = true;
            },
            sanitizeText: function(input) {
                if (input == null) return "-";
                var s = String(input);
                try { s = s.normalize("NFC"); } catch (e) {}
                s = s.replace(/\u00A0/g, " ").replace(/[\u200B-\u200D\uFEFF]/g, "");
                s = s.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, "");
                s = s.replace(/[–—]/g, "-").replace(/[""]/g, '"').replace(/['']/g, "'");
                s = s.split("\n").map(function(line) { return line.replace(/[ \t]+/g, " ").trim(); }).join("\n").trim();
                return s.length ? s : "-";
            },
            transliterateTrToAscii: function(input) {
                if (input == null) return "";
                var s = String(input);
                var tr = { '\u0130':'I', '\u0131':'i', '\u011E':'G', '\u011F':'g', '\u00DC':'U', '\u00FC':'u', '\u015E':'S', '\u015F':'s', '\u00D6':'O', '\u00F6':'o', '\u00C7':'C', '\u00E7':'c', '\u00C4':'A', '\u00E4':'a' };
                for (var k in tr) s = s.split(k).join(tr[k]);
                return s;
            },
            makeWriter: function(doc, opts) {
                var pageW = doc.internal.pageSize.getWidth();
                var pageH = doc.internal.pageSize.getHeight();
                var margin = opts && opts.margin != null ? opts.margin : 44;
                var maxW = pageW - margin * 2;
                var y = margin;
                var self = this;
                var ensure = function(need) { if (y + (need || 14) > pageH - margin) { doc.addPage(); y = margin; } };
                return {
                    paragraph: function(text, size, lineHeight) {
                        size = size || 10; lineHeight = lineHeight || 1.35;
                        doc.setFont("NotoSans", "normal");
                        doc.setFontSize(size);
                        var clean = self.sanitizeText(text);
                        var lines = doc.splitTextToSize(clean, maxW);
                        var step = Math.round(size * lineHeight);
                        for (var i = 0; i < lines.length; i++) {
                            ensure(step + 2);
                            doc.text(lines[i], margin, y);
                            y += step;
                        }
                        y += Math.round(size * 0.4);
                    },
                    getY: function() { return y; },
                    margin: margin,
                    maxW: maxW
                };
            },
            makeWriterFallback: function(doc, opts) {
                var pageW = doc.internal.pageSize.getWidth();
                var pageH = doc.internal.pageSize.getHeight();
                var margin = opts && opts.margin != null ? opts.margin : 44;
                var maxW = pageW - margin * 2;
                var y = margin;
                var self = this;
                var ensure = function(need) { if (y + (need || 14) > pageH - margin) { doc.addPage(); y = margin; } };
                return {
                    paragraph: function(text, size, lineHeight) {
                        size = size || 10; lineHeight = lineHeight || 1.35;
                        doc.setFontSize(size);
                        var clean = self.transliterateTrToAscii(self.sanitizeText(text));
                        var lines = doc.splitTextToSize(clean, maxW);
                        var step = Math.round(size * lineHeight);
                        for (var i = 0; i < lines.length; i++) {
                            ensure(step + 2);
                            doc.text(lines[i], margin, y);
                            y += step;
                        }
                        y += Math.round(size * 0.4);
                    },
                    getY: function() { return y; },
                    margin: margin,
                    maxW: maxW
                };
            }
        };

        const CONTRACT_TEMPLATE = 'GIGCORE — ETKİNLİK HİZMET ve İŞBİRLİĞİ SÖZLEŞMESİ (TASLAK)\nBelge Tarihi: {{CONTRACT_DATE}}\nEtkinlik: {{EVENT_TITLE}}\nŞehir: {{EVENT_CITY}} | Tarih: {{EVENT_DATE}} | Süre: {{EVENT_HOURS}} saat\n\n1) TARAFLAR\nTaraf A (İlan Sahibi): {{PARTY_OWNER_NAME}} ({{PARTY_OWNER_ROLE}}) — {{PARTY_OWNER_EMAIL}}\nTaraf B (Başvuran): {{PARTY_APPLICANT_NAME}} ({{PARTY_APPLICANT_ROLE}}) — {{PARTY_APPLICANT_EMAIL}}\n\n2) ETKİNLİK TANIMI ve KAPSAM\n2.1 Taraflar, yukarıdaki etkinlik kapsamında aşağıdaki hizmet/işbirliğini kabul eder:\n- DJ performansı (varsa)\n- Mekan sağlayıcılığı (varsa)\n- Organizasyon yönetimi (varsa)\n- Dekor/kurulum/teslim (varsa)\n\n3) ÜCRET, PAYLAŞIM ve EKONOMİK ŞARTLAR\n3.1 Teklif Ücreti (Taraflar arası ana bedel): {{OFFER_PRICE}} TL\n3.2 Etkinlik bütçesi (bilgilendirme): {{EVENT_BUDGET}} TL\n\n3.3 MEKAN BİLET KESİM / PAYLAŞIM ŞARTLARI (uygulanıyorsa)\n- Kesim modeli: {{VENUE_TICKET_CUT_MODE}}\n- Kesim yüzdesi: {{VENUE_TICKET_CUT_PERCENT}}\n- Bilet başı kesim (TL): {{VENUE_TICKET_CUT_AMOUNT}}\n- Bilet / fiyat politikası: {{VENUE_TICKET_PRICE_POLICY}}\n- Diğer yüzde politikaları: {{VENUE_PERCENTAGE_POLICIES}}\n\n3.4 ORGANİZATÖR ÜCRET MODELİ (uygulanıyorsa)\n- Ücret modeli: {{ORG_FEE_MODEL}}\n- Sabit ücret (TL): {{ORG_FEE_FLAT}}\n- Yüzde (%): {{ORG_FEE_PERCENT}}\n- Gereksinimler:\n{{ORG_REQUIREMENTS}}\n- Teslimatlar:\n{{ORG_DELIVERABLES}}\n\n3.5 DJ ŞARTLARI (uygulanıyorsa)\n- Baz ücret: {{DJ_RATE_BASE}} TL\n- Ek saat: {{DJ_RATE_EXTRA_HOUR}} TL | Yol: {{DJ_RATE_TRAVEL}} TL | After party: {{DJ_RATE_AFTERPARTY}} TL | Depozito: {{DJ_DEPOSIT}} TL\n- Tech rider (ilan): {{DJ_TECH_RIDER_OVERRIDE}}\n- Soundcheck: {{DJ_SOUNDCHECK_MIN}} dk\n- Demo linkleri:\n{{DJ_DEMO_LINKS}}\n- İptal politikası: {{DJ_CANCEL_POLICY}}\n- Kabul edilen bilet kesim: {{DJ_ACCEPTED_TICKET_MODELS}}\n\n3.6 DEKOR ŞARTLARI (uygulanıyorsa)\n- Kira: {{DECOR_PRICE}} TL | Kurulum: {{DECOR_SETUP_FEE}} TL | Depozito: {{DECOR_DEPOSIT}} TL | Teslimat: {{DECOR_DELIVERY_FEE}} TL | Teslimat dahil: {{DECOR_DELIVERY_INCLUDED}}\n- Görsel/linkler:\n{{DECOR_DRIVE_LINKS}}\n\n4) EKİPMAN ve SORUMLULUK\n- Mekan ekipman: {{VENUE_EQUIPMENT_PROVIDED}}\n- Hasar: Kusur oranına göre tazmin.\n\n5) ONAY\nTaraflar bu taslağı okuduğunu ve kabul ettiğini beyan eder. Deal Room kaydı: {{DEALROOM_ID}}\n— GigCore v2.0';
        const ContractAPI = {
            buildContext: (roomId) => {
                var room = (Store.get('dealRooms') || []).find(function(r){ return r.id === roomId; });
                if (!room) return null;
                var listing = Store.get('listings').find(function(l){ return l.id === room.listingId; });
                var users = Store.get('users') || [];
                var owner = users.find(function(u){ return u.id === room.listingOwnerUserId; });
                var applicant = users.find(function(u){ return u.id === room.applicantUserId; });
                var terms = room.acceptedTermsSnapshot || getEffectiveTerms(room, listing, owner, applicant);
                return { room: room, listing: listing || {}, owner: owner || {}, applicant: applicant || {}, venueProfile: (owner && owner.type === 'venue' ? getProfile(owner) : null) || (applicant && applicant.type === 'venue' ? getProfile(applicant) : null), organizerProfile: (owner && owner.type === 'organizer' ? getProfile(owner) : null) || (applicant && applicant.type === 'organizer' ? getProfile(applicant) : null), djProfile: (owner && owner.type === 'dj' ? getProfile(owner) : null) || (applicant && applicant.type === 'dj' ? getProfile(applicant) : null), decoratorProfile: (owner && owner.type === 'decorator' ? getProfile(owner) : null) || (applicant && applicant.type === 'decorator' ? getProfile(applicant) : null), terms: terms };
            },
            buildPlaceholderMap: (ctx) => {
                if (!ctx) return {};
                var o = ctx.owner; var a = ctx.applicant; var t = ctx.terms; var l = ctx.listing; var vp = ctx.venueProfile; var op = ctx.organizerProfile; var dp = ctx.djProfile;
                var roleLabel = function(type){ if (!type) return '-'; if (type === 'dj') return 'DJ'; if (type === 'venue') return 'Mekan'; if (type === 'organizer') return 'Organizatör'; if (type === 'decorator') return 'Dekorcu'; return type; };
                var r = t.rate || {};
                return { '{{CONTRACT_DATE}}': new Date().toLocaleDateString('tr-TR'), '{{EVENT_TITLE}}': t.eventTitle || l.title || '-', '{{EVENT_CITY}}': t.eventCity || l.city || '-', '{{EVENT_DATE}}': t.date || l.date || '-', '{{EVENT_HOURS}}': t.hours != null ? t.hours : (l.hours != null ? l.hours : '-'), '{{EVENT_BUDGET}}': t.eventBudget != null ? t.eventBudget : (l.budget != null ? l.budget : '-'), '{{OFFER_PRICE}}': t.price != null ? t.price : '-', '{{PARTY_OWNER_NAME}}': o.name || '-', '{{PARTY_OWNER_EMAIL}}': o.email || '-', '{{PARTY_OWNER_ROLE}}': roleLabel(o.type), '{{PARTY_APPLICANT_NAME}}': a.name || '-', '{{PARTY_APPLICANT_EMAIL}}': a.email || '-', '{{PARTY_APPLICANT_ROLE}}': roleLabel(a.type), '{{VENUE_TICKET_CUT_MODE}}': t.ticketCutMode || '-', '{{VENUE_TICKET_CUT_PERCENT}}': t.ticketCutPercent != null ? t.ticketCutPercent : '-', '{{VENUE_TICKET_CUT_AMOUNT}}': t.ticketCutAmount != null ? t.ticketCutAmount : '-', '{{VENUE_TICKET_PRICE_POLICY}}': t.ticketPricePolicy || '-', '{{VENUE_PERCENTAGE_POLICIES}}': t.percentagePolicies || '-', '{{VENUE_EQUIPMENT_PROVIDED}}': Array.isArray(t.venueEquipment) ? t.venueEquipment.join(', ') : (vp && vp.equipment ? vp.equipment.join(', ') : '-'), '{{ORG_FEE_MODEL}}': t.organizerFeeModel || '-', '{{ORG_FEE_FLAT}}': t.organizerFee != null ? t.organizerFee : '-', '{{ORG_FEE_PERCENT}}': t.organizerFeePercent != null ? t.organizerFeePercent : '-', '{{ORG_REQUIREMENTS}}': Array.isArray(t.requirements) ? t.requirements.join('\n') : (t.requirements || '-'), '{{ORG_DELIVERABLES}}': Array.isArray(t.deliverables) ? t.deliverables.join('\n') : (t.deliverables || '-'), '{{DJ_RATE_BASE}}': t.price != null ? t.price : (r.baseFee != null ? r.baseFee : '-'), '{{DJ_RATE_EXTRA_HOUR}}': r.extraHourFee != null ? r.extraHourFee : '-', '{{DJ_RATE_TRAVEL}}': r.travelFee != null ? r.travelFee : '-', '{{DJ_RATE_AFTERPARTY}}': r.afterPartyFee != null ? r.afterPartyFee : '-', '{{DJ_DEPOSIT}}': r.depositAmount != null ? r.depositAmount : '-', '{{DJ_TECH_RIDER_OVERRIDE}}': t.techRiderOverride || '-', '{{DJ_SOUNDCHECK_MIN}}': t.soundcheckMinutes != null ? t.soundcheckMinutes : '-', '{{DJ_DEMO_LINKS}}': Array.isArray(t.demoLinks) ? t.demoLinks.join('\n') : (t.demoLinks || '-'), '{{DJ_CANCEL_POLICY}}': t.cancelPolicy || '-', '{{DJ_ACCEPTED_TICKET_MODELS}}': Array.isArray(t.acceptedTicketModels) ? t.acceptedTicketModels.join(', ') : '-', '{{DECOR_PRICE}}': t.decorPrice != null ? t.decorPrice : '-', '{{DECOR_SETUP_FEE}}': t.decorSetupFee != null ? t.decorSetupFee : '-', '{{DECOR_DEPOSIT}}': t.decorDeposit != null ? t.decorDeposit : '-', '{{DECOR_DELIVERY_FEE}}': t.decorDeliveryFee != null ? t.decorDeliveryFee : '-', '{{DECOR_DELIVERY_INCLUDED}}': t.decorDeliveryIncluded ? 'Evet' : 'Hayır', '{{DECOR_DRIVE_LINKS}}': Array.isArray(t.decorDriveLinks) ? t.decorDriveLinks.join('\n') : '-', '{{DEALROOM_ID}}': ctx.room ? ctx.room.id : '-' };
            },
            renderTemplate: (template, placeholderMap) => {
                return template.replace(/\{\{([A-Z0-9_]+)\}\}/g, function(m, key) { var k = '{{' + key + '}}'; var v = placeholderMap[k]; return (v !== undefined && v !== null && v !== '') ? String(v) : '-'; });
            },
            buildDocxFromText: function(text) {
                function esc(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
                var paras = String(text).split(/\n/);
                var body = paras.map(function(p) { return '<w:p><w:r><w:t xml:space="preserve">' + esc(p) + '</w:t></w:r></w:p>'; }).join('');
                var docXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
                    '<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">' +
                    '<w:body>' + body +
                    '<w:sectPr><w:pgSz w:w="11906" w:h="16838"/><w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/></w:sectPr></w:body></w:document>';
                var contentTypes = '<?xml version="1.0" encoding="UTF-8"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">' +
                    '<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>' +
                    '<Default Extension="xml" ContentType="application/xml"/>' +
                    '<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>' +
                    '</Types>';
                var rels = '<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">' +
                    '<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>' +
                    '</Relationships>';
                var docRels = '<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">' +
                    '</Relationships>';
                var zip = new JSZip();
                zip.file('[Content_Types].xml', contentTypes);
                zip.folder('_rels').file('.rels', rels);
                zip.folder('word').file('document.xml', docXml);
                zip.folder('word/_rels').file('document.xml.rels', docRels);
                return zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            },
            downloadDraft: function() {
                if (!app.currentUser) { console.error('[GigCore] Kullanici giris yapmamis.'); return; }
                var listingId = app._routeParams && app._routeParams.listingId;
                var applicantUserId = app._routeParams && app._routeParams.applicantUserId;
                var room = (listingId != null && applicantUserId != null) ? DealRoomAPI.get(listingId, applicantUserId) : null;
                if (!room) { alert('Sözleşme indirmek için bir teklif odası açın (İlan → Başvur → Teklif Odası).'); return; }
                var ctx = ContractAPI.buildContext(room.id);
                if (!ctx) { console.error('[GigCore] buildContext null.'); return; }
                var map = ContractAPI.buildPlaceholderMap(ctx);
                var text = ContractAPI.renderTemplate(CONTRACT_TEMPLATE, map);
                if (room.status !== 'accepted') text = '(TASLAK)\n\n' + text;
                if (typeof JSZip === 'undefined') { alert('DOCX kütüphanesi (JSZip) yüklenemedi.'); return; }
                ContractAPI.buildDocxFromText(text).then(function(blob) {
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'gigcore_sozlesme_' + (room.status === 'accepted' ? 'onayli' : 'taslak') + '_' + (room.id || '') + '.docx';
                    a.click();
                    URL.revokeObjectURL(a.href);
                }).catch(function(e) { console.error('[GigCore DOCX]', e); alert('DOCX olusturilirken hata: ' + e.message); });
            }
        };

        const LogoUploadAPI = {
            handleFile: function(input) {
                if (!input || !input.files || !input.files.length || !app.currentUser) return;
                var file = input.files[0];
                if (file.size > 2 * 1024 * 1024) { alert('Dosya 2MB\'dan küçük olmalı.'); return; }
                var reader = new FileReader();
                reader.onload = function() {
                    var dataUrl = reader.result;
                    var list = Store.get('djProfiles');
                    var i = list.findIndex(function(p) { return p.userId === app.currentUser.id; });
                    if (i >= 0) { list[i].logoDataUrl = dataUrl; Store.set('djProfiles', list); }
                    var img = document.getElementById('uploadedLogoPreview');
                    var place = document.getElementById('uploadedLogoPreviewPlaceholder');
                    var removeBtn = document.getElementById('logoUploadRemoveBtn');
                    if (img) { img.src = dataUrl; img.classList.remove('hidden'); }
                    if (place) place.classList.add('hidden');
                    if (removeBtn) removeBtn.classList.remove('hidden');
                    input.value = '';
                };
                reader.readAsDataURL(file);
            },
            remove: function() {
                if (!app.currentUser) return;
                var list = Store.get('djProfiles');
                var i = list.findIndex(function(p) { return p.userId === app.currentUser.id; });
                if (i >= 0) { list[i].logoDataUrl = null; Store.set('djProfiles', list); }
                var img = document.getElementById('uploadedLogoPreview');
                var place = document.getElementById('uploadedLogoPreviewPlaceholder');
                var removeBtn = document.getElementById('logoUploadRemoveBtn');
                if (img) { img.src = ''; img.classList.add('hidden'); }
                if (place) place.classList.remove('hidden');
                if (removeBtn) removeBtn.classList.add('hidden');
            }
        };
        const ListingsAPI = {
            setFilterRole: (role) => { window._listingsFilter = window._listingsFilter || {}; window._listingsFilter.role = role || undefined; app.router('listings'); },
            setSort: (sortBy) => { window._listingsSort = sortBy || 'newest'; },
            applyFilters: () => {
                var prev = window._listingsFilter || {};
                var cityEl = document.getElementById('filterCity');
                var genreEl = document.getElementById('filterGenre');
                window._listingsFilter = {
                    role: prev.role,
                    city: (cityEl && cityEl.value.trim()) || '',
                    genre: (genreEl && genreEl.value.trim()) || '',
                    bpmMin: (document.getElementById('filterBpmMin') && document.getElementById('filterBpmMin').value) || '',
                    bpmMax: (document.getElementById('filterBpmMax') && document.getElementById('filterBpmMax').value) || '',
                    budgetMin: (document.getElementById('filterBudgetMin') && document.getElementById('filterBudgetMin').value) || '',
                    budgetMax: (document.getElementById('filterBudgetMax') && document.getElementById('filterBudgetMax').value) || '',
                    date: (document.getElementById('filterDate') && document.getElementById('filterDate').value) || ''
                };
                app.router('listings');
            }
        };
        const DealRoomAPI = {
            getOrCreate: async (listingId, applicantUserId) => {
                const lid = Number(listingId);
                const aid = String(applicantUserId);
                let room = Store.get('dealRooms').find(r => (r.listingId === lid || r.listingId == lid) && String(r.applicantUserId) === aid);
                if (room) return room;
                if (USE_SUPABASE && supabase) {
                    const listing = Store.get('listings').find(l => l.id === lid || l.id == lid);
                    const ownerId = listing ? listing.createdByUserId : null;
                    if (!ownerId) return null;
                    await supabase.from('applications').upsert({ listing_id: lid, applicant_id: aid, status: 'pending' }, { onConflict: 'listing_id,applicant_id' });
                    const { data: existing } = await supabase.from('deal_rooms').select('*').eq('listing_id', lid).eq('applicant_id', aid).single();
                    if (existing) { await SupabaseDataService.loadAll(); return Store.get('dealRooms').find(r => (r.listingId === lid || r.listingId == lid) && String(r.applicantUserId) === aid); }
                    const { data: ins } = await supabase.from('deal_rooms').insert({ listing_id: lid, applicant_id: aid, owner_id: ownerId, status: 'initiated', offer_terms: {} }).select('*').single();
                    await SupabaseDataService.loadAll();
                    return Store.get('dealRooms').find(r => r.id === (ins && ins.id));
                }
                const listing = Store.get('listings').find(l => l.id === lid);
                const listingOwnerUserId = listing ? listing.createdByUserId : null;
                room = { id: nextId('dealRooms'), listingId: lid, applicantUserId: aid, listingOwnerUserId, status: 'initiated', offerTerms: {}, evidenceLinks: [], createdAt: Date.now(), updatedAt: Date.now() };
                const rooms = Store.get('dealRooms'); rooms.push(room); Store.set('dealRooms', rooms);
                const appList = Store.get('applications'); appList.push({ id: nextId('applications'), listingId: lid, userId: aid, createdAt: Date.now(), status: 'pending' }); Store.set('applications', appList);
                return room;
            },
            get: (listingId, applicantUserId) => Store.get('dealRooms').find(r => (r.listingId === Number(listingId) || r.listingId == listingId) && String(r.applicantUserId) === String(applicantUserId)),
            sendMessage: async (roomId, text) => {
                if (!text || !app.currentUser) return;
                if (USE_SUPABASE && supabase) { await supabase.from('deal_room_messages').insert({ deal_room_id: roomId, user_id: app.currentUser.id, text: String(text).trim() }); const { data: dm } = await supabase.from('deal_room_messages').select('*'); setCache('dealRoomMessages', (dm || []).map(m => ({ id: m.id, dealRoomId: m.deal_room_id, userId: m.user_id, text: m.text, createdAt: m.created_at ? new Date(m.created_at).getTime() : 0 }))); return; }
                const list = Store.get('dealRoomMessages');
                list.push({ id: nextId('dealRoomMessages'), dealRoomId: roomId, userId: app.currentUser.id, text: String(text).trim(), createdAt: Date.now() });
                Store.set('dealRoomMessages', list);
            },
            updateOffer: async (roomId, terms) => {
                if (USE_SUPABASE && supabase) { await supabase.from('deal_rooms').update({ offer_terms: terms, status: 'negotiating', updated_at: new Date().toISOString() }).eq('id', roomId); await SupabaseDataService.loadAll(); return; }
                const rooms = Store.get('dealRooms');
                const i = rooms.findIndex(r => r.id === roomId);
                if (i < 0) return;
                rooms[i].offerTerms = { ...(rooms[i].offerTerms || {}), ...terms };
                rooms[i].status = rooms[i].status === 'initiated' ? 'negotiating' : rooms[i].status;
                rooms[i].updatedAt = Date.now();
                Store.set('dealRooms', rooms);
            },
            updateStatus: async (roomId, status) => {
                if (USE_SUPABASE && supabase) {
                    const rooms = Store.get('dealRooms');
                    const room = rooms.find(r => r.id === roomId);
                    let snapshot = null;
                    if (status === 'accepted' && room) { const listing = Store.get('listings').find(l => l.id === room.listingId); const owner = Store.get('users').find(u => String(u.id) === String(room.listingOwnerUserId)); const applicant = Store.get('users').find(u => String(u.id) === String(room.applicantUserId)); snapshot = getEffectiveTerms(room, listing, owner, applicant); }
                    await supabase.from('deal_rooms').update({ status, accepted_terms_snapshot: snapshot, updated_at: new Date().toISOString() }).eq('id', roomId);
                    await SupabaseDataService.loadAll();
                    return;
                }
                const rooms = Store.get('dealRooms');
                const i = rooms.findIndex(r => r.id === roomId);
                if (i < 0) return;
                rooms[i].status = status;
                rooms[i].updatedAt = Date.now();
                if (status === 'accepted') {
                    var room = rooms[i];
                    var listing = Store.get('listings').find(function(l){ return l.id === room.listingId; });
                    var users = Store.get('users');
                    var owner = users.find(function(u){ return u.id === room.listingOwnerUserId; });
                    var applicant = users.find(function(u){ return u.id === room.applicantUserId; });
                    rooms[i].acceptedTermsSnapshot = getEffectiveTerms(room, listing, owner, applicant);
                }
                Store.set('dealRooms', rooms);
            },
            getMessages: (roomId) => Store.get('dealRoomMessages').filter(m => m.dealRoomId === roomId).sort((a,b) => a.createdAt - b.createdAt)
        };
        function collectOfferTermsFromForm() {
            var g = function(id) { var el = document.getElementById(id); return el ? el.value : ''; };
            var gn = function(id) { var v = g(id); return v === '' ? null : parseFloat(v); };
            var req = g('offerRequirements'); var reqArr = req ? req.trim().split(/\n/).map(function(s){ return s.trim(); }).filter(Boolean) : [];
            var del = g('offerDeliverables'); var delArr = del ? del.trim().split(/\n/).map(function(s){ return s.trim(); }).filter(Boolean) : [];
            var demo = g('offerDemoLinks'); var demoArr = demo ? demo.trim().split(/\n/).map(function(s){ return s.trim(); }).filter(Boolean) : [];
            var terms = { price: gn('offerPrice'), date: g('offerDate') || null, hours: gn('offerHours'), eventTitle: g('offerEventTitle') || null, eventCity: g('offerEventCity') || null, eventBudget: gn('offerEventBudget'), ticketCutMode: g('offerTicketCutMode') || null, ticketCutPercent: gn('offerTicketCutPct'), ticketCutAmount: gn('offerTicketCutAmt'), percentagePolicies: g('offerPctPolicies') || null, ticketPricePolicy: g('offerTicketPolicy') || null, organizerFeeModel: g('offerOrgModel') || null, organizerFee: gn('offerOrgFee'), organizerFeePercent: gn('offerOrgPct'), requirements: reqArr.length ? reqArr : null, deliverables: delArr.length ? delArr : null, techRiderOverride: g('offerTechRider') || null, soundcheckMinutes: gn('offerSoundcheck'), demoLinks: demoArr.length ? demoArr : null, cancelPolicy: g('offerCancelPolicy') || null, decorPrice: gn('offerDecorPrice'), decorSetupFee: gn('offerDecorSetup'), decorDeposit: gn('offerDecorDeposit'), decorDeliveryFee: gn('offerDecorDeliveryFee'), decorDeliveryIncluded: document.getElementById('offerDecorDeliveryIncluded') ? document.getElementById('offerDecorDeliveryIncluded').checked : false };
            var rate = { baseFee: gn('offerRateBase'), extraHourFee: gn('offerRateExtraHour'), travelFee: gn('offerRateTravel'), afterPartyFee: gn('offerRateAfterParty'), depositAmount: gn('offerDeposit') };
            terms.rate = rate;
            return terms;
        }
        const LedgerAPI = {
            add: async (dealRoomId, amount, payerUserId, payeeUserId, status) => {
                if (USE_SUPABASE && supabase) { await supabase.from('ledger').insert({ deal_room_id: dealRoomId, amount, currency: 'TRY', payer_user_id: payerUserId, payee_user_id: payeeUserId, status: status || 'held', release_condition: 'event_completed' }); const { data } = await supabase.from('ledger').select('*'); setCache('ledger', (data || []).map(e => ({ id: e.id, dealRoomId: e.deal_room_id, amount: e.amount, payerUserId: e.payer_user_id, payeeUserId: e.payee_user_id, status: e.status, createdAt: e.created_at ? new Date(e.created_at).getTime() : 0 }))); return; }
                const list = Store.get('ledger');
                list.push({ id: nextId('ledger'), dealRoomId, amount, currency: 'TRY', payerUserId, payeeUserId, status: status || 'held', releaseCondition: 'event_completed', createdAt: Date.now() });
                Store.set('ledger', list);
            },
            getByRoom: (dealRoomId) => Store.get('ledger').filter(e => e.dealRoomId === dealRoomId)
        };
        const ApplicationsAPI = {
            apply: async (listingId) => {
                if (!app.currentUser) { alert('Başvuru için giriş yapın.'); return; }
                const applicantUserId = app.currentUser.id;
                await DealRoomAPI.getOrCreate(listingId, applicantUserId);
                app.router('deal-room', { listingId: Number(listingId), applicantUserId });
            }
        };
        /* Mesajlaşma: sadece uygulama içi DM. threads + messages + blocklist. Supabase: message_threads, thread_participants, messages. */
        const Messaging = {
            getOrCreateThread: async (userIdA, userIdB, context) => {
                const a = String(userIdA), b = String(userIdB);
                const sortPair = [a, b].sort();
                if (USE_SUPABASE && supabase) {
                    const { data: existing } = await supabase.from('thread_participants').select('thread_id').eq('user_id', a);
                    const idsA = (existing || []).map(x => x.thread_id);
                    if (idsA.length) {
                        const { data: match } = await supabase.from('thread_participants').select('thread_id').eq('user_id', b).in('thread_id', idsA);
                        if (match && match.length) { await SupabaseDataService.loadMessages(); return match[0].thread_id; }
                    }
                    const { data: ins, error } = await supabase.from('message_threads').insert({ context: context || {} }).select('id').single();
                    if (error) { console.error(error); return null; }
                    const tid = ins.id;
                    await supabase.from('thread_participants').insert([{ thread_id: tid, user_id: a }, { thread_id: tid, user_id: b }]);
                    await SupabaseDataService.loadMessages();
                    return tid;
                }
                var threads = Store.get('messageThreads') || [];
                var t = threads.find(function(x) { var p = x.participantIds || []; return p.length === 2 && ((p[0] === a && p[1] === b) || (p[0] === b && p[1] === a)); });
                if (t) return t.id;
                var id = nextId('messageThreads');
                threads.push({ id: id, participantIds: sortPair, createdAt: Date.now(), lastMessageAt: 0, lastMessageText: '', context: context || {}, unreadBy: {} });
                Store.set('messageThreads', threads);
                return id;
            },
            _lastMessageSentAt: 0,
            sendMessage: async (threadId, senderId, text) => {
                text = (text || '').trim();
                if (!text || !app.currentUser || app.currentUser.id !== senderId) return false;
                if (USE_SUPABASE && supabase) {
                    if (Date.now() - (Messaging._lastMessageSentAt || 0) < 1000) { if (typeof showToast === 'function') showToast('Lütfen 1 saniye bekleyin.'); return false; }
                    var thread = (Store.get('messageThreads') || []).find(function(x) { return x.id === threadId || String(x.id) === String(threadId); });
                    if (!thread) return false;
                    var otherId = (thread.participantIds || [])[0] === String(senderId) ? (thread.participantIds || [])[1] : (thread.participantIds || [])[0];
                    Messaging._lastMessageSentAt = Date.now();
                    const { error: insErr } = await supabase.from('messages').insert({ thread_id: threadId, sender_id: senderId, text });
                    if (insErr) { console.error(insErr); return false; }
                    await supabase.from('message_threads').update({ last_message_at: new Date().toISOString(), last_message_text: text.length > 60 ? text.slice(0, 60) + '…' : text }).eq('id', threadId);
                    const { data: tp } = await supabase.from('thread_participants').select('unread_count').eq('thread_id', threadId).eq('user_id', otherId).single();
                    await supabase.from('thread_participants').update({ unread_count: (tp && tp.unread_count || 0) + 1 }).eq('thread_id', threadId).eq('user_id', otherId);
                    await SupabaseDataService.loadMessages();
                    return true;
                }
                var blocklist = Store.get('messagingBlocklist') || [];
                var thread = (Store.get('messageThreads') || []).find(function(x) { return x.id === threadId; });
                if (!thread) return false;
                var otherId = thread.participantIds[0] === senderId ? thread.participantIds[1] : thread.participantIds[0];
                if (blocklist.some(function(b) { return (b.blockerId === otherId && b.blockedId === senderId); })) return false;
                var messages = Store.get('messages') || [];
                messages.push({ id: nextId('messages'), threadId: threadId, senderId: senderId, text: text, createdAt: Date.now(), readBy: [] });
                Store.set('messages', messages);
                var threads = Store.get('messageThreads') || [];
                var i = threads.findIndex(function(x) { return x.id === threadId; });
                if (i >= 0) {
                    threads[i].lastMessageAt = Date.now();
                    threads[i].lastMessageText = text.length > 60 ? text.slice(0, 60) + '…' : text;
                    var unread = threads[i].unreadBy || {};
                    unread[otherId] = (unread[otherId] || 0) + 1;
                    threads[i].unreadBy = unread;
                    Store.set('messageThreads', threads);
                }
                return true;
            },
            getThreadsForUser: (userId) => {
                const uid = String(userId);
                var threads = (Store.get('messageThreads') || []).filter(function(t) { var p = t.participantIds || []; return p.some(function(x) { return String(x) === uid; }); });
                return threads.sort(function(a, b) { return (b.lastMessageAt || b.createdAt || 0) - (a.lastMessageAt || a.createdAt || 0); });
            },
            getMessages: (threadId) => {
                const tid = String(threadId);
                return (Store.get('messages') || []).filter(function(m) { return String(m.threadId) === tid; }).sort(function(a, b) { return a.createdAt - b.createdAt; });
            },
            markThreadRead: async (threadId, userId) => {
                if (USE_SUPABASE && supabase) { await supabase.from('thread_participants').update({ unread_count: 0 }).eq('thread_id', threadId).eq('user_id', userId); await SupabaseDataService.loadMessages(); return; }
                var threads = Store.get('messageThreads') || [];
                var i = threads.findIndex(function(x) { return x.id === threadId || String(x.id) === String(threadId); });
                if (i >= 0 && threads[i].unreadBy) { threads[i].unreadBy[userId] = 0; Store.set('messageThreads', threads); }
            },
            getUnreadTotal: (userId) => {
                const uid = String(userId);
                var threads = Store.get('messageThreads') || [];
                var n = 0;
                threads.forEach(function(t) { if ((t.participantIds || []).some(function(x) { return String(x) === uid; })) n += (t.unreadBy && t.unreadBy[uid]) ? t.unreadBy[uid] : 0; });
                return n;
            },
            blockUser: (blockerId, blockedId) => {
                var list = Store.get('messagingBlocklist') || [];
                if (!list.some(function(b) { return b.blockerId === blockerId && b.blockedId === blockedId; })) { list.push({ blockerId: blockerId, blockedId: blockedId, createdAt: Date.now() }); Store.set('messagingBlocklist', list); }
            },
            reportThread: (threadId, reason) => {
                var reports = Store.get('messageThreadReports') || [];
                reports.push({ threadId: threadId, reason: reason || 'spam', createdAt: Date.now() });
                Store.set('messageThreadReports', reports);
            },
            openThreadWith: async (targetUserId, context) => {
                if (!app.currentUser) return;
                var tid = await Messaging.getOrCreateThread(app.currentUser.id, targetUserId, context || {});
                Messaging._lastThreadId = tid;
                return tid;
            }
        };
        function showToast(message) {
            var el = document.getElementById('appToast');
            if (!el) return;
            el.textContent = message || 'Kaydedildi';
            el.classList.remove('hidden');
            setTimeout(function() { el.classList.add('hidden'); }, 2500);
        }
        const ProfileEditUI = {
            previewAvatar: (input) => {
                if (!input || !input.files || !input.files[0]) return;
                var file = input.files[0];
                var allowed = ['image/jpeg','image/png','image/webp'];
                if (allowed.indexOf(file.type) === -1) { showToast('Sadece JPG, PNG veya WebP'); return; }
                if (file.size > 5 * 1024 * 1024) { showToast('Dosya 5MB\'dan küçük olmalı'); return; }
                var url = URL.createObjectURL(file);
                var preview = document.getElementById('profileEditAvatarPreview');
                if (preview) { preview.innerHTML = '<img src="' + url.replace(/"/g, '&quot;') + '" alt="" class="profile-avatar-img">'; }
                var card = document.getElementById('profileEditAvatarCard');
                if (card) { card.innerHTML = '<img src="' + url.replace(/"/g, '&quot;') + '" alt="" class="w-full h-full object-cover">'; }
                var btn = document.getElementById('profileAvatarUploadBtn');
                if (btn) btn.disabled = false;
            },
            showTab: (tabName) => {
                window._profileEditTab = tabName;
                var tabs = document.querySelectorAll('.profile-edit-tab');
                tabs.forEach(function(el) { el.classList.add('hidden'); });
                var show = document.getElementById('profileTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
                if (show) show.classList.remove('hidden');
                var buttons = document.querySelectorAll('[onclick*="ProfileEditUI.showTab"]');
                buttons.forEach(function(btn) {
                    var m = btn.getAttribute('onclick').match(/showTab\s*\(\s*[\'"]([a-z]+)[\'"]\s*\)/);
                    var t = m ? m[1] : '';
                    btn.className = btn.className.replace(/bg-brand-accent|bg-gray-800/g, '') + (t === tabName ? ' bg-brand-accent text-white' : ' bg-gray-800 text-gray-300');
                });
            },
            cancelLeave: () => {
                var modal = document.getElementById('profileUnsavedModal');
                if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
                app._pendingRoute = null;
            },
            confirmLeave: () => {
                var modal = document.getElementById('profileUnsavedModal');
                if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
                window._profileEditDirty = false;
                var p = app._pendingRoute;
                app._pendingRoute = null;
                if (p) app.router(p.view, p.params, true);
            }
        };
        const ProfileAPI = {
            saveBasic: (form) => {
                if (!app.currentUser) return;
                var list = Store.get('commonProfiles') || [];
                var i = list.findIndex(p => p.userId === app.currentUser.id);
                var displayName = (form.displayName && form.displayName.value || '').trim();
                if (!displayName) { alert('Görünen ad zorunludur.'); return; }
                if (i >= 0) { list[i].displayName = displayName; list[i].bio = (form.bio && form.bio.value || '').trim(); list[i].lastUpdated = Date.now(); } else { list.push({ userId: app.currentUser.id, displayName: displayName, bio: (form.bio && form.bio.value || '').trim(), avatarDataUrl: null, coverDataUrl: null, languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: true, preferredContactMethod: 'in_app', lastUpdated: Date.now() }); }
                Store.set('commonProfiles', list);
                window._profileEditDirty = false;
                showToast('Kaydedildi');
                app.router('profile-edit');
            },
            savePrivacy: (form) => {
                if (!app.currentUser) return;
                var list = Store.get('commonProfiles') || [];
                var i = list.findIndex(p => p.userId === app.currentUser.id);
                var allowDirectBooking = form && form.allowDirectBooking ? !(!form.allowDirectBooking.checked) : true;
                if (i >= 0) { list[i].showEmail = false; list[i].showPhone = false; list[i].allowDirectBooking = allowDirectBooking; list[i].preferredContactMethod = 'in_app'; list[i].lastUpdated = Date.now(); } else { list.push({ userId: app.currentUser.id, displayName: (app.currentUser.name || '').trim(), bio: '', avatarDataUrl: null, coverDataUrl: null, languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: allowDirectBooking, preferredContactMethod: 'in_app', lastUpdated: Date.now() }); }
                Store.set('commonProfiles', list);
                window._profileEditDirty = false;
                showToast('Kaydedildi');
                app.router('profile-edit');
            },
            savePrivacySimple: (allowEl) => {
                if (!app.currentUser) return;
                var list = Store.get('commonProfiles') || [];
                var i = list.findIndex(p => p.userId === app.currentUser.id);
                var allowDirectBooking = allowEl ? allowEl.checked : true;
                if (i >= 0) { list[i].allowDirectBooking = allowDirectBooking; list[i].lastUpdated = Date.now(); } else { list.push({ userId: app.currentUser.id, displayName: (app.currentUser.name || '').trim(), bio: '', avatarDataUrl: null, coverDataUrl: null, languages: [], tags: [], workingCities: [], showEmail: false, showPhone: false, allowDirectBooking: allowDirectBooking, preferredContactMethod: 'in_app', lastUpdated: Date.now() }); }
                Store.set('commonProfiles', list);
                window._profileEditDirty = false;
                showToast('Kaydedildi');
                app.router('profile-edit');
            },
            uploadAvatar: () => {
                var input = document.getElementById('profileAvatarInput') || document.getElementById('profileAvatarInputMedia');
                if (!input || !input.files || !input.files[0] || !app.currentUser) return;
                UploadEngine.processFile(input.files[0], { avatar: true, maxSize: 512 }, function(err, dataUrl) {
                    if (err) { alert(err.message || 'Yükleme hatası'); return; }
                    UploadEngine.saveAvatar(app.currentUser.id, dataUrl);
                    var key = app.currentUser.type === 'dj' ? 'djProfiles' : app.currentUser.type === 'venue' ? 'venueProfiles' : app.currentUser.type === 'organizer' ? 'organizerProfiles' : 'decoratorProfiles';
                    var roleList = Store.get(key) || [];
                    var ri = roleList.findIndex(p => p.userId === app.currentUser.id);
                    if (ri >= 0) { roleList[ri].profilePhotoDataUrl = dataUrl; Store.set(key, roleList); }
                    var preview = document.getElementById('profileEditAvatarPreview');
                    if (preview) { preview.innerHTML = '<img src="' + dataUrl.replace(/"/g, '&quot;') + '" alt="" class="profile-avatar-img">'; }
                    var card = document.getElementById('profileEditAvatarCard');
                    if (card) { card.innerHTML = '<img src="' + dataUrl.replace(/"/g, '&quot;') + '" alt="" class="w-full h-full object-cover">'; }
                    showToast('Kaydedildi');
                    app.router('profile-edit');
                });
            },
            uploadCover: () => {
                var input = document.getElementById('profileCoverInput');
                if (!input || !input.files || !input.files[0] || !app.currentUser) return;
                UploadEngine.processFile(input.files[0], { maxWidth: 1600 }, function(err, dataUrl) {
                    if (err) { alert(err.message || 'Yükleme hatası'); return; }
                    UploadEngine.saveCover(app.currentUser.id, dataUrl);
                    app.router('profile-edit');
                });
            }
        };
        const SettingsAPI = {
            exportData: () => { const data = { users: Store.get('users'), listings: Store.get('listings'), reviews: Store.get('reviews'), setUploads: Store.get('setUploads'), connections: Store.get('connections'), reports: Store.get('reports'), djProfiles: Store.get('djProfiles'), venueProfiles: Store.get('venueProfiles'), organizerProfiles: Store.get('organizerProfiles'), decoratorProfiles: Store.get('decoratorProfiles'), commonProfiles: Store.get('commonProfiles'), dealRooms: Store.get('dealRooms'), dealRoomMessages: Store.get('dealRoomMessages'), ledger: Store.get('ledger'), applications: Store.get('applications'), messageThreads: Store.get('messageThreads'), messages: Store.get('messages'), messagingBlocklist: Store.get('messagingBlocklist'), messageThreadReports: Store.get('messageThreadReports') }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gigcore_export.json'; a.click(); URL.revokeObjectURL(a.href); },
            deleteAccount: () => { Store.logout(); localStorage.clear(); window.location.reload(); },
            saveDriveLink: (url) => {
                if (!app.currentUser || app.currentUser.type !== 'dj') return;
                const list = Store.get('djProfiles');
                const i = list.findIndex(p => p.userId === app.currentUser.id);
                if (i >= 0) { list[i].googleDriveLink = url || null; Store.set('djProfiles', list); }
            },
            saveDjExtra: () => {
                if (!app.currentUser || app.currentUser.type !== 'dj') return;
                const list = Store.get('djProfiles');
                const i = list.findIndex(p => p.userId === app.currentUser.id);
                if (i < 0) return;
                var el = document.getElementById('settingsTechRider'); list[i].techRider = el ? el.value.trim() : '';
                el = document.getElementById('settingsSoundcloud'); list[i].soundcloudEmbed = el ? el.value.trim() : '';
                el = document.getElementById('settingsSpotify'); list[i].spotifyEmbed = el ? el.value.trim() : '';
                Store.set('djProfiles', list);
            },
            saveVenueExtra: () => {
                if (!app.currentUser || app.currentUser.type !== 'venue') return;
                const list = Store.get('venueProfiles');
                const i = list.findIndex(p => p.userId === app.currentUser.id);
                if (i < 0) return;
                var el = document.getElementById('settingsVenueEquipment'); list[i].equipment = el && el.value ? el.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean) : [];
                el = document.getElementById('settingsTicketCutPct'); list[i].ticketCutPercent = el && el.value ? parseFloat(el.value) : null;
                el = document.getElementById('settingsTicketPolicy'); list[i].ticketPricePolicy = el ? el.value.trim() : '';
                Store.set('venueProfiles', list);
            },
            saveOrganizerExtra: () => {
                if (!app.currentUser || app.currentUser.type !== 'organizer') return;
                const list = Store.get('organizerProfiles');
                const i = list.findIndex(p => p.userId === app.currentUser.id);
                if (i < 0) return;
                var el = document.getElementById('settingsOrgFee'); list[i].organizationFee = el && el.value ? parseFloat(el.value) : null;
                el = document.getElementById('settingsOrgFeePct'); list[i].organizationFeePercent = el && el.value ? parseFloat(el.value) : null;
                el = document.getElementById('settingsOrgRequirements'); list[i].requirements = el && el.value ? el.value.trim().split(/\n/).map(s => s.trim()).filter(Boolean) : [];
                el = document.getElementById('settingsOrgPhone'); list[i].contactPhone = el ? el.value.trim() : '';
                Store.set('organizerProfiles', list);
            },
            saveSocialLinks: () => {
                const u = app.currentUser;
                if (!u) return;
                const getEl = (id) => { var el = document.getElementById(id); return el ? el.value.trim() : ''; };
                const social = { instagram: getEl('settingsInstagram'), tiktok: getEl('settingsTiktok'), x: getEl('settingsX'), facebook: getEl('settingsFacebook'), whatsapp: getEl('settingsWhatsapp'), telegram: getEl('settingsTelegram'), soundcloud: getEl('settingsSocialSoundcloud'), bandcamp: getEl('settingsSocialBandcamp') };
                const key = u.type === 'dj' ? 'djProfiles' : u.type === 'venue' ? 'venueProfiles' : u.type === 'organizer' ? 'organizerProfiles' : 'decoratorProfiles';
                const list = Store.get(key);
                const i = list.findIndex(p => p.userId === u.id);
                if (i < 0) return;
                list[i].instagram = social.instagram || '';
                list[i].tiktok = social.tiktok || '';
                list[i].x = social.x || '';
                list[i].facebook = social.facebook || '';
                list[i].whatsapp = social.whatsapp || '';
                list[i].telegram = social.telegram || '';
                list[i].soundcloud = social.soundcloud || '';
                list[i].bandcamp = social.bandcamp || '';
                Store.set(key, list);
            }
        };

        // --- RLS SELF TEST (Supabase yetki kontrolü, Ayarlar sayfasından çalıştırılır) ---
        const RLSAPI = {
            runSelfTest: async () => {
                if (!supabase || !USE_SUPABASE) return [{ name: 'Supabase kapalı', ok: false, error: 'USE_SUPABASE false veya supabase null' }];
                const results = [];
                try {
                    const { error: e1 } = await supabase.from('listings').select('id').limit(1);
                    results.push({ name: 'listings select (kendi verim)', ok: !e1, error: e1 ? e1.message : null });
                } catch (e) { results.push({ name: 'listings select', ok: false, error: (e && e.message) || String(e) }); }
                try {
                    const { error: e2 } = await supabase.from('messages').select('id').limit(1);
                    results.push({ name: 'messages select (erişebildiğim)', ok: !e2, error: e2 ? e2.message : null });
                } catch (e) { results.push({ name: 'messages select', ok: false, error: (e && e.message) || String(e) }); }
                try {
                    const { error: e3 } = await supabase.from('applications').select('id').limit(1);
                    results.push({ name: 'applications select', ok: !e3, error: e3 ? e3.message : null });
                } catch (e) { results.push({ name: 'applications select', ok: false, error: (e && e.message) || String(e) }); }
                try {
                    const UNAUTH_THREAD_ID = 999999999;
                    const { data: msgData, error: e4 } = await supabase.from('messages').select('id').eq('thread_id', UNAUTH_THREAD_ID).limit(1);
                    const unauthorizedOk = e4 !== null || (msgData && msgData.length === 0);
                    results.push({ name: 'RLS: yetkisiz thread mesajı (reddedilmeli)', ok: unauthorizedOk, error: unauthorizedOk ? (e4 ? e4.message : '0 row (expected)') : (msgData && msgData.length ? 'Yetkisiz veri döndü' : null) });
                } catch (e) { results.push({ name: 'RLS yetkisiz messages', ok: false, error: (e && e.message) || String(e) }); }
                try {
                    const UNAUTH_ROOM_ID = 999999999;
                    const { data: drmData, error: e5 } = await supabase.from('deal_room_messages').select('id').eq('deal_room_id', UNAUTH_ROOM_ID).limit(1);
                    const unauthorizedRoomOk = e5 !== null || (drmData && drmData.length === 0);
                    results.push({ name: 'RLS: yetkisiz deal_room (reddedilmeli)', ok: unauthorizedRoomOk, error: unauthorizedRoomOk ? (e5 ? e5.message : '0 row (expected)') : (drmData && drmData.length ? 'Yetkisiz veri döndü' : null) });
                } catch (e) { results.push({ name: 'RLS yetkisiz deal_room', ok: false, error: (e && e.message) || String(e) }); }
                return results;
            },
            runSelfTestUI: async () => {
                var el = document.getElementById('rlsTestResult');
                if (el) el.innerHTML = 'Çalışıyor...';
                var r = await RLSAPI.runSelfTest();
                if (el) el.innerHTML = '<ul class="text-xs mt-2 space-y-1">' + r.map(function(x) { return '<li class="' + (x.ok ? 'text-green-400' : 'text-red-400') + '">' + escapeHtml(x.name) + ': ' + (x.ok ? 'OK' : (x.error || 'fail')) + '</li>'; }).join('') + '</ul>';
            }
        };

        // INIT
        /*
        [CHANGELOG — Schema 8 & Sözleşme/OfferTerms v2]
        - OfferTerms v2: Teklif şartları artık ortak (price/date/hours/eventTitle/eventCity/eventBudget), mekan (ticketCutMode, percent, amount, policies), organizatör (model, fee, percent, requirements, deliverables), DJ (rate kırılımı, techRider, soundcheck, demoLinks, cancelPolicy), dekor (price, setup, deposit, delivery) alanlarını taşır.
        - getEffectiveTerms(room, listing, owner, applicant): Tek kaynak; offerTerms + listing + profil fallback. computeDealEconomics(listing, owner, applicant, terms): Tek deal özeti hesabı.
        - Deal Room Teklif sekmesi: Genişletilmiş form; tüm alanlar ilan/profil ile ön doldurulur; "Teklifi kaydet" ile updateOffer v2; "Kabul et" ile status=accepted ve acceptedTermsSnapshot alınır.
        - ContractAPI: buildContext(roomId), buildPlaceholderMap(ctx), renderTemplate(template, map); CONTRACT_TEMPLATE (GIGCORE — ETKİNLİK HİZMET ve İŞBİRLİĞİ SÖZLEŞMESİ); downloadDraft() teklif odasından tüm placeholder’ları doldurarak DOCX üretir (JSZip); status !== 'accepted' ise metin başına (TASLAK) eklenir.
        - Schema 8: ROLE enum (dj|venue|organizer|decorator), normalizeRole(); ownerRole şema yorumu güncellendi.
        - Mekan ilan: listingTicketCutMode (percent|amount|mixed), listingTicketCutAmt, listingPctPolicies; kart ve Deal Room ekonomisinde kullanılıyor.
        - Organizatör ilan: listingOrgFeePercent, organizerFeeModel (flat|percent|hybrid), deliverables; kart ve Deal Room’da gösterim.
        - DJ ilan: rate (baseFee, extraHourFee, travelFee, afterPartyFee, depositAmount), techRiderOverride, soundcheckMinutes, demoLinks, cancelPolicy, acceptedTicketModels; kart ve Deal özetinde rate özeti.
        - Deal Room ekonomisi: venueShare = mode (percent/amount/mixed) ile; orgFee = model (flat/percent/hybrid) ile; djFee = listing.rate.baseFee veya teklif fiyatı.
        - Dekorcu: Drive görsel gereksinimleri (yardım metni); galeri fallback (yüklenemeyen görselde "Drive'da aç"); geçersiz link için "Geçersiz link" + Drive'da aç.
        - exportData: venueProfiles, organizerProfiles, decoratorProfiles, dealRooms, dealRoomMessages, ledger, applications eklendi.
        */
        /*
        [Avatar Rule v1 — Profil görsel önceliği]
        - resolveDisplayImageForUser(user) -> { url, kind: 'logo'|'photo'|null }. Kural: logo (role.logoDataUrl) > profil foto (role.profilePhotoDataUrl || common.avatarDataUrl) > initial.
        - İlan kartı sol avatar ve DJ büyük slot: displayImageUrl (logo öncelikli); yoksa harf avatarı.
        - Profil düzenle: dirty state (navbar tıklanınca onay modalı), tüm sekmeler tek DOM’da showTab ile geçiş, dosya seçince önizleme, Yükle/Kaydet toast.
        [QA CHECKLIST — İlanlar & Schema 8]
        - Mekan ilan: Kesim tipi (yüzde/bilet başı TL/hibrit), bilet kesim %, bilet başı TL, yüzde politikaları alanları formda ve kartta görünüyor mu?
        - Organizatör ilan: Ücret modeli, TL/%, gereksinimler, teslim edilecekler kartta ve Deal Room’da doğru mu?
        - DJ ilan: Fiyat kırılımı (gece + ek saat + yol + after party + depozito), tech rider override, soundcheck, demo linkleri, iptal politikası kartta görünüyor mu?
        - Deal Room özeti: Mekan payı (percent/amount/mixed), organizatör (flat/percent/hybrid), DJ ücreti (listing.rate.baseFee) doğru hesaplanıyor mu?
        - Dekor ilan: Drive linkleri yardım metni görünüyor mu? Görsel yüklenmezse "Drive'da aç" fallback çıkıyor mu? Geçersiz link "Geçersiz link" olarak işaretleniyor mu?
        - Filtre: Dekorcu dahil; sıralama dekor için fiyat (priceAsc/priceDesc) çalışıyor mu?
        - Export: gigcore_export.json içinde dealRooms, dealRoomMessages, ledger, applications, decoratorProfiles, venueProfiles, organizerProfiles var mı?
        - Mobil: Form alanları ve kart meta okunabilir mi?
        */
    </script>
</body>
</html>